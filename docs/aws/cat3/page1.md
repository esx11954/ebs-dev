# EC2

---

## はじめに

このページでは以下の項目について解説します。

- Amazon EC2 とは何か
- EC2 インスタンスの構成要素
- 様々なストレージオプションの違い
- EC2 を取り巻くネットワーク環境の基礎

---

## Amazon EC2 とは

Amazon EC2 (Elastic Compute Cloud) は、AWS が提供する主要なサービスの一つで、「エラスティックな (伸縮自在な) クラウドコンピューティング」を意味します。  
具体的には、数分で起動できる仮想サーバー (インスタンス) を提供し、必要なコンピューティング能力を必要な時にだけ利用できるサービスです。

| 特徴             | 説明                                                                                                        |
| :--------------- | :---------------------------------------------------------------------------------------------------------- |
| **仮想サーバー** | 物理サーバーを仮想化したコンピューティング環境を提供します。                                                |
| **オンデマンド** | 必要に応じていつでも仮想サーバーを起動・停止・終了できます。                                                |
| **スケーラブル** | トラフィックや負荷の変化に応じて、仮想サーバーの台数を増減させたり、性能を変更したりできます。              |
| **従量課金制**   | 利用した分だけ料金が発生するため、初期投資を抑え、運用コストを最適化できます。                              |
| **多様な構成**   | CPU、メモリ、ストレージ、ネットワーク性能など、目的に応じて様々な構成 (インスタンスタイプ) を選択できます。 |

EC2 は、Web サーバー、アプリケーションサーバー、データベースサーバー、バッチ処理など、様々な用途で利用される AWS のコンピューティング基盤です。

---

## EC2 のメリット

Amazon EC2 は、従来のオンプレミス環境や他の仮想化環境と比較して、多くの明確なメリットを提供します。  
これらのメリットは、ビジネスの俊敏性、コスト効率、そして運用の柔軟性を大幅に向上させます。

| メリット                       | 説明                                                                                                                           | 従来の環境との比較                                                                                  |
| :----------------------------- | :----------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------- |
| **高いスケーラビリティ**       | 必要な時に必要な分だけ、CPU、メモリ、ストレージ容量を拡張・縮小できます。                                                      | ハードウェアの調達や設定に時間とコストがかかり、急な需要変動に対応しにくいです。                    |
| **従量課金制 (Pay-as-you-go)** | 利用した時間、データ転送量、ストレージ容量に対してのみ課金されます。 初期費用や固定費は基本的に発生しません。                  | サーバー購入や設置に多額の初期投資が必要です。 利用していない期間も減価償却費や維持費がかかります。 |
| **高い信頼性と可用性**         | 複数のアベイラビリティゾーン (AZ) にわたる冗長構成や、AWS の堅牢なインフラストラクチャにより、高い可用性を提供します。         | ハードウェア障害時の復旧や冗長化の設計・構築・運用に専門知識とコストが必要です。                    |
| **迅速なプロビジョニング**     | 数分で新しいインスタンスを起動し、すぐに利用を開始できます。 開発、テスト、本番環境の構築を迅速に行えます。                    | 物理サーバーの調達、設置、OS インストール、初期設定に数日〜数週間かかることがあります。             |
| **多様な選択肢**               | CPU、メモリ、ストレージ、ネットワーク性能が異なる多種多様なインスタンスタイプ、複数の OS、ストレージオプションを選択できます。 | 限られたハードウェアリソースの中から選択する必要があり、用途に最適な構成が難しい場合があります。    |
| **セキュリティ**               | AWS の厳格な物理セキュリティ、ネットワークセキュリティ、DDoS 対策など、多層的なセキュリティ機能を利用できます。                | 自社で全てのセキュリティ対策を講じる必要があり、専門的な知識と継続的な運用が求められます。          |

これらのメリットにより、EC2 はスタートアップから大企業まで、あらゆる規模のビジネスにおいて、効率的で柔軟な IT インフラストラクチャを実現するための基盤となっています。

---

## EC2 の仕組み

Amazon EC2 は、AWS の堅牢な物理インフラストラクチャ上で、仮想化技術を用いて仮想サーバー (インスタンス) を提供します。  
ユーザーがインスタンスを起動する際には、いくつかの構成要素が組み合わさって、要求されたコンピューティング環境が構築されます。  
ここでは、EC2 インスタンスがどのように動作し、構成されるかの基本的な仕組みを解説します。

### 物理インフラストラクチャと仮想化

AWS のデータセンターには、高性能な物理サーバーが多数配置されています。  
これらの物理サーバー上では、「ハイパーバイザ」と呼ばれるソフトウェアが動作しており、物理リソース (CPU、メモリ、ストレージ、ネットワーク) を仮想化し、複数の独立した仮想マシン (EC2 インスタンス) を実行できるようにしています。  
これにより、一つの物理サーバーを複数のユーザーやアプリケーションで効率的に共有することが可能になります。

### インスタンス起動の主要な構成要素

EC2 インスタンスを起動する際には、以下の主要な要素を選択・指定します。

| 構成要素                        | 説明                                                                                                                                                | 役割                                                                                                            |
| :------------------------------ | :-------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------- |
| **AMI (Amazon Machine Image)**  | インスタンスの起動に必要なソフトウェア構成 (OS、アプリケーションサーバー、アプリケーションなど) が含まれるテンプレートです。                        | どのような OS や初期設定の環境でインスタンスを起動するかを定義します。                                          |
| **インスタンスタイプ**          | CPU、メモリ、ストレージ、ネットワーク性能など、インスタンスのハードウェア構成を定義します。                                                         | アプリケーションの要件に応じた処理能力やリソースを決定します。                                                  |
| **EBS (Elastic Block Store)**   | インスタンスにアタッチされる永続的なブロックストレージです。 インスタンスのルートボリュームとして、または追加のデータボリュームとして使用されます。 | OS やアプリケーションのデータを保存し、インスタンスが停止または終了してもデータが保持されるようにします。       |
| **VPC (Virtual Private Cloud)** | AWS クラウド内に構築する、論理的に分離されたプライベートなネットワーク空間です。                                                                    | インスタンスが配置されるネットワーク環境を定義し、IP アドレス範囲、サブネット、ルートテーブルなどを管理します。 |
| **セキュリティグループ**        | インスタンスへのインバウンド (受信) およびアウトバウンド (送信) トラフィックを制御する仮想ファイアウォールです。                                    | ネットワークレベルでのセキュリティを確保し、どの IP アドレスやポートからのアクセスを許可するかを定義します。    |
| **キーペア**                    | SSH によるインスタンスへの安全な接続に必要な認証情報です。 パブリックキーはインスタンスに保存され、プライベートキーはユーザーが保持します。         | インスタンスへのリモート接続時の認証を提供します。                                                              |

これらの要素を組み合わせて指定することで、ユーザーは自身の要件に合致した仮想サーバー環境を AWS クラウド上に迅速に構築し、利用を開始することができます。

---

## EC2 の構造

Amazon EC2 インスタンスは、単一の仮想マシンとして存在するだけでなく、その周囲を取り巻く様々な要素と連携して機能します。  
ここでは、EC2 インスタンスがどのような構成要素から成り立ち、どのように配置・管理されるかの「構造」に焦点を当てて解説します。  
これにより、インスタンスが AWS クラウドのどこに、どのような設定で存在しているかを理解することができます。

### 物理的な配置：リージョンとアベイラビリティゾーン

EC2 インスタンスを起動する際、まず「リージョン」と「アベイラビリティゾーン (AZ)」を選択します。

- **リージョン (Region)**: 世界中に分散している地理的な区分です。 各リージョンは完全に独立しており、データセンターの集合体として機能します。
- **アベイラビリティゾーン (Availability Zone - AZ)**: リージョン内に存在する、物理的に独立したデータセンターの集まりです。 通常、リージョン内には複数の AZ があり、それぞれが独立した電源、ネットワーク、冷却システムを持っています。 これにより、単一の AZ 障害が他の AZ に影響を及ぼすことを防ぎ、高可用性を実現します。

EC2 インスタンスは必ず特定の AZ 内に起動され、耐障害性を高めるために複数の AZ に分散してインスタンスを配置することが推奨されます。

### EC2 インスタンスを構成する主要な要素

EC2 インスタンス自体は、以下の要素から構成されます。

| 構造要素                       | 説明                                                                                                                                      | 関係性                                                                                                    |
| :----------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------- |
| **インスタンス (Instance)**    | 仮想サーバー本体です。 CPU、メモリ、一時ストレージなどのコンピューティングリソースを持ちます。                                            | すべての中心となる仮想コンピューティング単位です。                                                        |
| **AMI (Amazon Machine Image)** | インスタンスを起動するためのテンプレートです。 OS、アプリケーション、設定などが含まれます。                                               | インスタンスの「設計図」や「OS イメージ」に当たります。                                                   |
| **インスタンスタイプ**         | CPU、メモリ、ネットワーク性能、インスタンスストアの有無など、インスタンスのハードウェア仕様を定義します。                                 | インスタンスの性能とサイズを決定します。                                                                  |
| **EBS (Elastic Block Store)**  | インスタンスにアタッチされる永続的なブロックストレージです。 OS のルートボリュームや、追加のデータボリュームとして使用されます。          | インスタンスのデータが永続的に保存される場所です。 インスタンスのライフサイクルとは独立して存在できます。 |
| **インスタンスストア**         | インスタンスがホストされている物理サーバーに直接接続された一時的なブロックストレージです。 インスタンスの停止や終了でデータが失われます。 | 高速な一時データ保存に適しています。 インスタンスのライフサイクルと密接に結びついています。               |

### ネットワークとセキュリティの構造

EC2 インスタンスは、以下のネットワークとセキュリティ要素によって保護・管理されます。

| 構造要素                               | 説明                                                                                                                                    | 関係性                                                                                 |
| :------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------- |
| **VPC (Virtual Private Cloud)**        | AWS クラウド内に構築する、論理的に分離されたプライベートなネットワーク空間です。 インスタンスはこの VPC 内に配置されます。              | インスタンスが存在するネットワーク環境そのものです。                                   |
| **サブネット**                         | VPC をさらに細かく分割したネットワーク範囲です。 インスタンスは特定の AZ 内のサブネットに配置されます。                                 | インスタンスのネットワーク上の「住所」を細分化し、AZ と紐づけます。                    |
| **ネットワークインターフェース (ENI)** | インスタンスに仮想的にアタッチされるネットワークカードです。 IP アドレス、MAC アドレス、セキュリティグループなどが関連付けられます。    | インスタンスが VPC と通信するための「玄関口」です。                                    |
| **セキュリティグループ**               | インスタンスへのインバウンド/アウトバウンドトラフィックを制御する仮想ファイアウォールです。 インスタンスレベルで適用されます。          | 特定のインスタンスへのアクセスを許可/拒否するルールセットです。                        |
| **キーペア**                           | SSH 接続など、インスタンスへの安全なリモートアクセス認証に使用されます。 公開鍵はインスタンスに保存され、秘密鍵はユーザーが管理します。 | インスタンスへのセキュアなアクセスを保証します。                                       |
| **IAM ロール**                         | EC2 インスタンスが他の AWS サービス (S3、DynamoDB など) にアクセスするためのアクセス許可を提供します。                                  | インスタンスが持つ「権限」を定義し、最小権限の原則に基づいたセキュリティを実現します。 |

これらの要素が複合的に連携することで、AWS クラウド上で柔軟かつセキュア、そして可用性の高い仮想サーバー環境が構築されます。  
各要素の役割と関係性を理解することは、効率的で堅牢なシステム設計の基礎となります。

---

## AMI (OS)

Amazon EC2 インスタンスを起動する際に不可欠な要素の一つが、AMI (Amazon Machine Image) です。  
AMI は、インスタンスの「設計図」または「OS イメージ」として機能し、仮想サーバーがどのような OS やソフトウェア環境で立ち上がるかを定義します。  
ここでは、AMI の基本的な概念、種類、およびその重要性について詳しく解説します。

### AMI とは

AMI は、Amazon EC2 インスタンスを起動するために必要な情報がすべて含まれたテンプレートです。  
これには、主に以下のものが含まれます。

- **OS (オペレーティングシステム)**: Linux (Amazon Linux, Ubuntu, Red Hat Enterprise Linux など) や Windows Server などの基本 OS。
- **アプリケーションサーバー、アプリケーション、設定ファイル**: 必要に応じて、ウェブサーバー (Apache, Nginx)、データベース (MySQL, PostgreSQL)、ミドルウェア、カスタムアプリケーションなどが事前にインストールされ、設定された状態。
- **ルートボリュームのテンプレート**: OS がインストールされているストレージの初期状態を定義します。
- **起動許可**: 特定の AWS アカウントに対して AMI を使用する許可。
- **ブロックデバイスマッピング**: インスタンス起動時にアタッチされるストレージボリューム (EBS ボリュームなど) の構成を定義します。

AMI を使用することで、毎回 OS のインストールや基本的なソフトウェアの設定を行う手間を省き、一貫性のある環境を迅速にデプロイすることが可能になります。

### AMI の種類

AMI には、利用目的や作成元に応じていくつかの種類があります。

| AMI の種類              | 説明                                                                                                                                                                                           | 主な用途                                                                                                                                   |
| :---------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------- |
| **AWS が提供する AMI**  | AWS が公式に提供する AMI です。 Amazon Linux 2、Ubuntu Server、Windows Server など、最新の OS バージョンが定期的に更新されます。                                                               | 最も一般的で、信頼性が高く、セキュリティパッチが適用されているため、新規インスタンスのベースとして最適です。                               |
| **コミュニティ AMI**    | AWS ユーザーが作成し、公開している AMI です。 特定のソフトウェアがプリインストールされているものや、特殊な設定が施されているものがあります。                                                   | 自分で AMI を作成する手間を省きたい場合や、特定の環境を素早く試したい場合に利用されます。 ただし、信頼性はユーザーに依存します。           |
| **AWS Marketplace AMI** | 有償または無償で、ベンダーが提供するソフトウェア (セキュリティ製品、ミドルウェア、ビジネスアプリケーションなど) がプリインストールされた AMI です。 利用には追加料金が発生する場合があります。 | 特定の商用ソフトウェアやソリューションを EC2 上で利用したい場合に便利です。                                                                |
| **カスタム AMI**        | 既存の EC2 インスタンスをベースにして、ユーザー自身が作成する AMI です。 OS、設定、インストール済みのアプリケーションなど、独自の環境を完全にコピーできます。                                  | 独自のアプリケーション環境のテンプレート化、本番環境のバックアップ、同一環境の複数デプロイ、CI/CD パイプラインとの連携などに利用されます。 |

### カスタム AMI の作成と利用

既存の EC2 インスタンスからカスタム AMI を作成する手順は以下の通りです。

1.  既存の EC2 インスタンスを起動し、必要な OS 設定、ソフトウェアインストール、アプリケーション配置などを行います。
2.  そのインスタンスの状態を「スナップショット」として保存し、AMI を作成します。
3.  作成されたカスタム AMI を利用して、全く同じ環境の新しい EC2 インスタンスを何台でも起動できます。

カスタム AMI の利用は、開発環境と本番環境の一貫性を保つ、障害発生時の迅速な復旧 (Golden Image として)、複数のインスタンスをスケールアウトさせる際の迅速なプロビジョニングなど、多くのメリットをもたらします。

AMI は、EC2 インスタンスの安定した動作と効率的な管理を実現するための基盤となる重要な要素です。 適切な AMI を選択または作成することで、AWS 環境におけるシステムの構築と運用が大幅に簡素化されます。

---

## 選択できる OS

Amazon EC2 インスタンスを起動する際には、AMI (Amazon Machine Image) を選択しますが、この AMI には様々な OS (オペレーティングシステム) が含まれています。  
EC2 では、主要な Linux ディストリビューションから Windows Server まで、幅広い選択肢が用意されており、用途や既存のシステム、チームのスキルセットに応じて最適な OS を選ぶことができます。

### 主要な OS の種類

EC2 で利用可能な AMI を通じて、主に以下の OS を選択できます。

#### 1. Linux 系 OS

オープンソースであり、高いパフォーマンス、安定性、セキュリティ、そしてコスト効率が評価されています。  
多くの Web サービスやアプリケーションの基盤として広く利用されています。

- **Amazon Linux**:  
  AWS が提供する Linux ディストリビューションです。 AWS 環境に最適化されており、AWS サービスとの連携がスムーズです。 EC2 利用料金に OS の費用が含まれており、追加のライセンス費用はかかりません。
- **Ubuntu Server**:  
  開発者や OSS (オープンソースソフトウェア) コミュニティに非常に人気のあるディストリビューションです。 豊富なドキュメントとコミュニティサポートが強みです。
- **Red Hat Enterprise Linux (RHEL)**:  
  エンタープライズ環境で広く利用される商用 Linux ディストリビューションです。 高い安定性、セキュリティ、Red Hat 社による手厚いサポートが特徴です。 利用にはライセンス費用が発生します。
- **SUSE Linux Enterprise Server (SLES)**:  
  こちらもエンタープライズ向けの商用 Linux ディストリビューションで、特に SAP などの大規模なビジネスアプリケーションの動作環境として実績があります。 利用にはライセンス費用が発生します。
- **CentOS Stream**:  
  Red Hat Enterprise Linux と互換性のあるコミュニティ主導の OS です。 以前は RHEL のフリークローンとして人気でしたが、現在は RHEL の将来のバージョンの開発版としての位置づけになっています。

#### 2. Windows Server 系 OS

Microsoft のアプリケーションやサービスを利用する場合に最適です。 GUI による操作が可能で、既存の Microsoft インフラストラクチャとの統合が容易です。

- **Windows Server (2012 R2, 2016, 2019, 2022 など)**:  
  Microsoft が提供するサーバー OS です。 IIS、SQL Server、Active Directory、.NET アプリケーションなど、Microsoft エコシステムとの親和性が非常に高いです。 利用にはライセンス費用が発生します。

### OS 選択の考慮事項

適切な OS を選択するためには、以下の要素を考慮することが重要です。

| 考慮事項                     | 説明                                                                                                                                                                               |
| :--------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **アプリケーションの互換性** | 実行したいアプリケーションやミドルウェアがサポートしている OS を確認します。 特定の OS バージョンやライブラリに依存する場合があります。                                            |
| **ライセンスコスト**         | 有償の OS (RHEL, SLES, Windows Server など) は、EC2 の利用料金に加えてライセンス費用が発生します。 無料の OS (Amazon Linux, Ubuntu など) はコストを抑えられます。                  |
| **チームのスキルセット**     | 運用チームが慣れている OS を選択することで、学習コストや運用負荷を低減できます。                                                                                                   |
| **コミュニティとサポート**   | 問題発生時の情報収集やサポート体制を考慮します。 人気の高い OS はコミュニティからの情報やサポートが豊富です。 エンタープライズ向け OS はベンダーからの公式サポートが利用できます。 |
| **セキュリティ要件**         | 特定のセキュリティ認証や規制要件に準拠する必要がある場合、それに適した OS やそのバージョンを選択する必要があります。                                                               |

### 主要 OS の比較表

| OS カテゴリ | OS 名                               | 特徴                                                          | ライセンス形態           | 主なユースケース                                                |
| :---------- | :---------------------------------- | :------------------------------------------------------------ | :----------------------- | :-------------------------------------------------------------- |
| **Linux**   | Amazon Linux                        | AWS に最適化。 AWS サービスとの連携が容易。 無償。            | EC2 利用料に含まれる     | Web/AP サーバー、AWS サービス連携、軽量ワークロード             |
| **Linux**   | Ubuntu Server                       | 開発者や OSS ユーザーに人気。 豊富なコミュニティサポート。    | EC2 利用料に含まれる     | 開発環境、Web/AP サーバー、コンテナホスト、研究開発             |
| **Linux**   | Red Hat Enterprise Linux (RHEL)     | エンタープライズ向け。 高い安定性と公式サポート。             | 有料 (オンデマンド/BYOL) | 基幹システム、ミッションクリティカルなワークロード              |
| **Linux**   | SUSE Linux Enterprise Server (SLES) | エンタープライズ向け。 特に SAP ワークロードに強い。          | 有料 (オンデマンド/BYOL) | SAP システム、エンタープライズアプリケーション                  |
| **Windows** | Windows Server                      | Microsoft 製品との親和性。 GUI 操作。 Active Directory 対応。 | 有料 (オンデマンド/BYOL) | .NET アプリケーション、SQL Server、Active Directory、SharePoint |

これらの情報を基に、プロジェクトの要件に最適な OS を選択し、効率的かつ安定した EC2 環境を構築しましょう。

---

## ミドルウェア

EC2 インスタンス上でアプリケーションを動作させるためには、OS (前述の AMI で選択) の上に、特定の機能を提供する「ミドルウェア」をインストール・設定する必要があります。  
ミドルウェアは、OS とアプリケーションの間に位置し、アプリケーションが効率的かつ安定して動作するための基盤や、共通機能を提供するソフトウェアの総称です。

### ミドルウェアの役割

ミドルウェアは、アプリケーション開発者がビジネスロジックに集中できるよう、共通のサービスやインフラストラクチャ的な機能を提供します。  
EC2 インスタンス上でミドルウェアを利用する主な目的は以下の通りです。

- **アプリケーションの実行環境の提供**: Web サーバー、アプリケーションサーバーなど。
- **データの管理**: データベース管理システムなど。
- **システム間の連携**: メッセージキュー、API ゲートウェイなど。
- **パフォーマンス向上**: キャッシュ、ロードバランサーなど。
- **セキュリティ機能の強化**: 認証、認可、ファイアウォールなど (OS やセキュリティグループとは異なるアプリケーション層での制御)。

### EC2 インスタンスで利用される主なミドルウェア

EC2 インスタンスでは、様々な種類のミドルウェアがアプリケーションの要件に応じて利用されます。  
以下に、代表的なミドルウェアとその役割を示します。

| ミドルウェアの分類              | 具体例                                                           | 主な役割                                                                                                                                                               |
| :------------------------------ | :--------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Web サーバー**                | Apache HTTP Server, Nginx, IIS (Windows)                         | クライアントからの HTTP リクエストを受け付け、静的コンテンツを配信したり、動的コンテンツのリクエストをアプリケーションサーバーに転送したりします。                     |
| **アプリケーションサーバー**    | Apache Tomcat, JBoss/WildFly, Node.js ランタイム, PHP-FPM, uWSGI | Web サーバーからのリクエストを受けて、ビジネスロジックを処理し、動的なコンテンツを生成します。 Java, Node.js, PHP, Python などのアプリケーション実行環境を提供します。 |
| **データベース**                | MySQL, PostgreSQL, MongoDB, Redis                                | アプリケーションが利用するデータを永続的に保存し、管理します。 リレーショナルデータベース (RDB) や NoSQL データベースがあります。                                      |
| **メッセージキュー/ブローカー** | RabbitMQ, Apache Kafka, ActiveMQ                                 | アプリケーション間で非同期にメッセージを交換するための仕組みを提供します。 システムの疎結合化や負荷分散に貢献します。                                                  |
| **キャッシュシステム**          | Memcached, Redis                                                 | 頻繁にアクセスされるデータをメモリ上に一時的に保持し、データベースへのアクセス負荷を軽減してパフォーマンスを向上させます。                                             |
| **検索エンジン**                | Elasticsearch, Apache Solr                                       | 大量のデータから高速に情報を検索するための機能を提供します。 全文検索、ログ分析などに利用されます。                                                                    |
| **プロキシ/ロードバランサー**   | HAProxy, Nginx (リバースプロキシ機能)                            | サーバーの手前に配置され、クライアントからのリクエストを複数のバックエンドサーバーに分散させたり、セキュリティ機能を提供したりします。                                 |

### ミドルウェア選定の考慮事項

ミドルウェアを選択する際には、以下の点を考慮することが重要です。

- **アプリケーションの要件**: 開発言語、データ構造、処理性能、スケーラビリティなど、アプリケーションの具体的な要件に合致するかどうか。
- **コミュニティとサポート**: 利用者が多く、ドキュメントや情報が豊富か。 また、商用サポートが必要な場合はその有無。
- **運用負荷**: インストール、設定、監視、パッチ適用、バージョンアップなどの運用に必要なリソース。
- **ライセンスとコスト**: オープンソースであれば無償ですが、商用ミドルウェアにはライセンス費用が発生します。
- **AWS マネージドサービスとの比較**:
  - AWS では、EC2 上でミドルウェアを自分で構築・運用する代わりに、RDS (データベース)、ElastiCache (キャッシュ)、SQS (メッセージキュー)、MSK (Kafka) など、多くのマネージドサービスを提供しています。
  - これらのマネージドサービスは、高可用性、スケーラビリティ、バックアップ、パッチ適用などを AWS が管理してくれるため、運用負荷を大幅に軽減できます。
  - しかし、EC2 上で自分でミドルウェアを構築する方が、より高度なカスタマイズや特定の構成要件に対応できる場合があります。 運用負荷と自由度のトレードオフを考慮して選択します。

EC2 インスタンスの OS 上に適切なミドルウェアを配置することで、アプリケーションは期待される機能を安定して提供し、ビジネス要件を満たすことができます。

---

## インスタンスタイプ

これまでの項目で、EC2 インスタンスがどのような OS やミドルウェアを基盤として動作するかを解説しました。  
次に、その EC2 インスタンスがどのような「ハードウェア構成」を持つかを定義するのが「インスタンスタイプ」です。  
インスタンスタイプは、仮想サーバーが持つ CPU、メモリ、ストレージ (インスタンスストア)、ネットワーク性能の組み合わせを決定し、アプリケーションの性能要件に合致する最適なリソースを選択するために非常に重要です。

### インスタンスタイプとは

インスタンスタイプは、EC2 インスタンスの**ハードウェア仕様**を事前に定義されたパッケージとして提供します。  
AWS は、さまざまなワークロードの要件に合わせて最適化された多種多様なインスタンスタイプを用意しており、ユーザーはアプリケーションのニーズに応じて最適なものを選ぶことができます。

インスタンスタイプを構成する主なリソースは以下の通りです。

- **vCPU (Virtual Central Processing Unit)**: 仮想化された CPU コアの数と性能。
- **メモリ (Memory)**: RAM (Random Access Memory) の容量。
- **インスタンスストア (Instance Store)**: インスタンスがホストされている物理サーバーに直接接続された一時的なストレージ (すべてのインスタンスタイプに付属するわけではありません)。
- **ネットワーク性能**: インスタンスが利用できるネットワーク帯域幅。

### インスタンスタイプの命名規則

AWS のインスタンスタイプは、一般的に以下の形式で命名されます。  
`[ファミリー].[世代].[サイズ]` または `[ファミリー][世代].[追加機能].[サイズ]`

例: `m5.large`、`c6g.xlarge`、`r5dn.2xlarge`

| 項目                                   | 説明                                                                                                                    | 例                                                                                                                    |
| :------------------------------------- | :---------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------- |
| **ファミリー (Family)**                | 特定のワークロードタイプ (汎用、コンピューティング最適化など) に最適化されたインスタンスグループ。                      | `m` (汎用), `c` (コンピューティング最適化), `r` (メモリ最適化), `t` (汎用バースト可能) など。                         |
| **世代 (Generation)**                  | インスタンスタイプのバージョンまたは世代。 数字が大きいほど新しい世代で、一般的に性能向上やコスト効率の改善があります。 | `5`, `6`, `7` など。                                                                                                  |
| **追加機能 (Additional Capabilities)** | 特定のプロセッサタイプやストレージの種類など、追加の機能を示すサフィックス。 省略されることもあります。                 | `d` (NVMe インスタンスストア), `a` (AMD プロセッサ), `g` (AWS Graviton プロセッサ), `n` (高ネットワーク帯域幅) など。 |
| **サイズ (Size)**                      | ファミリー内の相対的なサイズを示します。 サイズが大きいほど、vCPU、メモリ、ネットワークなどのリソースが増加します。     | `nano`, `micro`, `small`, `medium`, `large`, `xlarge`, `2xlarge`, `4xlarge` など。                                    |

### 主なインスタンスタイプファミリーとユースケース

AWS は、さまざまなニーズに対応するため、多様なインスタンスタイプファミリーを提供しています。

| ファミリー                                         | 特徴                                                                                               | 適したワークロード                                                                  | 代表的なインスタンス                                   |
| :------------------------------------------------- | :------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------- | :----------------------------------------------------- |
| **汎用 (General Purpose)**                         | CPU とメモリのバランスが取れています。 幅広いワークロードに対応。                                  | ウェブサーバー、小規模データベース、開発環境、ビジネスアプリケーション              | `M` (バランス型), `T` (バースト可能), `A` (Arm ベース) |
| **コンピューティング最適化 (Compute Optimized)**   | 高い CPU 性能を提供し、バッチ処理や計算集約型ワークロードに適しています。                          | 高パフォーマンス Web サーバー、メディアトランスコーディング、科学計算、機械学習推論 | `C` (高 CPU 比率)                                      |
| **メモリ最適化 (Memory Optimized)**                | 大量のメモリを提供し、メモリ内データベースや大規模データ分析に適しています。                       | 大規模リレーショナルデータベース、インメモリデータベース、ビッグデータ分析          | `R` (高メモリ比率), `X`, `Z` (非常に大容量)            |
| **ストレージ最適化 (Storage Optimized)**           | 大容量のストレージと高い I/O 性能を提供し、データウェアハウスや NoSQL データベースに適しています。 | 大規模データウェアハウス、NoSQL データベース、分散ファイルシステム                  | `I` (高 I/O), `D` (高密度ストレージ), `H` (HDD ベース) |
| **高速コンピューティング (Accelerated Computing)** | GPU、FPGA、または特殊なプロセッサを搭載し、並列計算やグラフィックス処理、機械学習に最適です。      | 機械学習、ディープラーニング、グラフィックス処理、科学技術計算                      | `P`, `G` (GPU), `F` (FPGA)                             |

### インスタンスタイプの選択基準

最適なインスタンスタイプを選択するためには、以下の要素を考慮する必要があります。

1.  **ワークロードの要件**:
    - **CPU 集約型か、メモリ集約型か**: アプリケーションが主に CPU を消費するのか、それとも大量のメモリを必要とするのかを把握します。
    - **I/O 性能**: ストレージに対する読み書きの頻度や速度が重要かどうか。
    - **ネットワークスループット**: ネットワーク経由でのデータ転送量や速度の要件。
2.  **コスト**:
    - インスタンスタイプによって時間あたりの料金が大きく異なります。 予算内で最適な性能を得られるタイプを選択します。
    - `T` ファミリーのようなバースト可能なインスタンスは、低利用時にコストを抑えつつ、一時的な高負荷に対応できるため、開発環境やトラフィックの変動が大きい Web サイトに適しています。
3.  **プロセッサアーキテクチャ**:  
     \* 従来の x86 プロセッサ (Intel/AMD) の他に、AWS Graviton プロセッサを搭載したインスタンス (`A`, `M6g`, `C6g`, `R6g` など) も選択できます。 Graviton プロセッサは、多くの場合、同等の x86 インスタンスよりも高いパフォーマンスとコスト効率を提供前後の文脈を考慮し、ストレージ (EBS)についてのマークダウンを生成して下さい。はい、承知いたしました。
    前後の文脈を考慮し、「ストレージ (EBS)」のマークダウンを生成します。

---

## ストレージ (EBS)

EC2 インスタンスは、コンピューティングリソース (CPU, メモリ) を提供しますが、データの保存には別途ストレージが必要です。  
AWS が EC2 インスタンス向けに提供する主要なブロックストレージサービスが、Amazon EBS (Elastic Block Store) です。  
EBS は、その「永続性」と「柔軟性」から、EC2 インスタンスのルートボリューム (OS がインストールされるディスク) や、アプリケーションが使用するデータボリュームとして広く利用されています。

### Amazon EBS とは

Amazon EBS は、EC2 インスタンスにアタッチして使用する**永続的なブロックストレージサービス**です。  
「ブロックストレージ」とは、データを固定サイズのブロック単位で管理し、OS からは通常のハードディスクドライブや SSD と同じように認識されるストレージのことです。

| 特徴                    | 説明                                                                                                                                                      |
| :---------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **永続性 (Persistent)** | EBS ボリュームは、EC2 インスタンスのライフサイクルとは独立して存在します。 インスタンスが停止または終了しても、EBS ボリュームとそのデータは保持されます。 |
| **ネットワーク接続型**  | EBS ボリュームは、同じアベイラビリティゾーン (AZ) 内の EC2 インスタンスにネットワーク経由でアタッチされます。                                             |
| **高可用性**            | EBS ボリュームは、単一の AZ 内で自動的に複製され、コンポーネント障害から保護されるように設計されています。                                                |
| **スケーラブル**        | ボリュームの容量や性能 (IOPS/スループット) を、停止することなく、またはごく短時間の停止で動的に変更できます。                                             |
| **多様なタイプ**        | さまざまなワークロードの性能要件とコスト要件に合わせて、複数のボリュームタイプ (SSD ベース、HDD ベース) が提供されています。                              |
| **暗号化**              | EBS ボリュームとそのスナップショットは、AWS KMS (Key Management Service) を使用して簡単に暗号化できます。                                                 |

### EBS ボリュームのライフサイクル

1.  **作成**: EBS ボリュームは、特定の AZ 内に作成されます。
2.  **アタッチ**: 作成された EBS ボリュームは、同じ AZ 内の EC2 インスタンスにアタッチできます。 OS からは新しいディスクとして認識されます。
3.  **利用**: インスタンス内でファイルシステムを作成・フォーマットし、データを保存します。
4.  **デタッチ**: インスタンスから EBS ボリュームを切り離すことができます。
5.  **削除**: 不要になった EBS ボリュームは削除できます。 削除するとデータは完全に消滅します。

### EBS ボリュームの種類 (タイプ)

AWS は、さまざまなワークロードの性能とコストのバランスに合わせて、多様な EBS ボリュームタイプを提供しています。  
大きく分けて、SSD ベースと HDD ベースの 2 種類があります。

| カテゴリ                                               | ボリュームタイプ                   | 特徴                                                                                                 | 主な性能指標                                                                                         | 主なユースケース                                                     |
| :----------------------------------------------------- | :--------------------------------- | :--------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------- |
| **SSD ベース** <br /> (汎用、トランザクション系)       | **gp3 (General Purpose SSD)**      | 最新世代の汎用 SSD。 IOPS とスループットを独立して設定可能。 高いコスト効率。                        | 最大 16,000 IOPS, 1,000 MB/s                                                                         | ルートボリューム、開発/テスト、本番 Web/AP サーバー、小規模 DB       |
|                                                        | **gp2 (General Purpose SSD)**      | 前世代の汎用 SSD。 容量に比例して IOPS が向上。 ブースト機能あり。                                   | 最大 16,000 IOPS (3 IOPS/GB)                                                                         | gp3 への移行推奨。 同様の汎用ワークロード                            |
|                                                        | **io2 (Provisioned IOPS SSD)**     | データベースなど、最高のパフォーマンスと一貫した IOPS を要求する I/O 集約型ワークロード向け。        | 最大 64,000 IOPS (Nitro ベースのインスタンスで 256,000 IOPS), 1,000 MB/s (Nitro ベースで 4,000 MB/s) | 大規模リレーショナル DB、NoSQL DB、ミッションクリティカルな AP       |
|                                                        | **io1 (Provisioned IOPS SSD)**     | 前世代のプロビジョンド IOPS SSD。 io2 への移行推奨。                                                 | 最大 64,000 IOPS                                                                                     | io2 への移行推奨。 同様の高性能ワークロード                          |
| **HDD ベース** <br /> (スループット、ストリーミング系) | **st1 (Throughput Optimized HDD)** | 大容量で高いスループットを要求するシーケンシャル I/O ワークロード向け。 頻繁にアクセスされるデータ。 | 最大 500 MB/s, 500 IOPS                                                                              | ビッグデータ処理、ログ処理、データウェアハウス                       |
|                                                        | **sc1 (Cold HDD)**                 | コストが最優先で、アクセス頻度の低い大容量データ向け。 最も低コストなボリュームタイプ。              | 最大 250 MB/s, 250 IOPS                                                                              | アクセス頻度の低いアーカイブ、バックアップ、コールドデータストレージ |

### EBS の料金

EBS の料金は、以下の要素に基づいて計算される従量課金制です。

- **プロビジョニングされたストレージ容量**: ボリュームタイプごとに GB あたりの料金が設定されています。
- **プロビジョニングされた IOPS (io1/io2 のみ)**: 設定した IOPS 量に対して料金が発生します。
- **データ転送量**: EBS への書き込みや、同一 AZ 内の EC2 インスタンスへの読み書きは無料です。 異なる AZ やインターネットへのデータ転送には料金が発生します。
- **スナップショット**: スナップショットの保存容量に対して料金が発生します。

EBS は、EC2 インスタンスのデータの永続性と可用性を確保する上で非常に重要なサービスです。  
アプリケーションの要件に応じて適切な EBS ボリュームタイプを選択することで、パフォーマンスとコストの最適なバランスを実現できます。

---

## EBS

前のセクションで、Amazon EBS (Elastic Block Store) が EC2 インスタンスにアタッチされる永続的なブロックストレージであり、その多様なボリュームタイプについて解説しました。  
ここでは、EBS の具体的な利用シナリオ、性能特性、および重要なデータ保護機能について、さらに詳しく掘り下げていきます。

### EBS の具体的な利用方法

EBS ボリュームは、EC2 インスタンスにおいて主に以下の 2 つの役割で使用されます。

#### 1. ルートボリュームとしての EBS

- **役割**: EC2 インスタンスの起動時に OS やブートローダー、初期設定ファイルなどが格納される主要なディスクです。
- **特徴**:
  - インスタンス起動時に自動的に作成・アタッチされます。
  - インスタンスが停止してもデータは保持されるため、OS の再起動やインスタンスの停止・起動を安全に行えます。
  - ほとんどの AMI は、ルートボリュームとして EBS を使用するように設定されています。
- **推奨**: 通常、汎用 SSD (gp3) がルートボリュームとして推奨されます。 性能とコストのバランスが取れているためです。

#### 2. データボリュームとしての EBS

- **役割**: アプリケーションデータ、ログファイル、データベースファイルなど、OS とは独立して永続的に保存したいデータを格納するための追加ディスクです。
- **特徴**:
  - 1 つの EC2 インスタンスに複数の EBS ボリュームをアタッチできます。
  - アタッチ後、OS 内でパーティションを作成し、ファイルシステムをフォーマットしてマウントすることで利用可能になります。
  - インスタンスの起動・停止に関わらず、データの永続性が確保されます。
- **推奨**: アプリケーションの I/O 要件に応じて、gp3, io2, st1, sc1 などの適切なボリュームタイプを選択します。

### EBS の性能特性と調整

EBS の性能は、選択するボリュームタイプとプロビジョニング設定によって大きく異なります。  
特に、**IOPS (Input/Output Operations Per Second)** と **スループット (Throughput - MB/s)** は、EBS の性能を測る重要な指標です。

| 性能指標         | 説明                                                                                                                                                                                    |
| :--------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **IOPS**         | 1 秒間に実行できる入出力操作の数です。 データベースのトランザクション処理など、小さなファイルを頻繁に読み書きするワークロードで重要になります。                                         |
| **スループット** | 1 秒間に転送できるデータ量 (メガバイト単位) です。 メディアストリーミング、ログ分析、データウェアハウスなど、大きなファイルをシーケンシャルに読み書きするワークロードで重要になります。 |

- **gp3 ボリューム**:
  - 容量とは独立して IOPS とスループットを柔軟に設定できます。 これにより、不要な容量をプロビジョニングすることなく、必要な性能を確保できるため、コスト効率が非常に高いです。
  - ベースラインとして 3,000 IOPS と 125 MB/s のスループットが提供され、それ以上は追加料金で設定可能です。
- **io1/io2 ボリューム**:
  - ミッションクリティカルなデータベースなど、極めて高い IOPS と一貫した性能が求められる場合に選択します。
  - プロビジョニングされた IOPS に対して料金が発生します。

### EBS データの保護：スナップショットと暗号化

EBS は、その永続性だけでなく、データの保護機能も充実しています。

#### 1. スナップショット

- **機能**: EBS ボリュームの特定の時点における完全なバックアップを S3 に保存する機能です。 スナップショットは増分バックアップであり、前回のスナップショットからの変更点のみが保存されるため、効率的です。
- **利用**:
  - ボリューム障害時の復旧。
  - 新しい EBS ボリュームの作成 (既存のデータを持つボリュームの複製)。
  - カスタム AMI の作成 (OS やアプリケーションの設定を含むルートボリュームのスナップショットから AMI を作成)。
- **詳細**: 次のセクション「スナップショット」で詳しく解説します。

#### 2. 暗号化

- **機能**: EBS ボリュームに保存されるデータと、スナップショット、およびそのスナップショットから作成される新しいボリュームを自動的に暗号化します。
- **メリット**:
  - 保存データ (data at rest) のセキュリティを強化します。
  - AWS KMS (Key Management Service) と連携し、キー管理も容易です。
  - 特別な設定やパフォーマンスへの影響を心配することなく、簡単に利用できます。
- **適用**: ボリューム作成時に暗号化を有効にするか、既存の暗号化されていないボリュームを暗号化されたボリュームにコピーすることで適用できます。

EBS は、EC2 インスタンスのデータ永続性と可用性の中心となるサービスです。  
適切なボリュームタイプとサイズを選択し、スナップショットや暗号化を活用することで、アプリケーションの性能要件を満たしつつ、データの安全性を最大限に高めることができます。

---

## スナップショット

前のセクションで、EBS ボリュームの永続性と、そのデータ保護機能の一つとして「スナップショット」があることに触れました。  
ここでは、Amazon EBS スナップショットの具体的な仕組み、主要なユースケース、および運用上の考慮事項について詳しく解説します。  
スナップショットは、データのバックアップ、災害復旧、ボリュームの複製といった様々な場面で極めて重要な役割を果たします。

### スナップショットとは

EBS スナップショットは、特定の時点における EBS ボリュームのデータを、Amazon S3 に保存する**増分バックアップ**機能です。  
スナップショットを作成することで、ボリュームの状態を記録し、後でその状態にボリュームを復元したり、新しいボリュームを作成したりすることが可能になります。

| 特徴                           | 説明                                                                                                                                                                                                                              |
| :----------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **時点バックアップ**           | ボリュームのデータがスナップショット作成時の状態に保存されます。                                                                                                                                                                  |
| **増分バックアップ**           | 最初のスナップショットはボリューム全体のコピーですが、2 回目以降のスナップショットは、前回のスナップショット以降に変更されたブロックデータのみを保存します。 これにより、ストレージコストを削減し、バックアップ時間を短縮します。 |
| **S3 への保存**                | スナップショットデータは、耐久性と可用性の高い Amazon S3 に自動的に保存されます。 ユーザーが S3 バケットを直接操作する必要はありません。                                                                                          |
| **アベイラビリティゾーン独立** | スナップショットは AZ に依存しないため、ある AZ で作成したスナップショットから、同じリージョン内の別の AZ で新しいボリュームを作成・復元できます。 これは災害復旧において非常に重要です。                                         |
| **データ復旧**                 | 作成したスナップショットから、いつでも新しい EBS ボリュームを復元・作成できます。                                                                                                                                                 |

### スナップショットの仕組み

スナップショットは、以下のような仕組みで動作します。

1.  **初回スナップショット**:  
    ボリューム全体のデータブロックが S3 にコピーされます。
2.  **2 回目以降のスナップショット**:  
    前回のスナップショットが作成されてから変更されたデータブロックのみが S3 にコピーされます。  
    これにより、効率的なバックアップが実現されます。
3.  **スナップショットの削除**:  
    あるスナップショットを削除しても、そのスナップショット固有のデータブロックのみが削除され、他のスナップショットが参照している共通のデータブロックは削除されません。  
    そのため、どのスナップショットも独立してボリュームを復元できますが、連鎖する増分データの構造を理解しておく必要があります。

### スナップショットの主なユースケース

スナップショットは様々なシナリオで活用されます。

| ユースケース                    | 説明                                                                                                                                                                                                               |
| :------------------------------ | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **バックアップと災害復旧 (DR)** | 重要なデータの定期的なバックアップとして利用されます。 元のボリュームが破損した場合や、誤ってデータが削除された場合に、スナップショットからボリュームを復元できます。 別の AZ での復旧も可能です。                 |
| **ボリュームの複製**            | 既存の EBS ボリュームと全く同じデータを持つ新しいボリュームを、スナップショットから作成できます。 これは、開発/テスト環境の複製や、データ移行の際に便利です。                                                      |
| **カスタム AMI の作成**         | EC2 インスタンスのルートボリュームのスナップショットから、カスタム AMI を作成できます。 これにより、OS、アプリケーション、設定などを含む「ゴールデンイメージ」を作成し、一貫性のある環境を迅速にデプロイできます。 |
| **テスト環境の構築**            | 本番環境の EBS ボリュームからスナップショットを作成し、それを基にテスト用のボリュームやインスタンスを作成することで、本番データをテストに利用できます。                                                            |
| **ボリュームタイプの変更**      | 現在のボリュームタイプから別のタイプ (例: gp2 から gp3、st1 から io2) に移行したい場合、一度スナップショットを作成し、そのスナップショットから新しいタイプのボリュームを復元することで実現できます。               |

### スナップショットの作成と復元

#### スナップショットの作成

- AWS マネジメントコンソール、AWS CLI、または SDK を使用して、実行中のインスタンスにアタッチされた EBS ボリュームからスナップショットを作成できます。
- データの一貫性を保つため、スナップショット作成前にアプリケーションを停止するか、ファイルシステムのフリーズを行うことが推奨されます (特に Windows)。 AWS は、EBS Fast Snapshot Restore (FSR) や Amazon Data Lifecycle Manager (DLM) などの追加機能も提供しており、スナップショット管理を自動化・高速化できます。

#### スナップショットからの復元

- 作成されたスナップショットから、新しい EBS ボリュームを作成できます。 この新しいボリュームは、スナップショットが作成された時点のデータを含んでいます。
- 新しいボリュームは、元のボリュームと同じ AZ 内または異なる AZ 内に作成し、EC2 インスタンスにアタッチできます。

### スナップショットのコスト

スナップショットの料金は、Amazon S3 に保存されるデータ量に基づいて発生します。  
増分バックアップの特性により、効率的なコストでデータを保護できますが、不必要なスナップショットを削除することでコストを最適化することが重要です。  
スナップショットを削除する際は、依存関係を考慮し、最も古いスナップショットを削除するのではなく、不要になったスナップショットから順に削除する必要があります。

スナップショットは、EBS を利用する上で欠かせないデータ保護および運用管理のツールです。  
その仕組みと活用方法を理解することで、より堅牢で効率的なシステム構築が可能になります。

---

## インスタンスストア

これまで、EC2 インスタンスの永続的なブロックストレージとして Amazon EBS を解説してきました。  
EBS がインスタンスのライフサイクルから独立してデータ保持を保証する一方で、EC2 インスタンスにはもう一つの種類のストレージが存在します。それが「インスタンスストア」です。  
インスタンスストアは、EBS とは異なる特性を持つため、それぞれの違いと適切なユースケースを理解することが重要です。

### インスタンスストアとは

インスタンスストアは、EC2 インスタンスがホストされている**物理サーバーに直接接続された一時的なブロックストレージ**です。  
これは、高性能な SSD または HDD で構成され、非常に高いディスク I/O 性能と低レイテンシを提供しますが、**永続性がない**という決定的な特徴を持っています。

| 特徴                   | 説明                                                                                                                                                                                                          | EBS との比較 (重要な違い)                                                                                                        |
| :--------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :------------------------------------------------------------------------------------------------------------------------------- |
| **永続性 (Ephemeral)** | インスタンスの**停止、終了、または基盤となる物理ホストの障害**が発生すると、インスタンスストア上のデータは**すべて失われます**。 インスタンスの再起動ではデータが保持される場合がありますが、保証されません。 | EBS はインスタンスが停止・終了してもデータが永続的に保持されます。                                                               |
| **物理的な配置**       | インスタンスが起動している**物理ホストサーバーに直接接続**されています。 ネットワーク越しに接続される EBS とは異なり、ローカルストレージとして動作します。                                                    | EBS はネットワーク経由でアタッチされるストレージサービスです。                                                                   |
| **I/O 性能**           | 非常に高い I/O 性能と低レイテンシを提供します。 これは、物理ホストに直接接続されているためです。                                                                                                              | EBS も高性能ですが、インスタンスストアの方が物理的な距離が近いため、一般的にレイテンシが低く、スループットが高い傾向があります。 |
| **容量**               | インスタンスタイプによって、インスタンスストアの有無、容量、およびタイプ (SSD/HDD) が決まっています。 すべてのインスタンスタイプに付属するわけではありません。                                                | EBS は必要な容量を柔軟にプロビジョニングできます。                                                                               |
| **コスト**             | インスタンスストアの利用料金は、選択したインスタンスタイプ料金に含まれており、追加料金は発生しません。                                                                                                        | EBS は、プロビジョニングされた容量と IOPS に対して別途料金が発生します。                                                         |
| **データ保護**         | 永続性がないため、データのバックアップや耐障害性対策はアプリケーション層で考慮する必要があります。 EBS スナップショットのような機能はありません。                                                             | EBS はスナップショット機能を提供し、データ保護が容易です。                                                                       |

### インスタンスストアの主なユースケース

インスタンスストアの特性を理解した上で、以下のようなワークロードで効果的に活用できます。

- **一時的なキャッシュ、スクラッチスペース**:  
  Web サーバーのセッション情報、データベースのテンポラリファイル、メディア処理の一時ファイルなど、永続性が不要で高速なアクセスが求められる一時的なデータを保存する場所として最適です。
- **レプリカを持つデータベース**:  
  データベースが複数のインスタンス間でデータを複製 (レプリケーション) している場合、各インスタンスのインスタンスストアをデータのレプリカとして利用できます。 インスタンス障害時には別のレプリカが引き継ぐため、永続性は問題になりません。  
  例: Cassandra, MongoDB などの NoSQL データベース、Redis などのインメモリデータベース。
- **分散処理のテンポラリデータ**:  
  Hadoop の HDFS (Hadoop Distributed File System) など、データがクラスター全体に分散して冗長性を持つような処理において、一時的な作業スペースや中間結果の保存に利用されます。
- **高パフォーマンス計算**:  
  科学技術計算やシミュレーションなど、大量のデータセットを高速に処理し、結果を別の永続ストレージに保存するようなワークロード。

### インスタンスストア利用上の注意点

- **データの永続性**:  
  最も重要な点です。 インスタンス停止や終了、基盤ホストの障害によりデータが失われることを常に意識し、必要なデータは EBS、S3、または別のインスタンスストアを持つインスタンスに冗長化して保存するか、定期的に永続ストレージに同期する必要があります。
- **インスタンスタイプの選択**:  
  インスタンスストアは、特定のインスタンスタイプ (例: `M5d`, `C5d`, `R5d`, `I3`, `D2` など、通常は名前に 'd' が付くものが多い) にのみ付属します。 インスタンスタイプを選ぶ際に、インスタンスストアの有無と容量を確認してください。
- **バックアップと復旧**:  
  インスタンスストア上のデータは自動的にバックアップされません。 アプリケーションレベルでのバックアップや冗長化の仕組みを設計する必要があります。
- **寿命**:  
  インスタンスが終了するとインスタンスストアも消滅します。 AMI を作成する際、ルートボリュームは EBS であればスナップショットとして保存されますが、インスタンスストアのデータは AMI には含まれません。

インスタンスストアは、その高速性とコスト効率から特定のワークロードでは非常に有効な選択肢となります。  
しかし、永続性がないという特性を深く理解し、アプリケーションの設計や運用において適切なデータ保護戦略を講じることが不可欠です。

---

## EBS とインスタンスストアどちらを選択するか

Amazon EC2 インスタンスのストレージとして、Amazon EBS (Elastic Block Store) とインスタンスストアという 2 つの主要な選択肢があることを、これまでのセクションで解説しました。  
両者ともにブロックストレージですが、その特性、性能、永続性、およびコストにおいて決定的な違いがあります。  
このセクションでは、これらの違いを明確にし、あなたのアプリケーションやワークロードの要件に基づいて、どちらのストレージを選択すべきか、あるいは両者をどのように組み合わせて利用すべきかについての意思決定ガイドラインを提供します。

### EBS とインスタンスストアの比較

まず、両者の主要な特性を比較表で確認しましょう。

| 特性                            | Amazon EBS (Elastic Block Store)                                                                                 | インスタンスストア (Instance Store)                                                                                                                            |
| :------------------------------ | :--------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **永続性**                      | **永続的**です。 インスタンスの停止や終了後もデータは保持されます。                                              | **一時的**です。 インスタンスの停止、終了、基盤ホストの障害でデータは失われます。 インスタンスの再起動ではデータが保持される場合がありますが、保証されません。 |
| **物理的な配置**                | EC2 インスタンスとは別に、ネットワーク経由で接続されるストレージサービスです。                                   | EC2 インスタンスが稼働する**物理ホストに直接接続**されたストレージです。                                                                                       |
| **I/O 性能**                    | 高性能 SSD (gp3, io2) タイプは高い IOPS とスループットを提供します。 ネットワークレイテンシは発生します。        | 非常に高い IOPS とスループット、**低レイテンシ**を提供します。 物理的な距離が近いためです。                                                                    |
| **容量の柔軟性**                | 必要な容量を柔軟にプロビジョニングし、後から動的に変更できます。                                                 | インスタンスタイプによって、容量と有無、タイプ (SSD/HDD) が固定されています。                                                                                  |
| **コスト**                      | プロビジョニングされた容量と、io1/io2 の場合はプロビジョニングされた IOPS に対して別途料金が発生します。         | インスタンスタイプの料金に含まれており、追加料金は発生しません。                                                                                               |
| **データ保護**                  | スナップショット機能により、簡単にバックアップと復元が可能です。 自動複製や暗号化機能も提供されます。            | データの永続性がないため、バックアップ機能はありません。 アプリケーション層での冗長化や永続ストレージへの同期が必要です。                                      |
| **アベイラビリティゾーン (AZ)** | 同じ AZ 内の任意のインスタンスにアタッチできます。 スナップショットは AZ 非依存です。                            | インスタンスが起動している AZ に固定され、その物理ホストに紐付きます。                                                                                         |
| **主な用途**                    | ルートボリューム、リレーショナルデータベース、NoSQL データベース、ファイルサーバー、重要なアプリケーションデータ | キャッシュ、スクラッチスペース、分散データベースのレプリカ、Hadoop HDFS など、一時的で高速なアクセスが必要なデータ                                             |

### どちらを選択すべきか：意思決定ガイドライン

アプリケーションの要件に応じて、適切なストレージを選択することが重要です。

#### EBS を選ぶべきケース

- **データ永続性が最優先の場合**:  
  OS のルートボリューム、データベースのデータファイル、重要なアプリケーションデータ、ログファイルなど、インスタンスが停止または終了してもデータを失いたくない場合。
- **バックアップと災害復旧が容易に必要となる場合**:  
  EBS スナップショットにより、シンプルな手順でデータのバックアップと、障害時の復旧、または別 AZ への復元が可能です。
- **柔軟な容量・性能変更が必要な場合**:  
  gp3 ボリュームのように、容量や IOPS/スループットを動的に変更できる柔軟性が必要な場合。
- **アベイラビリティゾーンをまたいだデータの利用**:  
  スナップショットを利用して、ある AZ のデータを別の AZ で新しいボリュームとして復元したい場合。
- **インスタンスタイプに制約がない場合**:  
  基本的にすべてのインスタンスタイプで EBS ボリュームを利用できます。

#### インスタンスストアを選ぶべきケース

- **極めて高い I/O 性能と低レイテンシが必須の場合**:  
  キャッシュサーバー (Memcached, Redis)、高速なスクラッチスペース、リアルタイム分析など、EBS よりもさらに高速なディスクアクセスが必要な場合。
- **データが一時的であり、永続性が必要ない場合**:  
  アプリケーションの一時ファイル、バッチ処理の中間データ、テストデータなど、インスタンスの停止/終了で失われても問題ないデータ。
- **アプリケーション層でデータの冗長化や永続化が担保されている場合**:  
  Cassandra や MongoDB などの分散データベースで、データが複数のノード間で複製されており、単一ノードのインスタンスストアのデータ損失が全体に影響しない設計の場合。 Hadoop HDFS のような分散ファイルシステムもこれに該当します。
- **コスト効率を最大化したい場合 (一時データに対して)**:  
  インスタンスタイプの料金にストレージ費用が含まれるため、永続性が不要な高速データに対しては追加コストがかかりません。

#### EBS とインスタンスストアを併用するケース

多くの実稼働環境では、両者のメリットを活かすために併用されることが一般的です。

- **ルートボリューム**: **EBS** (OS の永続性のため、通常 gp3)。
- **重要なアプリケーションデータ/データベース**: **EBS** (データの永続性、スナップショットによる保護のため、gp3 または io2)。
- **キャッシュ/一時ファイル/ログ**: **インスタンスストア** (高速アクセスと低レイテンシのため、ただし、重要なログは EBS または S3 に定期的に同期)。
- **分散データベースのレプリカデータ**: **インスタンスストア** (高速性とコスト効率のため、アプリケーションで冗長性を担保)。

### まとめ

EBS とインスタンスストアの選択は、アプリケーションのデータ永続性要件、パフォーマンス要件、およびコスト要件に深く依存します。  
**永続性が必要な場合は EBS**、**極めて高い I/O 性能と低レイテンシが必要で、かつデータが一時的またはアプリケーションで冗長化されている場合はインスタンスストア**、と大まかに区別できます。  
これらの違いを理解し、ワークロードに最適なストレージ戦略を立てることで、コスト効率とパフォーマンスのバランスの取れた EC2 環境を構築できます。

---

## S3 や EFS との違い

Amazon EC2 インスタンスに直接関連するストレージとして Amazon EBS とインスタンスストアを学びましたが、AWS のストレージサービスはこれだけではありません。  
Amazon S3 (Simple Storage Service) と Amazon EFS (Elastic File System) は、EBS やインスタンスストアとは根本的に異なる特性を持つストレージサービスであり、それぞれ独自のユースケースを持っています。  
これらの違いを理解することは、システム設計において最適なストレージソリューションを選択するために不可欠です。

### 各ストレージサービスの概要

改めて、主要な AWS ストレージサービスを分類と共にご紹介します。

- **ブロックストレージ**:
  - **Amazon EBS**: EC2 インスタンスにネットワーク経由でアタッチされる、永続的な仮想ディスクです。 OS からは通常の HDD や SSD と同じように扱われます。
  - **インスタンスストア**: EC2 インスタンスが動作する物理ホストに直接接続された、一時的なストレージです。 非常に高速ですが、インスタンスのライフサイクルに依存し、データは永続的ではありません。
- **オブジェクトストレージ**:
  - **Amazon S3**: データを「オブジェクト」として保存する、非常にスケーラブルで耐久性の高いストレージサービスです。 HTTP(S) プロトコル経由でアクセスし、ファイルシステムとは異なる概念でデータを管理します。
- **ファイルストレージ**:
  - **Amazon EFS**: 複数の EC2 インスタンスから同時にアクセスできる、フルマネージドな共有ファイルシステムです。 NFS (Network File System) プロトコルを介してマウントされ、OS からは通常のネットワークファイルシステムとして扱われます。

### 主要な比較ポイント

これらのストレージサービスは、主に「アクセス方法」「データ形式」「永続性・可用性・スケーラビリティ」「パフォーマンス特性」「主なユースケース」において大きく異なります。

#### 1. アクセス方法とデータ形式

- **EBS / インスタンスストア**:
  - EC2 インスタンスの OS から、`/dev/xvdf` や `C:` ドライブのような**ブロックデバイス**として直接アクセスします。 使用するには OS レベルでファイルシステム (ext4, XFS, NTFS など) をフォーマットしてマウントする必要があります。
- **S3**:
  - HTTP(S) プロトコルを介した**API**でアクセスします。 データは「バケット」と呼ばれるコンテナ内に「オブジェクト」として保存され、キー (ファイル名のようなもの) で識別されます。 ファイルシステムのような階層構造は論理的なものであり、物理的にはフラットな構造です。
- **EFS**:
  - EC2 インスタンスやオンプレミスサーバーから、**NFSv4.0/4.1 プロトコル**を介してマウントします。 OS からは通常のファイルシステム (ディレクトリ構造、ファイル、パーミッションなど) として扱われ、複数のインスタンスが同時に読み書きできます。

#### 2. 永続性、可用性、スケーラビリティ

- **EBS**:
  - **永続的** (インスタンス停止/終了後もデータ保持)。 **単一 AZ 内**で自動複製され、高い耐久性と可用性を提供します。 容量と性能は柔軟にスケールアップ/ダウン可能です。
- **インスタンスストア**:
  - **一時的** (インスタンス停止/終了でデータ消失)。 **単一物理ホスト内**に存在し、高可用性や耐久性はアプリケーション層で考慮する必要があります。 容量はインスタンスタイプに固定です。
- **S3**:
  - **非常に高い耐久性** (99.999999999%) と **高可用性**。 データは**複数の AZ**にわたって自動的に複製されます。 事実上、オブジェクト数と容量は**無制限**にスケールします。
- **EFS**:
  - **高い耐久性** (99.999999999%) と **高可用性**。 データは**複数の AZ**に保存され、AZ 障害時も利用可能です。 容量は自動的に**ペタバイト規模までスケーリング**します。

### 主要ストレージサービスの比較表

| 特性                 | Amazon EBS (ブロックストレージ)                                | インスタンスストア (ブロックストレージ)                               | Amazon S3 (オブジェクトストレージ)                                                                | Amazon EFS (ファイルストレージ)                                           |
| :------------------- | :------------------------------------------------------------- | :-------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------ | :------------------------------------------------------------------------ |
| **データの永続性**   | 永続的                                                         | 一時的 (インスタンス停止/終了で消失)                                  | 永続的 (高い耐久性)                                                                               | 永続的 (高い耐久性)                                                       |
| **アクセス方法**     | EC2 インスタンスの OS からブロックデバイスとしてマウント       | EC2 インスタンスの OS からブロックデバイスとしてマウント              | HTTP(S) API 経由 (SDK, CLI, Web コンソール)                                                       | NFS プロトコル経由でマウント (ファイルシステムとして)                     |
| **アクセス元**       | **単一**の EC2 インスタンスからのみ                            | **単一**の EC2 インスタンスからのみ                                   | インターネット経由で**どこからでも** (EC2, Lambda, オンプレミスなど)                              | **複数**の EC2 インスタンスやオンプレミスから同時アクセス可能             |
| **データ形式**       | ブロック単位 (ファイルシステムが必要)                          | ブロック単位 (ファイルシステムが必要)                                 | オブジェクト (キーバリュー形式、メタデータ付加)                                                   | ファイルシステム (ディレクトリ、ファイル、パーミッション)                 |
| **スケーラビリティ** | ボリューム単位で容量・性能を増減                               | インスタンスタイプで固定                                              | 無制限にスケール (ペタバイト〜エクサバイト級)                                                     | 自動的にペタバイト規模までスケール                                        |
| **可用性/耐久性**    | 高い (AZ 内で複製)                                             | 低い (物理ホスト障害でデータ消失)                                     | 非常に高い (複数 AZ に複製)                                                                       | 非常に高い (複数 AZ に複製)                                               |
| **パフォーマンス**   | IOPS, スループットをタイプ・容量で調整。ネットワーク遅延あり。 | 非常に高い IOPS, スループット、低レイテンシ (物理ホスト直結)          | アクセス頻度に応じて変動。大規模アクセス向け。                                                    | スループット、IOPS は自動的にスケール。レイテンシは EBS より高め。        |
| **主なユースケース** | OS のルートボリューム、リレーショナル DB、重要な AP データ     | キャッシュ、スクラッチスペース、分散 DB のレプリカ (永続性不要な場合) | 静的 Web サイト、バックアップ、アーカイブ、データレイク、ビッグデータ分析、メディアコンテンツ配信 | 複数の EC2 からの共有データ、Web コンテンツ、開発環境、コンテナストレージ |
| **課金形態**         | プロビジョニングされた容量、IOPS、スナップショット容量         | インスタンスタイプ料金に含まれる                                      | 保存容量、リクエスト数、データ転送量、各種管理機能                                                | 保存容量、スループット                                                    |

### 適切なストレージの選択

- **EBS**は、特定の EC2 インスタンスに紐付けられ、そのインスタンスの OS やアプリケーションにとって「ディスクドライブ」として機能する**永続的な高速ストレージ**が必要な場合に選択します。
- **インスタンスストア**は、データの永続性は不要だが、**極めて高い I/O 性能と低レイテンシ**が一時的に必要な場合に選択します。
- **S3**は、ファイルシステム形式ではなく**オブジェクトとしてデータを保存**し、インターネット経由で**どこからでも大量のデータを高い耐久性と低コストで利用したい**場合に選択します。
- **EFS**は、**複数の EC2 インスタンスから同時にアクセスできる共有ファイルシステム**が必要な場合に選択します。

これらのサービスはそれぞれ異なるメリットとユースケースを持つため、アプリケーションの要件 (永続性、共有性、性能、アクセスパターン、コストなど) を考慮して、最適なものを選択するか、あるいは組み合わせて利用することが重要です。

---

## EC2 とネットワーク

Amazon EC2 インスタンスは、単独で存在するのではなく、AWS クラウド内の仮想ネットワーク環境に配置され、そこを通じて外部との通信や、他の AWS サービスとの連携を行います。  
この仮想ネットワーク環境の基盤となるのが、Amazon VPC (Virtual Private Cloud) です。  
VPC を理解することは、EC2 インスタンスのセキュリティ、可用性、および接続性を適切に設計する上で極めて重要です。

### 1. Amazon VPC (Virtual Private Cloud)

Amazon VPC は、AWS クラウド内に論理的に分離された、お客様専用のプライベートな仮想ネットワーク空間を構築するサービスです。  
EC2 インスタンスは、必ずこの VPC 内に起動されます。

- **論理的な隔離**:  
  他の AWS アカウントの VPC や、他のユーザーのインスタンスから完全に隔離された環境を提供します。
- **IP アドレス範囲の定義**:  
  VPC の CIDR (Classless Inter-Domain Routing) ブロック (例: `10.0.0.0/16`) を指定することで、VPC 内で使用されるプライベート IP アドレス範囲を自由に定義できます。
- **ネットワークリソースの完全な制御**:  
  IP アドレス範囲、サブネット、ルーティングテーブル、ネットワークゲートウェイ、セキュリティ設定などを完全に制御できます。

### 2. サブネット (Subnet)

VPC は、さらに一つまたは複数の「サブネット」に分割されます。  
サブネットは、VPC の IP アドレス範囲をさらに小さな範囲に分割したもので、EC2 インスタンスはこのサブネット内に配置されます。

- **アベイラビリティゾーン (AZ) との関連**:  
  各サブネットは、必ず特定の**アベイラビリティゾーン (AZ)** に関連付けられます。 これにより、AZ を跨いだ冗長構成が可能になります。
- **パブリックサブネットとプライベートサブネット**:
  - **パブリックサブネット**: インターネットゲートウェイへのルートを持つサブネットです。 このサブネット内のインスタンスは、パブリック IP アドレスを持つことでインターネットと直接通信できます。
  - **プライベートサブネット**: インターネットゲートウェイへの直接ルートを持たないサブネットです。 このサブネット内のインスタンスは、インターネットからの直接アクセスはできませんが、NAT ゲートウェイなどを経由してインターネットへアクセスすることは可能です。 データベースサーバーや内部アプリケーションサーバーなど、外部からの直接アクセスを避けたい場合に利用されます。

### 3. IP アドレス

EC2 インスタンスには、主に以下の種類の IP アドレスが関連付けられます。

| IP アドレスの種類            | 説明                                                                                                    | 特徴                                                                                                                                                     |
| :--------------------------- | :------------------------------------------------------------------------------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **プライベート IP アドレス** | VPC の内部でのみ使用される IP アドレスです。 サブネットの CIDR ブロックから割り当てられます。           | インスタンスが VPC 内部で互いに通信するために使用されます。 インスタンスの停止/起動で変更されることはありませんが、再作成されると変わることがあります。  |
| **パブリック IP アドレス**   | インターネットから EC2 インスタンスにアクセスするために使用される、グローバルに一意な IP アドレスです。 | インスタンスをインターネットに公開する場合に自動的に割り当てられます。 インスタンスの**停止/起動で変更される**ため、動的な IP アドレスです。             |
| **Elastic IP (EIP)**         | AWS アカウントに紐付けられる、静的でグローバルに一意なパブリック IP アドレスです。                      | インスタンスの停止/起動で変更されず、いつでも別のインスタンスに再割り当てできます。 頻繁な IP 変更を避けたい Web サーバーや DNS レコードに利用されます。 |

### 4. ネットワークインターフェース (ENI)

EC2 インスタンスは、一つまたは複数の ENI (Elastic Network Interface) を介して VPC に接続されます。  
ENI は仮想的なネットワークカードであり、IP アドレス、MAC アドレス、セキュリティグループなど、ネットワーク関連の属性が関連付けられます。

### 5. ゲートウェイ

VPC 内のインスタンスが VPC 外 (インターネット、他の VPC、オンプレミスなど) と通信するためにゲートウェイが使用されます。

| ゲートウェイの種類                   | 説明                                                                                                                                     | 主な役割                                                                                                                                       |
| :----------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------- |
| **インターネットゲートウェイ (IGW)** | VPC とインターネット間の通信を可能にするゲートウェイです。 パブリックサブネットがインターネットにアクセスするために必要です。            | パブリックサブネットからインターネットへのアウトバウンド通信、およびインターネットからパブリックサブネットへのインバウンド通信を可能にします。 |
| **NAT ゲートウェイ (NAT Gateway)**   | プライベートサブネット内のインスタンスが、インターネットから直接アクセスされることなく、アウトバウンド通信を行うためのゲートウェイです。 | プライベートサブネット内のデータベースサーバーなどが、OS のアップデートや外部 API へのアクセスを行う際に利用します。                           |

### 6. ルーティングテーブル (Route Table)

ルーティングテーブルには、ネットワークトラフィックの転送ルールが記述されており、サブネットに関連付けられます。  
これにより、特定の IP アドレス範囲へのトラフィックがどのゲートウェイやネットワークインターフェースを経由して送信されるかが定義されます。

### 7. セキュリティ

EC2 インスタンスのネットワークセキュリティは、主に以下の 2 つの仮想ファイアウォール機能によって制御されます。

| セキュリティ機能                          | 適用レイヤー       | 評価対象                     | ルール                                                                                    | 状態管理                                                                  |
| :---------------------------------------- | :----------------- | :--------------------------- | :---------------------------------------------------------------------------------------- | :------------------------------------------------------------------------ |
| **セキュリティグループ (Security Group)** | インスタンスレベル | インスタンスへのトラフィック | 許可ルールのみ。 デフォルトではすべてのインバウンドを拒否、すべてのアウトバウンドを許可。 | **ステートフル** (インバウンド許可でアウトバウンドも自動許可)             |
| **ネットワーク ACL (NACL)**               | サブネットレベル   | サブネットへのトラフィック   | 許可ルールと拒否ルール。 デフォルトではすべてを許可。                                     | **ステートレス** (インバウンド許可とアウトバウンド許可は個別に設定が必要) |

セキュリティグループは、各 EC2 インスタンスに適用されるため、よりきめ細やかなアクセス制御が可能です。  
NACL は、サブネット全体のトラフィックを制御するため、より広範囲のセキュリティポリシーを適用する場合に利用されます。

これらのネットワーク構成要素を適切に設計・設定することで、EC2 インスタンスを安全かつ効率的に運用し、外部サービスやユーザーとのスムーズな通信を実現することができます。

---
