# AWS CloudWatch
## AWS CloudWatchとは？

![linuxロゴ](../img/CloudWatch.png)

Amazon CloudWatchは、アマゾン ウェブ サービス（AWS）が提供する**モニタリングサービス**です。  
AWS上で稼働する仮想サーバー、ストレージ、データベースといったリソースやアプリケーションのパフォーマンスをリアルタイムに監視することができます。

CloudWatchは、システムの監視に必要な機能の集合体であり、  
**`収集`** **`モニタリング`**  **`アクション`** **`分析`**  という4つのステージで構成されています。  

![linuxロゴ](../img/stage.png)

ログ、メトリクス、イベントといった運用データを収集し、それらを自動化されたダッシュボードで可視化することでAWS環境全体の健全性を一元的に把握し、問題解決や運用最適化に役立てます。

CloudWatchには無料利用枠が設定されており、それを超えた分は利用する機能やデータ量に応じた従量課金制となっています。  

まずは、4つのステージと代表的な機能について見ていきましょう。

---
## 各ステージと代表的な機能
CloudWatchの機能は、システムの可観測性を実現するための4つのステージに分かれています。

## 1. 収集 (Collect)
このステージでは、AWSリソースやアプリケーションからパフォーマンスデータ（メトリクス）と活動記録（ログ）を収集します。  
これがモニタリングと分析の基礎となります。

### CloudWatch Metrics (メトリクス)
メトリクスとは、リソースのパフォーマンスや使用状況に関する時系列の数値データです。  
例えば、EC2インスタンスのCPU使用率、RDSデータベースの書き込み回数、ネットワークトラフィックなどが該当します。

**目的:**  
システムのパフォーマンスと効率性を測定し、リソースの使用状況を監視します。  
これにより、パフォーマンスの問題を迅速に特定し、トラブルシューティングや最適化を効果的に行えます。

**特徴:**  
数値データであるため、時間経過による変化の追跡や、事前に定義したしきい値を超過した際にアラート（アラーム）を設定することが可能です。  
また、機械学習を用いた異常検出機能もあり、予期せぬパターンの変化を自動的に識別できます。

### CloudWatch Logs (ログ)
ログとは、システムやアプリケーションの動作、エラー、アクセス情報といったイベントに関する記録です。  
CloudWatch Logsは、これらのログを一元的に収集、保存、監視、検索する仕組みです。

**目的:**  
問題発生時の原因特定やセキュリティ分析のために利用します。　　
ログを調査することで問題の根本原因を迅速に突き止め、解決に導くことができます。

**特徴:**  
特定のエラーメッセージやパターンをリアルタイムで監視したり、後から特定の期間や条件でログを検索・分析したりすることに適しています。収集できるログには、AWSサービスがネイティブに発行するVended Logsや、ユーザー自身のアプリケーションから出力されるCustom Logsなどがあります。

## 2. モニタリング (Monitor)
収集したメトリクスやログを可視化し、システムの状態をリアルタイムで直感的に把握するためのステージです。

### CloudWatch Dashboards (ダッシュボード)
ダッシュボードは、重要なメトリクスやログクエリの結果をグラフや数値などのウィジェットとして一つの画面に集約できるカスタマイズ可能なビューです。

**目的:**  
重要なデータを一目で確認できるようにし、情報の迅速な把握を可能にします。  
複数のリージョンやアカウントにまたがるリソースの状態も一元表示でき、システム全体のパフォーマンスを直感的に把握できます。

**特徴:**  
ウィジェットの配置や種類を自由にカスタマイズできるため、チームや用途ごとのニーズに合わせた監視画面を作成できます。  
グラフやチャートによってデータの変動や傾向を視覚的に捉えるトレンド分析にも優れています。

### CloudWatch Alarms (アラーム)
アラームは特定のメトリクスが定義した条件（しきい値）を満たした際に、状態を変化させ通知やアクションを実行する仕組みです。

**目的:**  
問題や異常が発生した際の早期警告や、障害につながる前の潜在的リスクの特定を目的とします。  
24時間365日の継続的な自動監視を実現します。

**特徴:**  
「EC2インスタンスのCPU使用率が5分間80%を超え続けたらアラームを発砲」のように、ユーザーが柔軟にトリガー条件を設定できます。
アラームの状態変化をきっかけに、後述の「アクション」を自動的に実行させることが可能です。

## 3. アクション (Act)
モニタリングによって検知されたイベント（主にアラームの状態変化）に応じて、自動的な対応を実行するステージです。これにより、運用を自動化し、迅速な問題解決を実現します。

### CloudWatch Events (現: Amazon EventBridge) との連携
CloudWatch Eventsは、AWSリソースの状態変化やAPIコール、設定したスケジュールといったイベントを検知し、それに応じてターゲット（Lambda関数、SNSトピックなど）を呼び出すサービスです。（現在は後継サービスであるAmazon EventBridgeに機能が統合・拡張されています。）

**目的:**  
「何かが起きたら、何かを実行する」というルールベースのアクションを自動化します。

**特徴:**  
「EC2インスタンスが停止したときにLambda関数を実行する」「毎日特定の時刻にバッチ処理を開始する」など、  
柔軟なルール設定が可能です。CloudWatchアラームと連携させることで、以下のような具体的なアクションを実現します。
**通知:**  
アラーム発報時にAmazon SNSを介して、担当者へメールやチャットで通知する。
**自動復旧:**  
EC2アクションにより、インスタンスの自動再起動や停止、復旧を行う。
**オートスケーリング:**  
AWS Auto Scalingと連携し、負荷に応じてサーバーの台数を自動で増減させる。

## 4. 分析 (Analyze)
収集した大量のデータから、トラブルシューティングの効率化や、ビジネス・運用に関する深い洞察を得るためのステージです。

### CloudWatch Logs Insights
CloudWatch Logs Insightsは、  
CloudWatch Logsに収集された膨大なログデータに対して、インタラクティブに検索と分析を実行できる強力なサービスです。

**目的:**  
膨大なログデータの中から特定のパターンやトレンドを迅速に検索・分析し、システムの安定稼働やセキュリティ分析に役立てます。

**特徴:**  
 独自のクエリ構文を使用し、SQLのように柔軟なログデータの集計や抽出が可能です。  
 サーバーの複雑な設定をせず、収集したログをリアルタイムで分析し、その結果をグラフなどで可視化できます。これにより、問題調査の時間を大幅に短縮します。

**その他:**  
メトリクスにおいても、複数のメトリクスを数式でリアルタイムに加工・分析するMetrics Mathや、最大15ヶ月間のデータ保持により長期的なトレンド分析が可能です。

---
## メリット・デメリット

### メリット

#### **導入と運用の手間が大幅に削減できる（導入が容易）**
CloudWatchはAWSの**マネージドサービス**であるため、利用者は監視サーバーの構築や監視ソフトウェアのインストール、バージョンアップ、パッチ適用といった**面倒なインフラ管理から解放**されます。  
従来、監視システムを導入するには、サーバーのスペック選定、OSのセットアップ、監視ツールのインストールと設定、そして継続的なメンテナンスが必要でした。しかしCloudWatchでは、AWSアカウントがあればすぐに利用を開始でき、インフラの維持管理をAWSに任せることができます。これにより、開発者や運用担当者は**本来注力すべきアプリケーションの開発やパフォーマンス改善に集中**できます。


#### **AWSエコシステムとの深くシームレスな連携（優れた連携性）**
CloudWatchの最大の強みは、AWSのサービス群と深く統合されている点です。EC2インスタンスを作成すればCPU使用率などの基本的なメトリクスが、RDSデータベースを起動すればディスクI/Oや接続数といったメトリクスが、**特別な設定をしなくても自動的にCloudWatchに送信**され始めます。これは、監視が「後から追加する機能」ではなく、「サービスに標準で組み込まれた機能」であることを意味します。  
さらに、サービス間の連携も強力です。例えば、「メトリクスの閾値超過（CloudWatch Alarms）→通知を送信（Amazon SNS）→サーバー台数を自動で増やす（AWS Auto Scaling）→処理を実行（AWS Lambda）」といった一連のワークフローを簡単に構築できます。このように、**イベントを起点とした自動化（イベント駆動型アーキテクチャ）**を容易に実現できるため、手作業を減らし、迅速で信頼性の高い運用が可能になります。


#### **システム全体を俯瞰できる統合的な監視（一元的な監視）**
現代のアプリケーションは、仮想サーバー（EC2）、データベース（RDS）、APIゲートウェイ（API Gateway）、サーバーレス関数（Lambda）など、多数のコンポーネントで構成されています。CloudWatchは、これらの**多岐にわたるAWSリソースを横断的に一つのプラットフォームで監視**することができます。  
これにより、運用チームは複数の監視ツールを使い分ける必要がなくなります。アプリケーションのログ、インフラのパフォーマンスメトリクス、APIの実行回数などを**単一のダッシュボードで関連付けて可視化**できるため、問題が発生した際に「どこで何が起きているのか」を迅速に把握し、根本原因の特定を効率化できます。この「シングル・ペイン・オブ・グラス（単一のガラス板）」による監視は、複雑なシステム全体の健全性を維持する上で極めて重要です。


### デメリット

#### **AWS外の環境では追加の手間が発生する（オンプレミス監視には追加設定が必要）**
CloudWatchはAWSネイティブのサービスとして設計されているため、AWSリソースであれば多くが自動的に、または簡単な設定で監視を開始できます。  
しかし、自社のデータセンターで運用している**オンプレミスサーバーや、他のクラウドサービス上のサーバーを監視**する場合、この手軽さは適用されません。  
これらの環境を監視するには、対象の各サーバーに**CloudWatch Agent**というソフトウェアを手動でインストールし、収集するメトリクスやログファイルを細かく定義する設定ファイルを作成・配布する必要があります。  
エージェントのバージョン管理や、AWSへデータを送信するための認証情報（IAMロールやキー）の管理も必要となり、**AWS内での監視に比べて運用上のオーバーヘッドが増加**します。


#### **標準ではデータの保持期間に上限がある（メトリクスの保存期間）**
CloudWatchは、収集したメトリクスデータを**デフォルトで15ヶ月間**保存します。この期間は、短期的なトラブルシューティングや直近のパフォーマンス分析には十分です。しかし、数年にわたる長期的な傾向分析、将来のキャパシティプランニング、あるいは規制やコンプライアンス要件で**複数年のデータ保持が義務付けられている場合**、この15ヶ月という上限は制約となり得ます。15ヶ月を超えてデータを保持するためには、**CloudWatch Metric Streams**という機能を使ってメトリクスデータをAmazon S3などの永続的なストレージサービスへエクスポートする仕組みを別途構築する必要があります。  
これには、Amazon Kinesis Data Firehoseなどの追加サービスの設定とコストが伴い、アーキテクチャが少し複雑になります。


#### **利用量に応じてコストが想定以上にかかる可能性がある（コストへの注意）**
CloudWatchには無料利用枠がありますが、本番環境で本格的に利用すると、**様々な要因でコストが積み上がる**点に注意が必要です。特にコストに影響しやすいのは以下の項目です。
**カスタムメトリクス**:  
自社アプリケーションの指標などを詳細に監視しようとすると、メトリクスの数が増え、コストが上昇します。特に1分未満間隔でデータを送信する「高解-像度メトリクス」は高価です。
**ログのデータ量**:  
アプリケーションが出力するログの量が膨大になると、データの**取り込み（Ingestion）**と**保管（Storage）**の両方で料金が発生します。ログの保持期間を長く設定すれば、その分ストレージコストも増加し続けます。
**Logs Insightsのクエリ**:  
Logs Insightsは非常に強力な分析ツールですが、クエリを実行する際に**スキャンしたデータ量**に応じて課金されます。  
大規模なロググループに対して無計画に広範囲なクエリを頻繁に実行すると、意図せず高額な請求につながる可能性があります。これらの料金体系を理解し、ログの保持期間を適切に設定したり、ダッシュボードでのメトリクス表示を最適化したりといった**コスト管理の意識**が求められます。

---
## まとめ
Amazon CloudWatchは、AWS環境における **「収集」「モニタリング」「アクション」「分析」** の4つのステージを網羅するために必要な監視ツールです。

AWSのマネージドサービスであるため導入が容易で、多様なAWSサービスとシームレスに連携できる点が大きな強みです。ログ収集からメトリクス分析、アラーム設定、イベント管理まで、多岐にわたる機能を提供しており、これらを適切に活用することで、システムのパフォーマンス追跡、最適化、そして迅速な障害対応が可能になります。

一方で、利用量に応じたコストやデータ保持期間には注意が必要ですが、AWSを利用する上でシステムの安定性と信頼性を高めるためには、非常に強力で便利なサービスと言えるでしょう。