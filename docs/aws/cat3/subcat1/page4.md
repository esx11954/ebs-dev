# EC2とネットワーク

---

Amazon EC2インスタンスは、単独で存在するだけでは十分ではありません。  
アプリケーションが機能するためには、インターネットや他のAWSサービス、オンプレミス環境などと安全かつ効率的に通信できるネットワーク環境が不可欠です。  
AWSでは、この基盤としてAmazon Virtual Private Cloud (VPC) を提供し、その上で様々なネットワークサービスがEC2インスタンスの通信を制御・最適化します。  

### 1. Amazon Virtual Private Cloud (VPC)

Amazon VPCは、AWSクラウド内に構築する、お客様専用の論理的に分離された仮想ネットワークです。  
EC2インスタンスは必ずVPC内で起動され、IPアドレス範囲、サブネット、ルートテーブル、ネットワークゲートウェイなどを自由に定義できます。  

#### 1.1. サブネット

VPCは、さらに「サブネット」と呼ばれる小さなネットワークに分割されます。  
サブネットは特定のIPアドレス範囲を持ち、必ず1つのアベイラビリティゾーン (AZ) 内に配置されます。  

*   **パブリックサブネット:** インターネットゲートウェイを経由して、インターネットと直接通信できるサブネットです。  
    Webサーバーなど、インターネットからのアクセスが必要なインスタンスを配置します。  
*   **プライベートサブネット:** インターネットゲートウェイを経由せず、直接インターネットと通信できないサブネットです。  
    データベースサーバーやアプリケーションサーバーなど、セキュリティを重視し、インターネットからの直接アクセスを避けたいインスタンスを配置します。  
    インターネットへのアウトバウンド通信が必要な場合は、NAT Gatewayなどを利用します。  

#### 1.2. ルートテーブル

ルートテーブルは、サブネットからのネットワークトラフィックがどこにルーティングされるかを定義するルールセットです。  
インターネットゲートウェイ、NAT Gateway、VPCピアリング接続などへの経路を指定します。  

#### 1.3. ゲートウェイ

*   **インターネットゲートウェイ (IGW):**  
    VPCとインターネット間の通信を可能にするコンポーネントです。  
    パブリックサブネット内のインスタンスがインターネットと通信するために必要です。  
*   **NAT Gateway / NATインスタンス:**  
    プライベートサブネット内のインスタンスが、インターネットからのインバウンド接続を受け入れることなく、インターネット（または他のAWSサービス）へアウトバウンド接続を行うことを可能にするサービスです。  
    NAT Gatewayはフルマネージドサービスであり、高可用性とスケーラビリティを提供します。  
*   **VPN接続 / AWS Direct Connect:**  
    オンプレミス環境とVPCの間で、セキュアな接続を確立するためのサービスです。  
    VPN接続はインターネット経由で暗号化されたトンネルを確立し、Direct ConnectはAWSネットワークへの専用線接続を提供します。  

### 2. IPアドレス

EC2インスタンスには、以下の種類のIPアドレスが関連付けられます。  

*   **プライベートIPアドレス:**  
    VPCのCIDRブロック（IPアドレス範囲）内から自動的に割り当てられるIPアドレスです。  
    VPC内のインスタンス同士の通信に利用され、インスタンスが停止・起動しても基本的に変更されません。  
*   **パブリックIPアドレス:**  
    インターネットからインスタンスに直接アクセスするために利用されるIPアドレスです。  
    インスタンス起動時に自動的に割り当てられますが、インスタンスが停止・起動すると変更される可能性があります。  
*   **Elastic IP (EIP):**  
    AWSアカウントに紐付けられる固定のパブリックIPアドレスです。  
    EIPをインスタンスにアタッチすることで、インスタンスが停止・起動しても常に同じパブリックIPアドレスを維持できます。  
    アタッチされていないEIPや、`stopped` 状態のインスタンスにアタッチされたEIPには課金が発生するため注意が必要です。  

### 3. セキュリティ（仮想ファイアウォール）

EC2インスタンスへのネットワークアクセスは、2つのレベルの仮想ファイアウォールで制御されます。  

| 特性           | セキュリティグループ (Security Group)             | ネットワークACL (Network Access Control List)       |
| :------------- | :------------------------------------------------ | :-------------------------------------------------- |
| **適用範囲**   | **インスタンスレベル** (個々のEC2インスタンスまたはENI) | **サブネットレベル** (サブネット内の全インスタンス) |
| **評価対象**   | 送受信トラフィック                                | 送受信トラフィック                                  |
| **ルールタイプ** | **許可ルールのみ**                                | **許可ルールと拒否ルール**                          |
| **ステートフル/ステートレス** | **ステートフル** (インバウンド許可でアウトバウンド戻り通信は自動許可) | **ステートレス** (インバウンド/アウトバウンド両方明示的に許可が必要) |
| **評価順序**   | 全てのルールが評価される（実質的な順序なし）      | 番号の若い順に評価される（最初の一致で処理決定）    |
| **デフォルト** | 全てのアウトバウンドを許可、インバウンドを拒否      | 全てを許可（デフォルトVPCの場合）                   |
| **推奨用途**   | アプリケーションレベルのアクセス制御              | サブネット全体に対する広範なフィルタリング、特定のIPの拒否 |

#### 3.1. セキュリティグループ

EC2インスタンスの第一の防御層であり、インスタンス単位の仮想ファイアウォールとして機能します。  
特定のポート、プロトコル、送信元IPアドレスからのトラフィックのみを許可するルールを設定し、不要な通信をブロックします。  
セキュリティグループは「ステートフル」であり、一度インバウンドを許可すれば、その戻りのアウトバウンド通信は自動的に許可されます。  

#### 3.2. ネットワークACL

サブネット単位の仮想ファイアウォールであり、セキュリティグループよりも広範なフィルタリングが可能です。  
インバウンドとアウトバウンドの両方に対して「許可」と「拒否」のルールを設定でき、ルールは番号の若い順に評価されます。  
ネットワークACLは「ステートレス」であり、インバウンドを許可しても、その戻りのアウトバウンド通信も明示的に許可する必要があります。  

### 4. ネットワークインターフェース (ENI)

Elastic Network Interface (ENI) は、EC2インスタンスにアタッチされる仮想ネットワークカードです。  
プライベートIPアドレス、パブリックIPアドレス、Elastic IP、MACアドレス、セキュリティグループなどがENIに関連付けられます。  
1つのインスタンスに複数のENIをアタッチすることで、複数のサブネットにインスタンスを接続したり、管理ネットワークとデータネットワークを分離したりといった高度なネットワーク構成も可能です。  

### 5. 高度なネットワークサービスとの連携

EC2インスタンスは、上記基本的なネットワーク機能だけでなく、より高度なネットワークサービスと連携することで、高可用性、スケーラビリティ、パフォーマンス、セキュリティをさらに向上させます。  

*   **Elastic Load Balancing (ELB):** 複数のEC2インスタンス間でトラフィックを分散し、可用性とスケーラビリティを向上させます。  
*   **Auto Scaling:** EC2インスタンスの数を、アプリケーションの需要に応じて自動的に増減させ、パフォーマンスを維持しつつコストを最適化します。  
*   **Placement Groups:** インスタンスの物理的な配置を制御し、アプリケーションのパフォーマンスや可用性を向上させます。  

EC2とネットワークの密接な連携を理解することは、堅牢でスケーラブルなAWSインフラストラクチャを設計・運用する上で不可欠な要素です。  

---

## ELB

### Elastic Load Balancing (ELB) とは

Elastic Load Balancing (ELB) は、複数のEC2インスタンス、コンテナ、IPアドレス、Lambda関数などのターゲット間で、受信したネットワークトラフィックを自動的に分散するサービスです。  
これにより、アプリケーションの可用性、スケーラビリティ、耐障害性が向上します。  
Webサービスやアプリケーションが大量のアクセスを受けたり、特定のインスタンスに障害が発生したりした場合でも、ELBがトラフィックを適切に処理し、ユーザーエクスペリエンスを維持します。  

#### ELBの主なメリット

*   **可用性の向上:**  
    トラフィックを複数のアベイラビリティゾーン (AZ) に分散することで、単一AZでの障害が発生してもサービスを継続できます。  
    また、異常のあるインスタンスを自動的に検出し、そこへのトラフィック転送を停止します。  
*   **スケーラビリティの向上:**  
    アプリケーションの需要に応じて、バックエンドのEC2インスタンスの数を増減させることができます（Auto Scalingとの連携）。  
    ELB自体も、急激なトラフィック増加に自動的に対応し、スケーリングします。  
*   **耐障害性:**  
    バックエンドのインスタンスに障害が発生しても、ELBが正常なインスタンスにのみトラフィックをルーティングするため、アプリケーション全体の可用性が維持されます。  
*   **セキュリティの強化:**  
    SSL/TLS終端機能を提供し、バックエンドインスタンスの負荷を軽減するとともに、セキュリティグループと連携してアクセス制御を行います。  

### ELBの種類

AWSは、ワークロードの要件に応じて、3種類のロードバランサーを提供しています。  

#### 1. Application Load Balancer (ALB)

*   **機能:**  
    *   **レイヤー7 (HTTP/HTTPS) ロードバランサー:** リクエストの内容（URLのパス、ホスト名、HTTPヘッダーなど）に基づいてトラフィックをルーティングできます。  
    *   **コンテンツベースルーティング:** `/api` へのリクエストはAPIサーバー群へ、`/images` へのリクエストは画像サーバー群へ、といったルーティングが可能です。  
    *   **ターゲットグループ:** ターゲット（EC2インスタンスなど）をグループ化し、それぞれに異なるルーティングルールやヘルスチェックを設定できます。  
    *   **Lambda関数へのルーティング:** リクエストをLambda関数に直接ルーティングして、サーバーレスアプリケーションを構築できます。  
    *   **コンテナ対応:** Amazon ECS/EKSなどのコンテナサービスとの連携に最適です。  
*   **用途:**  
    *   マイクロサービスアーキテクチャ。  
    *   コンテナベースのアプリケーション。  
    *   HTTP/HTTPSトラフィックを扱うWebアプリケーション。  
    *   コンテンツベースのルーティングが必要な場合。  

#### 2. Network Load Balancer (NLB)

*   **機能:**  
    *   **レイヤー4 (TCP/UDP/TLS) ロードバランサー:** IPアドレスとポート番号に基づいてトラフィックをルーティングします。  
    *   **超高速処理:** 非常に高いスループットと低いレイテンシで、数百万のリクエストを秒単位で処理できます。  
    *   **静的IPアドレス:** 各AZに静的なIPアドレス（Elastic IPを関連付け可能）を提供します。  
    *   **ソースIPアドレスの保持:** クライアントのソースIPアドレスをバックエンドにそのまま渡すことができます。  
*   **用途:**  
    *   極めて高いパフォーマンスが求められるワークロード。  
    *   TCP/UDPトラフィックを扱うアプリケーション（ゲームサーバー、IoTバックエンドなど）。  
    *   静的なIPアドレスが必要な場合。  
    *   TLS終端をバックエンドで行いたい場合。  

#### 3. Gateway Load Balancer (GWLB)

*   **機能:**  
    *   **透過的なネットワークゲートウェイ:** サードパーティ製の仮想アプライアンス（ファイアウォール、侵入検知システムなど）を、スケーラブルかつ可用性の高い方法でデプロイ・管理できます。  
    *   **GWLBe (Gateway Load Balancer Endpoint):** VPC間のトラフィックをGWLB経由でルーティングし、セキュリティアプライアンスで検査できるようにします。  
    *   **GENEVEプロトコル:** トラフィックをカプセル化して、アプライアンスとGWLB間でやり取りします。  
*   **用途:**  
    *   複数のセキュリティアプライアンスを集中管理し、スケーリングさせたい場合。  
    *   ネットワークトラフィックを透過的に検査・制御したい場合。  

#### Classic Load Balancer (CLB)

*   **備考:** かつて提供されていた従来のロードバランサーで、現在は非推奨（レガシー）です。  
    新しいアプリケーションにはALBまたはNLBを使用することが強く推奨されます。  

### ELBの主要な機能

*   **ヘルスチェック (Health Checks):**  
    ELBは、バックエンドのターゲット（EC2インスタンスなど）が正常に動作しているか定期的に監視します。  
    設定されたプロトコル（HTTP, TCPなど）とポートで、指定されたパスにアクセスしたり、ポートに接続したりして、応答が正常かどうかを確認します。  
    異常を検出したターゲットにはトラフィックを転送せず、正常なターゲットにのみルーティングします。  
*   **SSL/TLS終端 (SSL/TLS Termination):**  
    ELBでSSL/TLS証明書を管理し、暗号化された通信の復号化と再暗号化を行うことができます。  
    これにより、バックエンドのEC2インスタンスのCPU負荷を軽減し、SSL/TLS証明書の管理を一元化できます。  
    ACM (AWS Certificate Manager) と連携して、証明書を無料でプロビジョニング・更新することも可能です。  
*   **スティッキーセッション (Sticky Sessions):**  
    特定のクライアントからのリクエストを、常に同じバックエンドインスタンスにルーティングする機能です。  
    セッション情報がインスタンスローカルに保存されるようなアプリケーションで利用されますが、インスタンス障害時の可用性が低下する可能性があります。  
    可能な限り、セッション情報を共有ストレージ（Redis, DynamoDBなど）に保存する設計が推奨されます。  
*   **VPCの利用:**  
    ELBは常にVPC内にデプロイされ、少なくとも2つのアベイラビリティゾーン (AZ) にわたって設定することが推奨されます。  
    これにより、AZ障害時にもサービスの可用性を確保できます。  

ELBは、高可用性でスケーラブルなWebアプリケーションやAPIサービスをAWS上で構築する上で、不可欠なサービスです。  
アプリケーションの特性に応じて適切なロードバランサータイプを選択し、適切に設定することで、システムの信頼性とパフォーマンスを大きく向上させることができます。  

---

## オートスケーリング

### AWS Auto Scalingとは

AWS Auto Scaling は、アプリケーションの需要に応じてEC2インスタンスの数を自動的に調整（スケールイン/スケールアウト）するサービスです。  
これにより、アプリケーションの可用性とパフォーマンスを維持しつつ、コストを最適化できます。  
ユーザーは、トラフィックの急増時にもパフォーマンスを確保し、トラフィックが減少した際には不要なリソースを削減して費用を節約することが可能です。  

#### オートスケーリングの主なメリット

*   **可用性と耐障害性の向上:**  
    複数のAZにわたってインスタンスを分散配置し、インスタンスの障害を自動的に検出し、新しいインスタンスに置き換えることで、アプリケーションの継続的な稼働を保証します。  
*   **パフォーマンスの維持:**  
    トラフィックや負荷の増減に合わせて、リアルタイムでインスタンス数を調整するため、常に最適なパフォーマンスを維持できます。  
*   **コスト最適化:**  
    需要の低い時間帯にはインスタンス数を削減し、不要な課金を防止します。  
    リザーブドインスタンスやSavings Plansとの組み合わせで、さらにコストを最適化できます。  
*   **運用負荷の軽減:**  
    手動でのインスタンス起動・停止、障害対応の必要性を減らし、運用担当者の負担を軽減します。  

### オートスケーリングの構成要素

AWS Auto Scalingは、主に以下の3つのコンポーネントで構成されます。  

#### 1. 起動テンプレート (Launch Template) または起動設定 (Launch Configuration)

*   **目的:** 新しいEC2インスタンスを起動するためのテンプレートを定義します。  
*   **内容:**  
    *   **AMI (Amazon Machine Image):** どのOSとソフトウェア構成でインスタンスを起動するか。  
    *   **インスタンスタイプ:** CPU、メモリなどのハードウェアスペック。  
    *   **キーペア:** SSH接続用の認証情報。  
    *   **セキュリティグループ:** インスタンスへのネットワークアクセス制御。  
    *   **EBSボリューム:** ルートボリュームのサイズやタイプ、追加ボリュームの設定。  
    *   **ユーザーデータ (User Data):** インスタンス起動時に実行されるスクリプト（ソフトウェアのインストール、設定など）。  
*   **起動テンプレートの推奨:** 現在では、起動設定よりも機能が豊富で、より柔軟な「起動テンプレート」の利用が推奨されています。  

#### 2. オートスケーリンググループ (Auto Scaling Group: ASG)

*   **目的:** 起動テンプレートで定義された仕様に基づいて、EC2インスタンスのコレクションを管理します。  
*   **内容:**  
    *   **最小容量 (Min capacity):** ASGが常に維持するインスタンスの最小数。  
    *   **最大容量 (Max capacity):** ASGがスケールアウトできるインスタンスの最大数。  
    *   **希望する容量 (Desired capacity):** 現在維持したいインスタンスの数。  
    *   **VPCとサブネット:** インスタンスを起動するAZとサブネット。  
    *   **ELBとの連携:** ELBのターゲットグループと関連付け、ロードバランサーの配下にインスタンスを自動的に登録・登録解除します。  
*   **動作:**  
    ASGは、設定された容量に基づいてインスタンス数を維持します。  
    例えば、Min capacityが2でインスタンスが1つになった場合、ASGは自動的にもう1つインスタンスを起動してMin capacityを維持します。  

#### 3. スケーリングポリシー (Scaling Policies)

*   **目的:** いつ、どのようにインスタンス数を増減させるかを定義します。  
*   **種類:**  
    *   **シンプルスケーリング (Simple Scaling):**  
        CloudWatchアラームが発動したら、指定された数のインスタンスを増減させる。  
        クールダウン期間が必要。  
    *   **ステップスケーリング (Step Scaling):**  
        CloudWatchアラームの規模に応じて、インスタンスの増減数を動的に調整する。  
    *   **ターゲット追跡スケーリング (Target Tracking Scaling):**  
        最も推奨されるスケーリングポリシーです。  
        指定されたCloudWatchメトリクス（例: CPU使用率、ALBのリクエスト数）を目標値（ターゲット）に維持するように、ASGが自動的にインスタンス数を調整します。  
        例: 「CPU使用率が50%になるようにインスタンス数を調整する」。  
    *   **スケジュールスケーリング (Scheduled Scaling):**  
        特定の時刻（例: 毎日9時にインスタンス数を増やす、18時に減らす）にインスタンス数を調整します。  
        予測可能なトラフィックパターン（昼間に多いWebサイトなど）に有効です。  

### Auto Scalingの連携

*   **CloudWatch:**  
    EC2インスタンスのCPU使用率、ネットワークI/O、ELBのリクエスト数など、様々なメトリクスを監視します。  
    これらのメトリクスに基づいてアラームを設定し、スケーリングポリシーをトリガーします。  
*   **Elastic Load Balancing (ELB):**  
    ASGによって起動されたインスタンスは、自動的にELBのターゲットグループに登録され、トラフィックの分散対象となります。  
    停止するインスタンスはELBから自動的に登録解除されます。  
*   **ヘルスチェック:**  
    ASGは、EC2インスタンスのステータスチェックや、ELBのヘルスチェックの結果に基づいて、異常なインスタンスを自動的に検出し、置き換えます。  
    これにより、アプリケーションの可用性が向上します。  

### Auto Scalingの考慮事項

*   **ウォームアップ時間:**  
    新しく起動したインスタンスがアプリケーションのロードを受け入れる準備が整うまでの時間（アプリケーションの起動、データ同期など）を考慮し、クールダウン期間やライフサイクルフックを設定することが重要です。  
*   **スケーリングの粒度:**  
    急激なスケールアウト・インを繰り返さないよう、スケーリングポリシーのしきい値やクールダウン期間を適切に設定する必要があります。  
*   **コスト管理:**  
    最大容量を適切に設定しないと、意図しないインスタンスの増加によりコストが急増する可能性があります。  
*   **アプリケーションのステートレス化:**  
    Auto Scalingを最大限に活用するためには、インスタンスがいつでも増減できるようなステートレスなアプリケーション設計が推奨されます。  
    セッション情報などは、共有データベースやキャッシュ（ElastiCacheなど）に保存するようにします。  

AWS Auto Scalingは、モダンなクラウドネイティブアプリケーションを構築・運用する上で、非常に強力なツールです。  
適切に設定することで、アプリケーションの信頼性とパフォーマンスを向上させつつ、運用コストを最適化できます。  

---

## プレイスメントグループ

### プレイスメントグループとは

プレイスメントグループは、EC2インスタンスの物理的な配置を制御し、特定の要件（高性能、高可用性、高信頼性など）を満たすように最適化するための機能です。  
EC2インスタンスは通常、AWSがデータセンター内で最適な場所に自動的に配置しますが、プレイスメントグループを使用すると、物理的な基盤ハードウェア上でのインスタンスの配置をユーザーが指定できるようになります。  
これにより、ネットワークパフォーマンスの向上や、特定の障害シナリオに対する耐性の強化が可能になります。  

### プレイスメントグループの種類

AWSは、主に3種類のプレイスメントグループを提供しており、それぞれ異なる目的で利用されます。  

#### 1. クラスタープレイスメントグループ (Cluster Placement Group)

*   **目的:**  
    単一のアベイラビリティゾーン (AZ) 内で、インスタンスを**物理的に相互に密接に配置**することで、低レイテンシかつ高スループットのネットワーク通信を実現します。  
    同じラック、またはごく近接したラックにインスタンスが配置される傾向があります。  
*   **メリット:**  
    *   **超低レイテンシ:** インスタンス間のネットワーク遅延が極めて低くなります。  
    *   **高ネットワークスループット:** インスタンス間のネットワーク帯域幅が最大化されます。  
*   **デメリット:**  
    *   **単一障害点のリスク:** 物理的に近接しているため、同じラックやハードウェアの障害が複数のインスタンスに影響を与える可能性があります。  可用性が犠牲になる可能性があります。  
    *   **容量の制約:** 特定のAZ内で連続した物理リソースが必要になるため、大規模なクラスターを起動する際に容量不足に陥る可能性があります。  
*   **用途:**  
    *   **高性能コンピューティング (HPC):** 科学技術計算、金融モデリングなど、インスタンス間の通信が非常に多い並列処理アプリケーション。  
    *   **ビッグデータ分析:** HadoopやSparkなど、インスタンス間で大量のデータを高速にやり取りするクラスタ。  
    *   **インメモリデータベース:** RedisやMemcachedなど、低レイテンシがパフォーマンスに直結するキャッシュシステム。  

#### 2. パーティションプレイスメントグループ (Partition Placement Group)

*   **目的:**  
    インスタンスを複数の論理的な**パーティション**に分散させることで、基盤となるハードウェアの共有を最小限に抑えます。  
    各パーティションは、独自のラックセットまたはラックセグメントを持ち、物理的に独立しています。  
    パーティションごとに障害ドメインが分離されるため、あるパーティションの障害が他のパーティションに影響を与えるリスクが低減されます。  
*   **メリット:**  
    *   **障害耐性の向上:** 障害ドメインが分離されているため、大規模な分散アプリケーションの可用性を高めます。  
    *   **高可用性:** クラスタープレイスメントグループよりも可用性に優れます。  
    *   **容量の柔軟性:** 複数のAZにまたがることも可能です（クラスターは単一AZ）。  
*   **デメリット:**  
    *   クラスタープレイスメントグループほどの超低レイテンシ・高スループットは期待できません。  
*   **用途:**  
    *   **大規模分散システム:** Apache Cassandra、Kafka、HDFSなど、分散ノードが多数存在し、互いにレプリケーションや分散処理を行うアプリケーション。  
    *   **高可用性データベース:** 複数のノードでデータが同期・冗長化されているデータベースクラスタ。  
    *   **重要なサービス:** 特定の障害が全体に波及しないようにしたいミッションクリティカルなサービス。  

#### 3. スプレッドプレイスメントグループ (Spread Placement Group)

*   **目的:**  
    最大7つのインスタンスを、それぞれ**別々の物理的なハードウェア（ラック）に分散**させ、障害ドメインを最大限に分離します。  
    これにより、単一の物理サーバーやラックの障害が複数のインスタンスに影響を与える可能性を最小限に抑えます。  
*   **メリット:**  
    *   **最高の耐障害性:** 可能な限りインスタンス間の障害ドメインを分離します。  
    *   **非常に高い可用性:** ミッションクリティカルで、各インスタンスが独立して稼働することが重要なワークロードに適しています。  
*   **デメリット:**  
    *   インスタンス数が7つまでに制限されます（それ以上は複数のスプレッドプレイスメントグループが必要）。  
    *   ネットワーク性能の最適化は期待できません。  
    *   容量不足のリスクが他のタイプよりも高くなる可能性があります。  
*   **用途:**  
    *   **ミッションクリティカルな少数のインスタンス:** アクティブ/スタンバイ構成のデータベース、DNSサーバー、クリティカルなアプリケーションサーバーなど。  
    *   **ライセンス制限のあるアプリケーション:** ソフトウェアライセンスの都合上、起動できるインスタンス数が少ないが、それぞれに高い可用性が求められる場合。  

### プレイスメントグループの選択と考慮事項

| タイプ     | 目的               | 物理的配置                                 | 主なメリット               | 主なデメリット             | 適したワークロード                                  |
| :--------- | :----------------- | :----------------------------------------- | :------------------------- | :------------------------- | :-------------------------------------------------- |
| **クラスター** | 性能最適化         | 単一AZ内で物理的に密接                     | 超低レイテンシ、高スループット | 単一障害点のリスクが高い   | HPC、ビッグデータ、インメモリDB、低遅延通信が必要なもの |
| **パーティション** | 可用性・信頼性向上 | 複数のパーティションに分散（独自のラックセット） | 障害ドメインの分離、高可用性 | クラスターほど高性能ではない | 大規模分散DB (Cassandra, Kafka)、分散システム        |
| **スプレッド** | 最高の耐障害性     | 別々の物理ハードウェアに最大7インスタンス分散 | 最大限の障害分離、最高可用性 | インスタンス数に制限、性能最適化なし | ミッションクリティカルな少数のインスタンス、アクティブ/スタンバイ |

#### 考慮事項

*   **インスタンスタイプの互換性:** 特定のインスタンスタイプ（例: 最新世代のインスタンス）は、すべてのプレイスメントグループタイプで利用できるわけではありません。  
*   **容量の制約:** 特にクラスタープレイスメントグループは、特定のAZ内で連続した物理リソースを必要とするため、大規模なデプロイでは容量不足に注意が必要です。  
*   **インスタンスの起動:** プレイスメントグループを作成した後、そのグループ内にインスタンスを起動する必要があります。  
    既存のインスタンスをプレイスメントグループに移動することはできません（一度停止してグループ内で再起動するなど、別の方法が必要）。  
*   **AZの選択:** クラスタープレイスメントグループは単一AZに限定されます。  
    高可用性をさらに高めるには、複数のAZにまたがる複数のプレイスメントグループを構成するか、パーティション/スプレッドプレイスメントグループを検討します。  

プレイスメントグループは、アプリケーションの特定の非機能要件（性能、可用性、信頼性）を満たすために、EC2インスタンスのデプロイ戦略を細かく制御できる強力な機能です。  
ワークロードの特性を深く理解した上で、最適なプレイスメントグループタイプを選択することが、システム全体の最適化につながります。  

---

## まとめ

### これまでの学習内容の振り返り

本研修では、AWSの核となるサービスであるAmazon EC2について、その基本的な概念から高度な機能までを幅広く学習してきました。  
EC2は、クラウド上で仮想サーバー（インスタンス）を柔軟に利用できるサービスであり、現代のITインフラにおいて不可欠な存在です。  

主要な学習項目を以下に振り返ります。  

*   **Amazon EC2とは:** クラウド上の仮想サーバーサービスであり、その「伸縮自在な」コンピューティング能力が最大の特長であることを理解しました。  
*   **EC2のメリット:** 俊敏性、スケーラビリティ、コスト効率、高い可用性、セキュリティといった多岐にわたるメリットを学びました。  
*   **EC2の仕組みと構造:** ハイパーバイザーによる仮想化、AMI、インスタンスタイプ、VPCといったEC2を構成する主要な要素と、AWSのリージョン・アベイラビリティゾーンといった物理的インフラストラクチャの関係性を理解しました。  
*   **AMI (OS) と選択できるOS:** インスタンスのテンプレートであるAMIの役割と、Amazon Linux、Ubuntu、Windows Serverなど、多様なOSの選択肢とその特性について学習しました。  
*   **ミドルウェア:** OSとアプリケーションの橋渡しをするミドルウェア（Webサーバー、アプリケーションサーバー、データベースなど）の重要性と、EC2上での運用について学びました。  
*   **インスタンスタイプ:** CPU、メモリ、ネットワーク性能などを定義するインスタンスタイプについて、様々なファミリーと選び方のポイントを理解しました。  
*   **インスタンスの購入方式:** オンデマンド、リザーブドインスタンス、スポットインスタンス、Savings Plansといった多様な購入オプションがあり、ワークロード特性に応じた最適な選択がコスト最適化に繋がることを学びました。  
*   **コスト発生のタイミングと防止:** インスタンスの状態（Running, Stopped, Terminated）、EBS、データ転送、EIPなど、具体的な課金タイミングを理解し、意図しないコスト発生を防ぐための実践的な対策（不要リソースの削除、予算設定、タグ付けなど）を学びました。  
*   **ストレージ (EBSとインスタンスストア):** 永続性、パフォーマンス、可用性の異なるEBSとインスタンスストアそれぞれの特徴と、ワークロードに応じた使い分けの重要性を理解しました。  
*   **スナップショット:** EBSボリュームのバックアップと復旧に不可欠なスナップショットの増分バックアップの仕組みと、DLMによる自動化について学びました。  
*   **S3やEFSとの違い:** EC2に直接アタッチされるストレージに加え、オブジェクトストレージのS3、共有ファイルシステムのEFSといった他のAWSストレージサービスとの違いと、それぞれのユースケースを比較して理解を深めました。  
*   **EC2とネットワーク:** VPC、サブネット、IPアドレス、セキュリティグループ、ネットワークACLといったネットワークの基本構成要素と、EC2インスタンスの通信制御について学びました。  
*   **ELB (Elastic Load Balancing):** 複数のインスタンス間でトラフィックを分散し、可用性とスケーラビリティを向上させるELBの仕組みと、ALB、NLBといったロードバランサーの種類について学びました。  
*   **オートスケーリング:** アプリケーションの需要に応じてインスタンス数を自動調整するAuto Scalingの仕組みと、起動テンプレート、ASG、スケーリングポリシーといった構成要素について学びました。  
*   **プレイスメントグループ:** インスタンスの物理的な配置を制御し、性能や可用性を最適化するためのプレイスメントグループ（クラスター、パーティション、スプレッド）の種類と用途を学習しました。  

### EC2を効果的に活用するために

EC2は非常に強力で多機能なサービスですが、その真価を発揮するためには、以下のポイントを常に意識することが重要です。  

1.  **ワークロード特性の理解:**  
    CPU、メモリ、ストレージI/O、ネットワーク帯域、可用性、セキュリティなど、アプリケーションが何を必要としているのかを深く理解することが、最適なインスタンスタイプ、ストレージ、ネットワーク構成、そしてスケーリング戦略を選択する上で不可欠です。  
2.  **コスト管理と最適化:**  
    従量課金制のメリットを最大限に活かしつつ、意図しないコスト発生を防ぐための継続的な監視と最適化が求められます。  
    AWS Cost Explorer、Trusted Advisor、AWS Budgetsなどのツールを積極的に活用し、リザーブドインスタンスやSavings Plansの導入も検討しましょう。  
3.  **高可用性と耐障害性の設計:**  
    単一障害点を避けるため、複数のアベイラビリティゾーンへの分散配置、ELBとAuto Scalingの組み合わせ、EBSスナップショットによるバックアップ戦略などを積極的に取り入れましょう。  
4.  **セキュリティの徹底:**  
    VPC、セキュリティグループ、ネットワークACLによる多層防御、IAMによる最小権限の原則、EBS暗号化など、AWSが提供するセキュリティ機能を最大限に活用し、セキュアな環境を構築しましょう。  
5.  **自動化と運用効率:**  
    手動での作業を減らし、IaC (Infrastructure as Code) や自動化ツール（User Data、AWS Lambda、CloudWatch Eventsなど）を活用することで、運用ミスを減らし、デプロイの迅速化と一貫性を確保しましょう。  
6.  **マネージドサービスの活用:**  
    データベース（RDS）、キャッシュ（ElastiCache）、メッセージキュー（SQS）など、運用負担の大きいミドルウェアは、EC2上で自前で構築するよりも、AWSのマネージドサービスを利用する方が、多くの場合でコスト効率と運用効率が向上します。  
    EC2を使うべきか、マネージドサービスを使うべきか、常に検討する視点を持つことが重要です。  
