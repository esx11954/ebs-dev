# EC2におけるAMI (OS)

---

### AMI (Amazon Machine Image) とは

Amazon Machine Image (AMI) は、EC2インスタンスを起動するために必要な情報がすべて含まれた、事前に設定されたテンプレートです。  
簡単に言えば、「OSとソフトウェア、設定のスナップショット」と考えると良いでしょう。  
AMIを使用することで、毎回OSのインストールや基本的なソフトウェアの設定を行う手間なく、迅速かつ一貫性のあるEC2インスタンスを起動できます。  

#### AMIに含まれるもの

AMIには、以下の要素が含まれています。  

*   **OS (オペレーティングシステム):** Linux (Amazon Linux, Ubuntu, Red Hat Enterprise Linux, SUSE Linux Enterprise Serverなど) または Windows Server。  
*   **ソフトウェアパッケージ:** ウェブサーバー (Apache, Nginx)、データベース (MySQL, PostgreSQL)、アプリケーションランタイム (Node.js, Java, Python) など、事前にインストールされたアプリケーションやミドルウェア。  
*   **起動時に適用される設定:** ユーザーアカウント、ネットワーク設定、カスタムスクリプトなど。  
*   **データボリュームへのマッピング情報:** どのEBSボリュームがどのマウントポイントに接続されるかなどの情報。  

### AMIの種類

AMIには、主に以下の3つの種類があります。  

#### 1. AWSが提供するAMI (Public AMI)

AWSが公式に提供するAMIです。  
これらは、通常、最新のセキュリティパッチが適用されており、様々なOSディストリビューションが利用可能です。  
ほとんどのユーザーは、このPublic AMIをベースにしてEC2インスタンスの構築を開始します。  

| カテゴリ           | 提供OSの例                                    | 特徴                                                 |
| :----------------- | :-------------------------------------------- | :--------------------------------------------------- |
| **Amazon Linux**   | Amazon Linux 2, Amazon Linux 2023             | AWSに最適化されており、無料で利用可能。                |
| **Ubuntu Server**  | Ubuntu Server 22.04 LTS, 20.04 LTSなど        | 人気のあるLinuxディストリビューション。コミュニティサポートが充実。 |
| **Red Hat Enterprise Linux (RHEL)** | RHEL 9, RHEL 8など                        | エンタープライズ向けの商用Linuxディストリビューション。 |
| **SUSE Linux Enterprise Server (SLES)** | SLES 15など                               | エンタープライズ向けの商用Linuxディストリビューション。 |
| **Microsoft Windows Server** | Windows Server 2022, 2019, 2016など | Windows環境でアプリケーションを稼働させる場合に利用。 |

#### 2. AWS Marketplace AMI

AWS Marketplaceを通じて、サードパーティベンダーが提供するAMIです。  
これらには、特定のアプリケーション（例えば、CRMソフトウェア、セキュリティ製品、データベースソリューションなど）が事前にインストールされ、設定された状態で提供されます。  
通常、ソフトウェアのライセンス費用がEC2の利用料金に上乗せされる形で課金されます。  

#### 3. カスタムAMI (Private AMI)

お客様自身が、既存のEC2インスタンスから作成するAMIです。  
既存のインスタンスにOSやアプリケーションをインストールし、必要な設定を行った後、その状態をAMIとして保存できます。  
これにより、同じ構成のインスタンスを何度も起動したり、バックアップとして利用したり、他のAWSアカウントと共有したりすることが可能になります。  

##### カスタムAMIのメリット

*   **迅速な展開:** 必要なソフトウェアや設定がすべて含まれているため、新しいインスタンスを数分で起動できます。  
*   **一貫性:** 常に同じ構成のインスタンスをデプロイでき、構成ドリフトを防ぎます。  
*   **バックアップとリカバリ:** インスタンスの状態をAMIとして保存することで、災害発生時や誤操作時の迅速な復旧に役立ちます。  
*   **コスト削減:** 起動と停止を繰り返す開発/テスト環境などで、起動時間を短縮できます。  

### AMIの利用シナリオ

*   **新しいインスタンスの起動:** 新しいEC2インスタンスを作成する際、ベースとなるOSやソフトウェアを含むAMIを選択します。  
*   **スケーリング:** オートスケーリンググループで、自動的に追加されるインスタンスのテンプレートとして使用します。  
*   **環境の複製:** 開発環境からテスト環境、本番環境へと、一貫した環境を複製するために使用します。  
*   **システムのバックアップ:** 定期的に稼働中のインスタンスからAMIを作成し、システムの復元ポイントとして利用します（EBSスナップショットも併用）。  

AMIは、EC2インスタンスのプロビジョニングと管理を効率化し、開発者や運用者の負担を軽減する上で非常に重要なコンポーネントです。  
適切なAMIを選択し、必要に応じてカスタムAMIを作成することで、EC2の利便性を最大限に引き出すことができます。  

---

## ミドルウェア

### ミドルウェアとは

ミドルウェアとは、オペレーティングシステム (OS) とアプリケーションの中間に位置し、両者間の連携を助け、アプリケーション開発・実行の効率を高めるソフトウェア群の総称です。  
OSがハードウェアを抽象化し、アプリケーションが特定のビジネスロジックを実行するのに対し、ミドルウェアはネットワーク通信、データベース接続、メッセージング、トランザクション管理などの共通機能を提供します。  
これにより、アプリケーション開発者は、低レベルなOSやネットワークの詳細を意識することなく、ビジネスロジックの実装に集中できます。  

EC2インスタンスでは、選択したOSの上に、様々なミドルウェアをインストールして利用することが一般的です。  

### 主要なミドルウェアとその役割

EC2インスタンス上で利用される代表的なミドルウェアには、以下のような種類があります。  

#### 1. Webサーバー

クライアントからのHTTPリクエストを受け付け、HTMLファイルや画像などの静的コンテンツを配信したり、アプリケーションサーバーに動的コンテンツの生成を依頼したりする役割を担います。  

*   **Apache HTTP Server (httpd):**  
    *   **特徴:** 長い歴史を持つ最も普及しているWebサーバーの一つです。  モジュールが豊富で、柔軟な設定が可能です。  
    *   **用途:** 静的コンテンツ配信、リバースプロキシ、動的コンテンツへのリダイレクトなど。  
*   **Nginx:**  
    *   **特徴:** 高性能で軽量なWebサーバーであり、特に大量の同時接続処理に強みがあります。  リバースプロキシやロードバランサーとしてもよく利用されます。  
    *   **用途:** 高トラフィックのWebサイト、APIゲートウェイ、リバースプロキシ、キャッシュサーバーなど。  
*   **IIS (Internet Information Services):**  
    *   **特徴:** Microsoft Windows Serverに標準で搭載されているWebサーバーです。  .NETアプリケーションとの連携が容易です。  
    *   **用途:** Windows環境でのWebサイトやWebアプリケーションのホスティング。  

#### 2. アプリケーションサーバー

Webサーバーから受け取ったリクエストに基づいて、ビジネスロジックを実行し、動的なコンテンツを生成する役割を担います。  
Java、Python、PHP、Node.jsなどの言語で書かれたアプリケーションを実行します。  

*   **Java系 (Apache Tomcat, JBoss/WildFly, WebLogic, WebSphere):**  
    *   **特徴:** JavaEE (Jakarta EE) 仕様を実装し、エンタープライズ向けの堅牢なアプリケーション実行環境を提供します。  
    *   **用途:** 大規模なJavaベースのエンタープライズアプリケーション。  
*   **PHP系 (PHP-FPM):**  
    *   **特徴:** PHPアプリケーションを高速に実行するためのFastCGIプロセス管理ツールです。  NginxやApacheと連携して動作します。  
    *   **用途:** WordPressなどのPHP製WebサイトやWebアプリケーション。  
*   **Python系 (Gunicorn, uWSGI):**  
    *   **特徴:** PythonのWSGI (Web Server Gateway Interface) アプリケーションを実行するためのサーバーです。  Nginxなどと組み合わせて使用されます。  
    *   **用途:** DjangoやFlaskなどのPython製Webアプリケーション。  
*   **Node.js系 (PM2, Forever):**  
    *   **特徴:** Node.jsアプリケーションのプロセス管理やクラッシュ時の自動再起動などを担当します。  
    *   **用途:** Node.js製リアルタイムアプリケーション、APIサーバー。  

#### 3. データベース管理システム (DBMS)

データの永続的な保存、管理、取得を行うミドルウェアです。  
EC2上で自らデータベースを構築・運用することも可能ですが、AWSが提供するマネージドサービス（Amazon RDS、DynamoDBなど）の利用も検討するべきです。  

*   **リレーショナルデータベース:**  
    *   **例:** MySQL, PostgreSQL, Oracle Database, Microsoft SQL Server, MariaDB  
    *   **特徴:** 表形式でデータを管理し、SQLを使用して操作します。  ACID特性を保証し、データの整合性が重要視されるシステムに適しています。  
    *   **用途:** 基幹システム、Webサイトのデータストア、トランザクション処理など。  
*   **NoSQLデータベース:**  
    *   **例:** MongoDB, Redis, Apache Cassandra  
    *   **特徴:** リレーショナルデータベース以外のデータモデル（キーバリュー、ドキュメント、カラム指向など）を持つデータベースです。  高いスケーラビリティや柔軟性が必要な場合に適しています。  
    *   **用途:** 大規模データ、リアルタイム分析、キャッシュ、IoTデータなど。  

#### 4. その他

*   **キャッシュサーバー:**  
    *   **例:** Redis, Memcached  
    *   **特徴:** 頻繁にアクセスされるデータをメモリ上に一時的に保持し、データベースへのアクセス負荷を軽減してパフォーマンスを向上させます。  
*   **メッセージキュー:**  
    *   **例:** RabbitMQ, Apache Kafka  
    *   **特徴:** アプリケーション間の非同期通信を実現し、システムの疎結合化、負荷分散、信頼性向上に貢献します。  
*   **プロキシサーバー / リバースプロキシ:**  
    *   **例:** Nginx, Squid, HAProxy  
    *   **特徴:** クライアントとサーバー間の通信を中継し、セキュリティ強化、負荷分散、キャッシュ、SSL終端などの機能を提供します。  

### EC2とミドルウェアの運用

EC2インスタンス上でミドルウェアを運用する際には、以下の点を考慮する必要があります。  

*   **インストールと設定:** OSの選択後、必要なミドルウェアを手動または自動化ツール（User Data、設定管理ツール）でインストールし、適切に設定します。  
*   **パッチ管理とセキュリティ:** OSと同様に、ミドルウェアも定期的なセキュリティパッチの適用とバージョンアップが必要です。  
*   **モニタリング:** ミドルウェアのパフォーマンスやエラーログを監視し、異常を早期に検知・対処する仕組みを構築します。  
*   **可用性とスケーラビリティ:** 複数のインスタンスにミドルウェアを分散配置し、ロードバランサーやオートスケーリングと組み合わせることで、高可用性とスケーラビリティを実現します。  
*   **マネージドサービスの活用:** データベース (RDS)、メッセージキュー (SQS, SNS)、キャッシュ (ElastiCache) など、AWSが提供するマネージドサービスを利用することで、ミドルウェアの運用管理負担を大幅に軽減できる場合があります。  

ミドルウェアの適切な選択と運用は、EC2インスタンス上で動作するアプリケーションの安定性、パフォーマンス、そしてセキュリティを確保するために不可欠です。  

---

## インスタンスタイプ

### インスタンスタイプとは

EC2インスタンスを起動する際、どのくらいのコンピューティングリソース（CPU、メモリ、ストレージ、ネットワーク性能）を使用するかを決定するのが「インスタンスタイプ」です。  
インスタンスタイプは、特定のハードウェア構成の組み合わせを事前に定義したものであり、ワークロードの要件に合わせて最適なタイプを選択することで、パフォーマンスとコストのバランスを取ることができます。  

すべてのインスタンスタイプは、以下のような命名規則に従っています。  
`[ファミリー].[世代].[サイズ]`  

*   **ファミリー:** インスタンスの主要な用途（汎用、コンピューティング最適化など）を示します。  例: `t`, `m`, `c`, `r`  
*   **世代:** インスタンス世代を表す数字です。  新しい世代ほど、一般的に性能が向上し、費用対効果も高くなります。  例: `6`, `5`, `4`  
*   **サイズ:** ファミリー内での相対的なサイズを示します。  サイズが大きくなるほど、CPUコア数、メモリ容量、ネットワーク帯域幅が増加します。  例: `nano`, `micro`, `small`, `medium`, `large`, `xlarge`など  

例: `t3.medium` → Tファミリー、第3世代、Mediumサイズ  

### インスタンスファミリーの種類と用途

AWSは、多様なワークロードに対応できるよう、様々なインスタンスファミリーを提供しています。  
主要なファミリーとその用途の例を以下に示します。  

| ファミリー | タイプ略称 | 主な用途の例                                               | 特徴                                                         |
| :--------- | :--------- | :--------------------------------------------------------- | :----------------------------------------------------------- |
| **汎用**   | **M**      | アプリケーションサーバー、Webサーバー、小規模なデータベース、開発/テスト環境 | CPUとメモリのバランスが良く、幅広いワークロードに対応します。  |
|            | **T**      | 低トラフィックのWebサイト、小規模なデータベース、開発/テスト環境、マイクロサービス | バースト可能なCPU性能を提供。ベースライン性能を超えて一時的にCPU利用率を上げることができます。コスト効率に優れます。 |
|            | **A**      | スケールアウト型Webサーバー、コンテナ、マイクロサービス    | AWS Gravitonプロセッサ (ARMベース) を搭載し、高性能かつ低コスト。 |
| **コンピューティング最適化** | **C**      | 高性能Webサーバー、バッチ処理、分散分析、HPC (高性能コンピューティング) | CPU性能を重視したインスタンスタイプ。計算負荷の高いワークロードに適しています。 |
| **メモリ最適化** | **R**      | インメモリデータベース、データ分析、キャッシュ、HPC、科学技術計算 | メモリ容量を重視したインスタンスタイプ。大量のデータをメモリ上で処理するワークロードに適しています。 |
|            | **X**      | 大規模なインメモリデータベース、インメモリ分析           | Rファミリーよりもさらに大きなメモリ容量を提供します。        |
| **高速コンピューティング** | **P**      | 機械学習、ディープラーニング、GPUによる科学技術計算       | GPU (NVIDIA) を搭載し、並列処理能力が高いです。              |
|            | **G**      | グラフィックスアプリケーション、ビデオエンコーディング、機械学習推論 | GPU (NVIDIA, AMD) を搭載し、グラフィックス処理や機械学習推論に適しています。 |
| **ストレージ最適化** | **I**      | NoSQLデータベース、データウェアハウジング、トランザクションログ | 高速なローカルSSDストレージ（インスタンスストア）を搭載し、高いI/O性能が求められるワークロードに適しています。 |
|            | **D**      | 大規模データウェアハウジング、Hadoop、ファイルサーバー   | 大容量のローカルHDDストレージ（インスタンスストア）を搭載し、スループット重視のワークロードに適しています。 |

### インスタンスタイプの選び方

適切なインスタンスタイプを選択することは、コスト最適化とパフォーマンスの維持の両面で非常に重要です。  
以下のポイントを考慮して選択しましょう。  

#### 1. ワークロードの要件を理解する

*   **CPU負荷:** 計算処理が多いか、I/O待ちが多いか。  
    CPU負荷が高い場合はCファミリー、バースト可能なTファミリーなど。  
*   **メモリ使用量:** 扱うデータのサイズや、アプリケーションが消費するメモリ量。  
    メモリ消費が多い場合はR、Xファミリー。  
*   **ストレージI/O:** ディスクへの読み書き頻度とスループット要件。  
    高I/Oが必要な場合はI、Dファミリー、EBS最適化タイプ。  
*   **ネットワーク帯域:** ネットワークトラフィックの量。  
    高帯域が必要な場合は、ネットワーク性能が高いインスタンスタイプを選択。  

#### 2. コストパフォーマンスを考慮する

*   **Tファミリーの活用:** 低〜中程度の利用率でバーストが必要な場合は、Tファミリーが最もコスト効率が良いことが多いです。  
*   **最新世代の利用:** 新しい世代のインスタンスタイプは、同じ性能でより安価であったり、同じコストでより高性能であったりすることが多いです。  
*   **Graviton (Aファミリー) の検討:** ARMベースのGravitonプロセッサは、特定のワークロードでx86ベースのインスタンスよりも高い費用対効果を提供します。  

#### 3. 継続的なモニタリングと最適化

*   **Amazon CloudWatch:** EC2インスタンスのCPU使用率、メモリ使用率（カスタムメトリクス設定）、ネットワークI/Oなどのメトリクスを監視します。  
*   **EC2インスタンスメトリクスによる判断:** 監視データに基づいて、インスタンスタイプが適切かどうかを判断します。  
    *   CPU使用率が常に低いのに、メモリが逼迫している → メモリ最適化タイプへの変更を検討。  
    *   CPU使用率が高すぎる、またはTファミリーのクレジットが枯渇している → コンピューティング最適化タイプ、またはより大きな汎用タイプへの変更を検討。  
*   **定期的な見直し:** ワークロードは時間とともに変化するため、定期的にインスタンスタイプの見直しと最適化を行うことが推奨されます。  

インスタンスタイプは、EC2の柔軟性とコスト効率を最大限に引き出すための重要な設定項目です。  
適切な選択と継続的な最適化により、AWS環境でのシステムのパフォーマンスとコストの両方を最適化できます。  

---

## インスタンスの購入方式

Amazon EC2では、お客様のワークロードの特性や予算に合わせた柔軟な購入方式を提供しています。  
これにより、リソースの需要が予測可能か否か、また持続的な利用か一時的な利用かといった要素に応じて、コストを最適化することが可能です。  

### 1. オンデマンドインスタンス (On-Demand Instances)

#### 特徴とメリット

*   **従量課金:** 利用した時間（秒単位）に対して料金が発生します。  
    最小課金単位は、Linuxが1秒、Windowsが1分です。  
*   **柔軟性:** 事前のコミットメント（契約）は不要です。  
    必要な時にインスタンスを起動し、不要になったら停止または終了するだけで、すぐに課金が停止します。  
*   **初期費用なし:** インスタンスを起動するための初期費用は発生しません。  
*   **汎用性:** 最もシンプルな購入方式であり、全てのインスタンスタイプ、OSで利用可能です。  

#### 用途

*   **開発・テスト環境:** 一時的な利用や、リソース要件が頻繁に変わる環境。  
*   **予測不能なワークロード:** トラフィックの変動が大きく、事前にリソースを予測しにくいWebサイトやアプリケーション。  
*   **短期間のプロジェクト:** 短期間だけ大規模な計算リソースが必要な場合。  
*   **初めてのEC2利用:** まずはオンデマンドで始めて、ワークロード特性を把握してから他の購入方式を検討するのが一般的です。  

### 2. リザーブドインスタンス (Reserved Instances: RI)

#### 特徴とメリット

*   **割引料金:** 1年または3年間の利用をコミット（予約）することで、オンデマンド料金と比較して大幅な割引（最大72%）が適用されます。  
*   **支払いオプション:**  
    *   **全前払い (All Upfront):** 全額を前払いすることで、最も高い割引率が得られます。  
    *   **一部前払い (Partial Upfront):** 一部を前払いし、残りを月々支払います。  割引率は全前払いより低いですが、初期費用を抑えられます。  
    *   **前払いなし (No Upfront):** 前払いなしで、毎月均等に支払います。  割引率は最も低いですが、初期費用はかかりません。  
*   **リソース予約:** 特定のインスタンスタイプ、アベイラビリティゾーン (AZ) を予約することで、そのリソースの利用可能性を確保できます。  

#### 用途

*   **継続的に稼働するワークロード:** データベースサーバー、基幹アプリケーションサーバー、常に一定のトラフィックがあるWebサーバーなど。  
*   **リソース要件が安定しているシステム:** 長期間にわたって同じインスタンスタイプを使い続けることが予測できる場合。  
*   **コスト最適化:** 確実なコスト削減が見込めるため、予算計画に役立ちます。  

#### RIの種類

*   **スタンダードRI:** インスタンスタイプ、OS、テナンシー（専用ホストなど）を固定します。  AZ内でフレキシブルに利用可能です。  
*   **コンバーティブルRI:** インスタンスファミリーやOSは固定されますが、インスタンスタイプやAZを変更できる柔軟性があります。  スタンダードRIより割引率は低いですが、将来の変更に対応できます。  
*   **Dedicated Host RI:** 専用ホストの利用を予約することで、特定の物理サーバーのリソースを確保します。  

### 3. スポットインスタンス (Spot Instances)

#### 特徴とメリット

*   **大幅な割引:** 未使用のEC2キャパシティをAWSから「入札」する形で利用します。  オンデマンド料金と比較して最大90%の大幅な割引が期待できます。  
*   **停止・終了の可能性:** 市場価格（スポット価格）がお客様の設定した「最大スポット料金」を上回った場合、またはAWSにキャパシティが必要になった場合、インスタンスは2分前に通知されて停止または終了される可能性があります。  
*   **中断への耐性:** ワークロードが中断されても問題ない場合に非常に有効です。  

#### 用途

*   **バッチ処理:** 大量のデータ処理、遺伝子解析など、一時的に大規模な計算能力が必要だが、中断されても最初からやり直せる、またはチェックポイントから再開できるワークロード。  
*   **開発・テスト環境:** 中断されても影響が少ないテストやビルド処理。  
*   **データ分析:** 一時的なクラスタを構築してデータ分析を行う場合。  
*   **非同期処理:** キューを通じて処理されるタスクなど、中断に耐性のある設計のアプリケーション。  

### 4. Savings Plans (RIの進化版)

#### 特徴とメリット

*   **柔軟な割引:** RIよりもさらに柔軟性の高い割引モデルです。  
    1年または3年間の「$X/時間」という特定の利用量（ドル建て）をコミットすることで、EC2インスタンスやFargate、Lambdaの利用料に対して割引が適用されます。  
*   **適用範囲の広さ:** インスタンスタイプ、OS、リージョンに関わらず割引が適用されます。  
    例えば、コミットした料金範囲内であれば、m5.largeからc5.xlargeにインスタンスタイプを変更しても割引が継続されます。  
*   **RIからの移行:** RIの柔軟性の低さを解消するために登場したもので、RIに代わる推奨される購入方式となっています。  

#### 用途

*   **変化するワークロード:** インスタンスタイプやリージョンが頻繁に変更される可能性があるが、全体的なコンピューティング利用量は安定している場合。  
*   **ポートフォリオ全体のコスト削減:** EC2だけでなく、FargateやLambdaを含むAWSコンピューティングリソース全体のコストを最適化したい場合。  

### 購入方式の比較まとめ

| 購入方式           | コミットメント | 割引率       | 用途の適性                                      | 中断耐性 | 柔軟性                                           |
| :----------------- | :------------- | :----------- | :---------------------------------------------- | :------- | :----------------------------------------------- |
| **オンデマンド**   | なし           | なし         | 開発/テスト、予測不能なワークロード、一時的な利用 | 高い     | 非常に高い（いつでも起動/停止）                   |
| **リザーブドインスタンス** | 1年/3年        | 最大72%      | 継続的に稼働する安定したワークロード            | 高い     | 低い（一部RIで柔軟性あり）                        |
| **スポットインスタンス** | なし           | 最大90%      | 中断されても問題ないワークロード、バッチ処理    | 低い     | 非常に高い（中断リスクあり）                     |
| **Savings Plans**  | 1年/3年        | 最大72%      | 継続的に稼働するワークロード、インスタンスタイプ変更の可能性あり | 高い     | 高い（インスタンスタイプ、AZ、リージョンを跨いで割引） |

これらの購入方式を適切に組み合わせることで、AWS EC2の利用コストを最大限に最適化し、ビジネス要件に合わせた柔軟なインフラストラクチャを実現できます。  

---

## コスト発生のタイミング

Amazon EC2は、使用したリソースに対してのみ料金を支払う「従量課金制」を基本としています。  
しかし、どの操作がいつ課金につながるのか、また、どのリソースが課金対象となるのかを正確に理解しておくことは、意図しないコスト発生を防ぎ、コストを最適化するために非常に重要です。  

### 1. EC2インスタンス本体の課金

EC2インスタンス本体（CPUとメモリ）の課金は、インスタンスの状態によって大きく異なります。  

#### 1.1. 起動中 (Running) のインスタンス

*   **課金開始:** インスタンスが `running` 状態になった時点から課金が開始されます。  
*   **課金単位:** Linuxインスタンスは秒単位、Windowsインスタンスは分単位で課金されます（最小課金時間は1分）。  
    例えば、Linuxインスタンスを10秒間起動した場合、10秒分の料金が請求されます。  
*   **注意点:** アイドル状態であっても、インスタンスが `running` であれば課金は継続します。  

#### 1.2. 停止 (Stopped) のインスタンス

*   **課金停止:** インスタンスが `stopped` 状態になると、CPUとメモリに対する課金は停止します。  
*   **課金継続:** ただし、インスタンスにアタッチされている **Amazon EBS ボリュームのストレージ料金は継続して発生します。**  
    また、EBSスナップショットやElastic IP (EIP) など、インスタンス本体とは別に存在するリソースの料金も継続します。  
*   **用途:** 一時的にインスタンスの利用を中断したいが、データや設定を保持しておきたい場合に利用します。  

#### 1.3. 終了 (Terminated) のインスタンス

*   **課金停止:** インスタンスが `terminated` (終了) 状態になると、インスタンス本体および通常アタッチされているルートEBSボリュームの課金は基本的に停止します。  
*   **注意点:**  
    *   インスタンス終了時に削除されないように設定された追加のEBSボリュームや、手動で取得したEBSスナップショットの料金は継続して発生します。  
    *   また、アタッチされていないElastic IP (EIP) も引き続き課金対象となります。  
*   **用途:** 不要になったインスタンスを完全に削除し、関連する全てのEC2リソースの課金を停止したい場合に利用します。  

#### まとめ：インスタンスの状態と課金

| インスタンスの状態 | CPU/メモリ料金 | EBSストレージ料金（ルートボリューム） |
| :----------------- | :------------- | :------------------------------------ |
| **Running (起動中)** | 課金中         | 課金中                                |
| **Stopped (停止中)** | 課金なし       | 課金中                                |
| **Terminated (終了済み)** | 課金なし       | 課金なし（※）                        |

※追加のEBSボリュームやEBSスナップショットは別途確認が必要です。  

### 2. ストレージ (EBS) の課金

Amazon EBS (Elastic Block Store) は、EC2インスタンスとは独立して課金されます。  

#### 2.1. EBS ボリューム

*   **課金開始:** EBSボリュームを作成し、プロビジョニングされた容量と種類（例: gp3, io2）に基づいて課金が開始されます。  
*   **課金継続:** インスタンスにアタッチされているか、されていないかに関わらず、またインスタンスが `running`, `stopped`, `terminated` いずれの状態であっても、EBSボリュームが存在し続ける限り課金は継続します。  
*   **注意点:** インスタンスを終了する際に、ルートEBSボリューム以外の追加EBSボリュームが「終了時に削除」設定になっていない場合、そのボリュームは残存し、課金が継続します。  

#### 2.2. EBS スナップショット

*   **課金開始:** EBSスナップショットを作成し、S3に保存されたデータ量に基づいて課金が開始されます。  
*   **課金継続:** 元のEBSボリュームやEC2インスタンスが削除された後も、スナップショットが存在し続ける限り課金は継続します。  
*   **用途:** バックアップや災害対策として利用されます。  不要なスナップショットは定期的に削除することでコストを削減できます。  

### 3. データ転送の課金

データ転送（データアウト）は、EC2の主要なコスト要因の一つです。  

*   **インターネットへのデータ転送アウト:**  
    *   EC2インスタンスからインターネットへ送信されるデータ（Webサイトのアクセス、ファイルのダウンロードなど）は、転送量に応じて課金されます。  
    通常、最初の一定量（例: 1GB）は無料枠があり、それ以降は段階的な料金設定となります。  
    *   **注意点:** 異なるAWSリージョンへのデータ転送も、インターネットへのデータ転送アウトとして課金される場合があります。  
*   **リージョン内でのデータ転送:**  
    *   同じアベイラビリティゾーン内でのデータ転送は通常無料です。  
    *   **異なるアベイラビリティゾーン間** でのデータ転送（例: 異なるAZのEC2インスタンス間の通信）は、課金対象となります。  
*   **AWSサービス内でのデータ転送:**  
    *   S3やRDSなど、他のAWSサービスとのデータ転送にも課金ルールがあります。  
    通常、同じリージョン内であれば無料または低額ですが、異なるリージョン間では課金が発生します。  

### 4. Elastic IP (EIP) の課金

Elastic IP (EIP) は、固定のグローバルIPアドレスを提供するサービスです。  

*   **課金開始:** EIPをAWSアカウントに割り当てた時点から課金が開始されます。  
*   **課金停止:** EIPをEC2インスタンスにアタッチし、そのインスタンスが `running` 状態であれば、通常、EIP自体の料金は発生しません。  
*   **課金継続:**  
    *   EIPがインスタンスに**アタッチされていない**状態の場合。  
    *   EIPがインスタンスにアタッチされているが、そのインスタンスが **`stopped` または `terminated`** 状態の場合。  
    上記のケースでは、IPアドレスリソースの無駄な占有を防ぐために課金が発生します。  
*   **注意点:** EIPは必要な時にのみ保持し、不要な場合は解放することで、意図しない課金を防ぐことができます。  

これらの課金ルールを理解し、適切にリソースを管理することが、AWSコスト最適化の鍵となります。  

---

## 意図しないコスト発生の防止

AWSの従量課金モデルは柔軟性を提供する一方で、リソースの管理を怠ると意図しない高額な請求につながる可能性があります。  
特にEC2は、利用するリソースが多岐にわたるため、コスト発生のメカニズムを理解し、適切な対策を講じることが重要です。  
ここでは、EC2における意図しないコスト発生を防ぐための具体的な方法を解説します。  

### 1. 不要なリソースの停止・削除

これが最も基本的な、そして最も効果的なコスト削減策です。  

#### 1.1. EC2インスタンス

*   **インスタンスの状態管理:**  
    *   開発・テスト環境や、営業時間外は不要なインスタンスは、必ず `stopped` (停止) または `terminated` (終了) します。  
    *   `stopped` 状態でもEBSストレージ料金は発生するため、完全に不要なインスタンスは `terminated` します。  
*   **自動停止・起動の活用:**  
    *   AWS Instance SchedulerやAWS LambdaとCloudWatch Eventsを組み合わせて、指定した時間にインスタンスを自動的に停止・起動する仕組みを導入します。  
    *   これにより、手動での停止忘れを防ぎ、非稼働時間のコストを削減できます。  

#### 1.2. EBSボリューム

*   **デタッチされたボリュームの確認:** `terminated` されたインスタンスからルートボリューム以外のEBSボリュームが切り離されたまま残存し、課金が継続しているケースが多く見られます。  
    定期的に、どのインスタンスにもアタッチされていないEBSボリュームを確認し、不要なものは削除します。  
*   **終了時の削除設定:** インスタンス起動時にEBSボリューム（ルートボリューム以外）を追加する場合、「Termination Protection」と同様に「Delete on Termination」オプションを確認し、インスタンス終了時にEBSボリュームも自動的に削除されるように設定することを検討します。  

#### 1.3. EBSスナップショット

*   **ライフサイクルポリシーの適用:** 古いEBSスナップショットは不要なストレージコストの原因となります。  
    Amazon Data Lifecycle Manager (DLM) を使用して、スナップショットの作成、保持期間、削除を自動化するポリシーを設定します。  
*   **不要なスナップショットの手動削除:** 古いバックアップやテスト用のスナップショットなど、ポリシーではカバーしきれない一時的なスナップショットは定期的に手動で確認し、削除します。  

#### 1.4. Elastic IP (EIP)

*   **未使用EIPの解放:** EIPは、EC2インスタンスにアタッチされ、かつインスタンスが `running` 状態でない限り課金が発生します。  
    アタッチされていないEIPや、`stopped` 状態のインスタンスにアタッチされたEIPは、コスト発生の元凶となりがちです。  
    不要なEIPは速やかに解放します。  

### 2. コスト最適化ツールの活用

AWSが提供する各種ツールやサービスを活用して、コストを監視し、最適化の機会を特定します。  

#### 2.1. AWS Cost Explorer

*   **利用状況の可視化:** どのサービスにどれだけのコストがかかっているかを詳細に分析できます。  
    EC2インスタンスの種類、リージョン、時間帯など、様々な切り口で利用状況を可視化し、異常なコスト増加がないかを確認します。  
*   **RI/Savings Plansの推奨:** 現在のオンデマンド利用状況に基づいて、リザーブドインスタンスやSavings Plansを購入した場合の節約額を提示してくれます。  

#### 2.2. AWS Trusted Advisor

*   **コスト最適化の提案:** AWSアカウント全体を分析し、潜在的なコスト削減の機会やセキュリティの脆弱性などを提案してくれます。  
    特に「Cost Optimization」カテゴリでは、低使用率のEC2インスタンスや未使用のEBSボリュームなどを検出してくれます。  

#### 2.3. AWS Budgets

*   **予算の設定とアラート:** AWSの利用料金に予算を設定し、実際の利用額が予算を超過しそうになった場合や、超過した場合にアラート（メール、SNS通知など）を受け取ることができます。  
    これにより、コストの予期せぬ急増を早期に検知し、対処することが可能になります。  

### 3. 最適なインスタンスタイプの選択と見直し

*   **ワークロードに合わせた選定:** 不要に高性能なインスタンスタイプを選ばないよう、ワークロードのCPU、メモリ、ネットワークなどの要件を正確に把握し、最適なインスタンスタイプを選択します。  
*   **定期的な見直し:** ワークロードは時間とともに変化するため、数ヶ月に一度はインスタンスのパフォーマンスメトリクス（CloudWatchなど）を確認し、オーバースペックなインスタンスやアンダースペックなインスタンスがないかを見直します。  
    より安価で同等性能の新しい世代のインスタンスタイプへの移行も検討します。  
*   **Tファミリーの活用:** CPUを常時フルに使う必要がないWebサーバーや開発環境などでは、Tファミリー（バースト可能インスタンス）がコスト効率に優れています。  

### 4. タグ付け戦略の導入

*   **リソースの識別:** 全てのAWSリソースに「部署」「プロジェクト」「環境（開発/テスト/本番）」などの意味のあるタグを付与します。  
*   **コストの可視化と管理:** タグを使用して、AWS Cost Explorerで特定のプロジェクトや部署ごとのコストをフィルタリング・分析できます。  
    これにより、誰がどのリソースを使用しているのか、どのコストセンターに費用が発生しているのかを明確にし、責任あるコスト管理を促進します。  

### 5. IAMポリシーによる権限の最小化

*   **誤操作の防止:** ユーザーが意図しないリソースを起動したり、必要なリソースを削除したりするのを防ぐため、AWS Identity and Access Management (IAM) を使用して、ユーザーが必要最小限の権限のみを持つようにポリシーを設定します。  
    特に `ec2:TerminateInstances` や `ec2:DeleteVolume` などの危険なアクションは、慎重に権限を付与します。  

これらの対策を総合的に実施することで、EC2および関連リソースにおける意図しないコスト発生を効果的に防止し、AWS環境の運用コストを最適に保つことができます。  

