# EC2におけるストレージ

---

### Amazon Elastic Block Store (EBS) とは

Amazon Elastic Block Store (EBS) は、EC2インスタンスで使用する**永続的なブロックストレージ**サービスです。  
これは、オンプレミス環境における物理サーバーに接続するハードディスクドライブ (HDD) やソリッドステートドライブ (SSD) のようなものと考えるとわかりやすいでしょう。  
EBSボリュームは、EC2インスタンスから独立して存在し、インスタンスが停止または終了してもデータが保持されるため、OSのルートボリュームや、データベース、ファイルシステム、アプリケーションデータなどの永続的な保存領域として利用されます。  

#### EBSの主な特徴

*   **永続性:** インスタンスのライフサイクルとは独立してデータが保持されます。  
*   **ブロックストレージ:** OSからはrawデバイスとして認識され、ファイルシステムを構築して利用します。  
*   **高可用性:** 各EBSボリュームは、特定のアベイラビリティゾーン (AZ) 内で自動的に冗長化され、障害耐性が確保されています。  
*   **高パフォーマンス:** SSDベースのボリュームタイプは、高いI/O性能を提供します。  
*   **スケーラビリティ:** 必要に応じて容量やパフォーマンスを動的に変更できます。  
*   **スナップショット:** ボリュームのバックアップとして、Amazon S3にスナップショットを取得できます。  

### EBSボリュームの種類

EBSには、ワークロードの要件（パフォーマンス、コスト）に応じて、いくつかのボリュームタイプが用意されています。  
主にSSDベースとHDDベースの2種類に大別されます。  

#### SSDベースのボリューム

高パフォーマンスが要求されるトランザクションワークロードに適しています。  

| タイプ   | 性能特性               | 用途の例                                        | 特徴                                                         |
| :------- | :--------------------- | :---------------------------------------------- | :----------------------------------------------------------- |
| **gp3**  | 汎用SSD、コスト効率が良い | ほとんどのワークロード、ブートボリューム、開発/テスト、小規模DB | 新世代の汎用SSDで、容量とは独立してIOPSとスループットをプロビジョニングできます。  gp2よりも低コストで高性能。 |
| **gp2**  | 汎用SSD                | ほとんどのワークロード、ブートボリューム、開発/テスト、小規模DB | 容量に比例してIOPSが向上するタイプ。現在ではgp3への移行が推奨されています。 |
| **io2 Block Express** | 最も高性能なSSD        | 大規模DB、ミッションクリティカルなアプリケーション、HPC | 非常に高いIOPSとスループットを提供します。  特定のEC2インスタンスタイプ（R5bなど）でのみ利用可能。 |
| **io2**  | プロビジョンドIOPS SSD | 大規模DB、ミッションクリティカルなアプリケーション、HPC | 高いIOPSを保証し、特定のパフォーマンスが求められるワークロードに適しています。  |
| **io1**  | プロビジョンドIOPS SSD | 大規模DB、ミッションクリティカルなアプリケーション、HPC | io2の旧世代。io2への移行が推奨されています。               |

#### HDDベースのボリューム

スループット重視で、大容量かつ低コストが求められるワークロードに適しています。  

| タイプ | 性能特性           | 用途の例                                     | 特徴                                                         |
| :----- | :----------------- | :------------------------------------------- | :----------------------------------------------------------- |
| **st1** | スループット最適化HDD | 大規模ログ処理、データウェアハウス、ストリーミング | シーケンシャルI/Oが多く、スループットが重視されるワークロードに適しています。 |
| **sc1** | コールドHDD          | アクセス頻度が低いデータ、長期アーカイブ、バックアップ | 低コストで大容量を提供しますが、スループットはst1よりも低いです。 |

### EBSボリュームの利用方法

1.  **作成:** AWSマネジメントコンソール、CLI、SDKなどを使用してEBSボリュームを作成します。  
    この時、ボリュームタイプ、容量、I/O性能 (gp3, io1/io2の場合) を指定します。  
    EBSボリュームは、必ず特定のAZ内に作成されます。  
2.  **アタッチ:** 作成したEBSボリュームを、同じAZ内のEC2インスタンスにアタッチします。  
    アタッチされると、OSからは `/dev/sdX` のようなデバイス名（Linuxの場合）として認識されます。  
3.  **フォーマットとマウント:** アタッチされたデバイスを、OS上でファイルシステム（ext4, XFS, NTFSなど）でフォーマットし、ディレクトリにマウントして利用可能にします。  
    ルートボリュームは、インスタンス起動時に自動的にフォーマットされ、マウントされます。  
4.  **デタッチ:** インスタンスからEBSボリュームを切り離します。  
    `running` 状態のインスタンスからデタッチする際は、データ整合性のためOS側でアンマウント処理が必要です。  
5.  **削除:** 不要になったEBSボリュームは削除します。  
    削除する前に、必要なデータはスナップショットとして保存しておくことを推奨します。  

### ルートボリュームと追加ボリューム

*   **ルートボリューム:** EC2インスタンスが起動する際にOSやブートローダーが含まれるEBSボリュームです。  
    インスタンス起動時に自動的に作成され、通常はインスタンスを終了すると一緒に削除されます（設定で変更可能）。  
*   **追加ボリューム:** ルートボリューム以外に、アプリケーションデータやユーザーデータなどを保存するためにインスタンスにアタッチするEBSボリュームです。  
    インスタンス終了時に自動的に削除されない設定がデフォルトであり、不要なボリュームが残存し課金が続く原因になることが多いです。  

### EBS最適化インスタンス

一部のインスタンスタイプは、EBS I/O専用の帯域幅を提供する「EBS最適化」機能を持っています。  
これにより、ネットワークトラフィックとEBS I/Oトラフィックが競合することなく、一貫して高いEBSパフォーマンスを維持できます。  
特に高いI/O性能が求められるワークロードでは、EBS最適化インスタンスの利用を検討すべきです。  

EBSは、EC2インスタンスの永続的なデータストレージとして不可欠なサービスであり、その種類や課金、運用方法を理解することは、EC2を効果的かつコスト効率良く利用するために非常に重要です。  

---

## EBS

前回の「ストレージ (EBS)」では、EBSの基本的な概要、種類、そして利用方法について解説しました。  
本項目では、その内容をさらに深掘りし、EBSの主要な機能、運用上のポイント、およびセキュリティに関する詳細について見ていきます。  

### EBSの主要機能と運用

EBSは単にデータを保存するだけでなく、高い可用性、パフォーマンス、セキュリティを提供するための様々な機能を備えています。  

#### 1. データ保護と可用性

EBSボリュームは、その高い耐久性とバックアップ機能によって、データの保護を強力にサポートします。  

*   **アベイラビリティゾーン内での冗長化:**  
    各EBSボリュームは、単一のアベイラビリティゾーン (AZ) 内で自動的に複製され、単一のハードウェア障害に対する保護を提供します。  
    これにより、高い耐久性と可用性を実現しています。  
    ただし、AZ全体の障害には対応できないため、異なるAZへのレプリケーション（スナップショットからの復元や、アプリケーションレベルでの複製）が必要です。  
*   **EBSスナップショット:**  
    EBSボリュームの特定時点の状態をAmazon S3に保存するバックアップ機能です。  
    これはブロックレベルの増分バックアップであり、前回のスナップショットからの変更点のみが保存されるため、効率的にストレージコストを抑えられます。  
    スナップショットは、ボリュームの災害復旧、ボリュームの複製、異なるAZやリージョンへのデータ移動に利用されます。  
    **（スナップショットの詳細については、次項目で詳しく解説します。）**  
*   **リージョン間コピー:**  
    スナップショットは、別のAWSリージョンにコピーすることが可能です。  
    これにより、リージョン規模の災害が発生した場合でも、別のリージョンでデータを復元し、サービスを継続できるような災害対策 (DR) 戦略を構築できます。  

#### 2. パフォーマンスとスケーラビリティ

EBSは、ワークロードの成長や変化に合わせて、パフォーマンスと容量を柔軟に調整できます。  

*   **ボリュームタイプの選択とプロビジョニング:**  
    前述の通り、`gp3`, `io2` などのSSDベースのボリュームタイプは、特定のIOPS (Input/Output Operations Per Second) やスループットをプロビジョニング（予約）することで、一貫した高性能を提供します。  
    例えば、`gp3` ボリュームでは、容量に関わらず独立してIOPSとスループットを設定できるため、コスト効率良く必要な性能を得られます。  
*   **EBS最適化インスタンス:**  
    高いI/O性能を必要とするEC2インスタンスでは、「EBS最適化インスタンス」を使用することが推奨されます。  
    これにより、EBS I/OとEC2インスタンスのネットワークトラフィックが競合せず、EBSに対する専用の帯域幅が確保され、安定した高パフォーマンスを実現します。  
*   **オンラインでのボリューム変更:**  
    稼働中のEC2インスタンスにアタッチされているEBSボリュームの容量、ボリュームタイプ、IOPS、スループットを、**インスタンスを停止することなく**変更できます。  
    これにより、アプリケーションのダウンタイムを最小限に抑えつつ、リソースを柔軟にスケールアップまたはスケールダウンできます。  

#### 3. セキュリティ

EBSは、データの保護を強化するためのセキュリティ機能も提供します。  

*   **EBS暗号化:**  
    EBSボリュームは、AWS Key Management Service (KMS) と連携して簡単に暗号化できます。  
    暗号化されたEBSボリュームに保存されるデータ、ボリュームから作成されるスナップショット、およびスナップショットから復元されるボリュームは、すべて自動的に暗号化されます。  
    これにより、保存中のデータ (data at rest) のセキュリティが強化され、コンプライアンス要件を満たすのに役立ちます。  
    暗号化は、ボリューム作成時に設定するだけで、パフォーマンスへの影響はほとんどありません。  
*   **アクセス制御:**  
    IAMポリシーを使用して、誰がEBSボリュームを作成、アタッチ、変更、削除できるかを細かく制御できます。  

### EBS利用のベストプラクティス

EBSを効果的に活用し、コストを最適化するためのいくつかのベストプラクティスを以下に示します。  

*   **ワークロードに合わせたボリュームタイプの選定:**  
    単に高性能なタイプを選ぶのではなく、アプリケーションのI/O要件を正確に評価し、最も費用対効果の高いボリュームタイプ（例: ほとんどの汎用ワークロードにはgp3）を選択します。  
*   **不要なボリュームの定期的な削除:**  
    終了したインスタンスから切り離されたままのEBSボリュームや、古くて不要なテスト用ボリュームなどがないか、定期的に確認し、削除します。  
    AWS Cost ExplorerやTrusted Advisorで推奨事項を確認することも有効です。  
*   **EBS最適化インスタンスの利用:**  
    高いI/O性能が求められる場合は、必ずEBS最適化インスタンスタイプを選択し、安定したパフォーマンスを確保します。  
*   **EBS暗号化の活用:**  
    セキュリティ強化とコンプライアンス遵守のため、可能であれば全てのEBSボリュームを暗号化することを標準とします。  
*   **スナップショットとライフサイクル管理:**  
    定期的なスナップショットの取得と、不要になったスナップショットの自動削除をAmazon Data Lifecycle Manager (DLM) などで自動化し、バックアップ戦略とコストを最適化します。  

EBSは、EC2インスタンスの心臓部とも言えるストレージであり、その適切な理解と運用が、アプリケーションの安定稼働とコスト効率を大きく左右します。  

---

## スナップショット

### EBSスナップショットとは

EBSスナップショットは、Amazon EBSボリュームの特定の時点の状態を、Amazon S3に保存するバックアップ機能です。  
これは、ボリューム全体の完全なコピーではなく、**ブロックレベルの増分バックアップ**という特徴を持ちます。  
つまり、初回はボリューム全体のデータをS3に保存しますが、2回目以降は前回のスナップショットからの変更点のみが保存されます。  
これにより、ストレージ容量とコストを効率的に節約しつつ、迅速にバックアップを取得できます。  

#### スナップショットの主な用途

*   **データのバックアップとリカバリ:** 災害発生時やデータ破損時に、以前のスナップショットから新しいEBSボリュームを復元し、EC2インスタンスにアタッチすることで、システムを復旧できます。  
*   **ボリュームの複製:** 既存のEBSボリュームと同じ内容を持つ新しいボリュームを、別のAZやリージョンに作成するために利用できます。  
*   **AMI (Amazon Machine Image) の作成:** EC2インスタンスのOSやアプリケーション設定を含むカスタムAMIを作成する際に、そのインスタンスにアタッチされているEBSボリュームのスナップショットが内部的に利用されます。  
*   **開発・テスト環境のプロビジョニング:** 本番環境のデータに近いテスト環境を素早く構築するために、本番ボリュームのスナップショットから新しいボリュームを作成することが可能です。  

### スナップショットの仕組み

#### 1. 増分バックアップ

*   **初回スナップショット:** ボリューム上のすべてのブロックをS3にコピーします。  
*   **2回目以降のスナップショット:** 前回のスナップショットからの変更点（変更されたブロック）のみをS3にコピーします。  
    これにより、スナップショット取得にかかる時間とストレージコストが大幅に削減されます。  
*   **復元:** スナップショットからボリュームを復元する際には、AWSは必要な増分データと、最初の完全なスナップショットを組み合わせて、指定された時点の完全なボリュームを作成します。  
    ユーザーは増分バックアップであることを意識することなく、いつでも完全なボリュームとして復元できます。  

#### 2. S3への保存

EBSスナップショットは、内部的にAmazon S3に保存されます。  
S3は高い耐久性と可用性を誇るストレージサービスであり、スナップショットの信頼性を担保しています。  
ユーザーはS3バケットを直接操作する必要はなく、EBSサービスを通じてスナップショットを管理します。  

### スナップショットの取得と管理

#### 1. 手動での取得

AWSマネジメントコンソール、AWS CLI、SDKなどを使用して、任意のタイミングで実行中のEBSボリュームからスナップショットを取得できます。  
通常、取得時にはボリュームの一貫性を保つため、アプリケーションを一時的に停止するか、ファイルシステムをフリーズさせるなどの対応が推奨されますが、多くの場合オンラインで取得可能です。  

#### 2. Amazon Data Lifecycle Manager (DLM) による自動化

定期的なバックアップ作業は、手動で行うと忘れがちになったり、運用負担が増大したりします。  
Amazon Data Lifecycle Manager (DLM) を使用することで、EBSボリュームのバックアップポリシー（スナップショットの作成頻度、保持期間、リージョン間コピーなど）を自動化できます。  

*   **メリット:**  
    *   **運用負荷の軽減:** バックアップ作業の自動化により、運用担当者の手間を削減します。  
    *   **RPO/RTOの改善:** 定期的なバックアップにより、目標復旧時点 (RPO) と目標復旧時間 (RTO) を改善できます。  
    *   **コスト最適化:** 不要な古いスナップショットを自動的に削除することで、ストレージコストを抑制します。  

#### 3. コストの考慮事項

*   **ストレージ料金:** スナップショットは、S3に保存されているデータ量に基づいて課金されます。  
    増分バックアップであるため、ボリューム全体の容量ではなく、実際に変更されたデータ量に対して料金が発生します。  
*   **不要なスナップショットの削除:** 古くなったり、テスト用途で作成されたりした不要なスナップショットが残存していると、意図しないコストが発生し続ける可能性があります。  
    DLMポリシーを設定するか、定期的に確認して削除することが重要です。  
*   **リージョン間コピーの料金:** スナップショットを別のリージョンにコピーする場合、データ転送コストとコピー先リージョンでのストレージコストが発生します。  

### スナップショットとセキュリティ

*   **暗号化:** オリジナルのEBSボリュームが暗号化されている場合、そこから作成されるスナップショットも自動的に暗号化されます。  
    また、暗号化されていないボリュームのスナップショットを暗号化することも可能です。  
    これにより、保存中のデータ (data at rest) のセキュリティが強化されます。  
*   **アクセス制御と共有:** IAMポリシーを使用して、スナップショットの作成、削除、復元、共有に関する権限を細かく制御できます。  
    スナップショットを他のAWSアカウントと共有することも可能ですが、その際はセキュリティ上のリスクを十分に考慮する必要があります。  

EBSスナップショットは、EC2インスタンスで稼働するアプリケーションのデータ保護と災害対策において、極めて重要な役割を果たすサービスです。  
適切なスナップショット戦略とライフサイクル管理を導入することで、データの可用性と信頼性を高めつつ、コスト効率の良い運用を実現できます。  

---

## インスタンスストア

### インスタンスストアとは

インスタンスストアは、EC2インスタンスが稼働する**物理ホストマシンに直接アタッチされた一時的なブロックストレージ**です。  
これは、EBSがネットワーク経由で接続される永続ストレージであるのに対し、インスタンスストアは物理的にEC2インスタンスと同じサーバー内に存在するため、非常に高速なディスクI/O性能を提供します。  
しかし、その最大の特性は**一時的**であることです。  

#### インスタンスストアの主な特徴

*   **一時的なストレージ:** インスタンスが `stopped` (停止) または `terminated` (終了) されると、インスタンスストアに保存されていたデータは**すべて失われます。**  
    また、基盤となる物理ホストマシンで障害が発生した場合もデータは失われる可能性があります。  
*   **物理的なアタッチ:** EC2インスタンスが稼働する物理ホストサーバーのローカルディスクを使用します。  
*   **高パフォーマンス:** 物理ディスクに直接アクセスするため、非常に低いレイテンシと高いI/Oスループットを実現します。  
*   **料金:** インスタンスストアの利用料金は、対応するインスタンスタイプの料金に含まれており、追加のストレージ費用は発生しません。  

#### 注意点

インスタンスストアは、その一時的な性質から、**永続的なデータの保存には絶対に適しません。**  
重要なデータは、EBS、S3、RDSなどの永続ストレージサービスに保存する必要があります。  

### インスタンスストアが利用可能なインスタンスタイプ

すべてのEC2インスタンスタイプがインスタンスストアを提供するわけではありません。  
主に、高I/O性能が求められる、あるいは一時的な大容量ストレージが必要な特定のインスタンスファミリー（例: `I`, `D`, `M5ad`, `C5ad` など、名前に `d` が付くものやストレージ最適化タイプ）で利用できます。  

例えば、`i3.xlarge` のようなインスタンスタイプは、高性能なNVMe SSDベースのインスタンスストアを提供し、高速なディスクアクセスが求められるワークロードに適しています。  

### インスタンスストアのユースケース

その特性から、インスタンスストアは以下のような特定のワークロードで効果的に活用されます。  

#### 1. キャッシュ、スクラッチデータ、バッファリング

*   **一時的なデータ処理:** 大量のデータを一時的に処理し、結果だけを永続ストレージに保存するようなETL (Extract, Transform, Load) 処理やバッチ処理。  
*   **Webサーバーのキャッシュ:** 動的コンテンツのキャッシュ、セッション情報の一時的な保存など、高速な読み書きが求められるが、永続性が必要ないデータ。  
*   **検索エンジンインデックス:** Elasticsearchなどの検索エンジンのインデックスデータで、レプリケーションにより可用性を確保できる場合。  

#### 2. 分散データベースのレプリカ

*   **MongoDB, Cassandraなど:** レプリケーション機能を持ち、複数のノード間でデータを同期することで、単一ノードの障害時でもデータ損失を防げる分散データベースにおいて、一時的なデータストアとして利用されることがあります。  
    これにより、非常に高いI/O性能と低コストでデータベースを実行できます。  

#### 3. 高性能コンピューティング (HPC)

*   **シミュレーション、数値計算:** 計算の中間結果や一時的な大規模ファイルを保存し、高速にアクセスする必要がある科学技術計算。  
*   **レンダリング:** 大量の画像や動画データの一時的な処理。  

#### 4. データウェアハウス (分析)

*   **データレイクのステージング:** 大量の生データを一時的に保存し、分析処理のために高速にアクセスする場合。  
*   **Hadoop / Spark:** Hadoop Distributed File System (HDFS) やSparkのキャッシュ層として、一時的なデータブロックを高速に保存・処理する場合。  

### インスタンスストアの管理と監視

*   **フォーマットとマウント:** インスタンスストアは、EC2インスタンスにアタッチされた後、EBSボリュームと同様にOS上でファイルシステムでフォーマットし、マウントすることで利用可能になります。  
*   **モニタリング:** CloudWatchでインスタンスストアのディスクI/O性能（読み込み/書き込みオペレーション、バイト数）を監視し、ボトルネックがないかを確認できます。  
*   **データ保護の戦略:** インスタンスストアに保存されたデータは失われる可能性があるため、常に「揮発性データ」として扱い、重要なデータは永続ストレージに定期的に同期するか、レプリケーションによって保護する戦略が必須です。  

EBSが「永続的な保管庫」であるのに対し、インスタンスストアは「高速な一時作業スペース」と考えると、その違いと適切な利用方法が明確になります。  
ワークロードの特性を理解し、EBSとインスタンスストアを適切に使い分けることが、EC2を効率的に利用する鍵となります。  

---

## EBSとインスタンスストアどちらを選択するか

EC2インスタンスのストレージとして、Amazon Elastic Block Store (EBS) とインスタンスストアの2つの主要な選択肢があります。  
それぞれ異なる特性を持つため、ワークロードの要件を正確に理解し、適切に選択することがパフォーマンス、可用性、そしてコスト効率を最適化する上で非常に重要です。  

### 選択の基本原則

最も重要な違いは、**データの永続性**と**パフォーマンス特性**です。  

*   **EBS:** データ永続性を重視し、かつ柔軟なパフォーマンス設定が必要な場合に選択します。  
*   **インスタンスストア:** 非常に高いI/O性能が求められ、かつデータの一時性（揮発性）が許容される場合に選択します。  

### EBSとインスタンスストアの比較表

両者の主要な違いを以下の表にまとめます。  

| 特性           | EBS (Elastic Block Store)                       | インスタンスストア (Instance Store)                   |
| :------------- | :---------------------------------------------- | :---------------------------------------------------- |
| **永続性**     | **永続的**                                      | **一時的（揮発性）**                                  |
| **データ保持** | インスタンスの停止/終了後もデータは保持される。       | インスタンスの停止/終了/物理ホスト障害でデータは失われる。 |
| **接続方法**   | ネットワーク経由で接続される。                    | 物理ホストマシンに直接アタッチされる。                |
| **パフォーマンス** | ボリュームタイプにより変動。高いIOPS/スループットをプロビジョニング可能。 | 非常に高いIOPS/スループット、低いレイテンシ。          |
| **スケーラビリティ** | 容量、タイプ、IOPSなどをオンラインで変更可能。       | インスタンスタイプに固定され、変更不可。              |
| **可用性/耐久性** | AZ内で冗長化され、高い耐久性。スナップショットによるバックアップ可能。 | 基盤ホストに依存。単一障害点となる可能性がある。        |
| **課金**       | プロビジョニングされた容量とI/O性能に対して別途課金。 | インスタンス料金に含まれる。追加費用なし。            |
| **ユースケース** | OSのルートボリューム、データベース、ファイルシステム、重要なアプリケーションデータ | キャッシュ、スクラッチデータ、バッファリング、分散DBのレプリカ、HPCの中間データ |

### どちらを選択すべきかの判断基準

#### 1. データの永続性

*   **必須の場合（EBSを選択）:**  
    *   OSのルートボリューム（必須）。  
    *   リレーショナルデータベース（MySQL, PostgreSQL, SQL Serverなど）。  
    *   重要なアプリケーションデータ、ログファイル、設定ファイル。  
    *   インスタンスを停止してもデータが残る必要のある開発・テスト環境。  
    *   ファイルサーバーや共有ストレージ。  
    **→ ほとんどの基幹システムやビジネスデータはEBSに保存すべきです。**  

*   **不要な場合（インスタンスストアを検討）:**  
    *   一時的なキャッシュ、バッファ、スクラッチファイル。  
    *   計算処理の中間データ。  
    *   分散システムの一部であり、他のノードでデータがレプリケートされているため、単一ノードのデータ損失が許容される場合（例: MongoDB, Cassandraのレプリカ、HDFSデータノード）。  
    *   テスト/開発環境で、インスタンス停止時に状態をリセットしたい場合。  

#### 2. パフォーマンス要件

*   **高いI/O性能と低レイテンシが必要な場合（インスタンスストアを検討）:**  
    *   超高速なデータ読み書きが求められるリアルタイム分析。  
    *   HPC (高性能コンピューティング) の一時ファイル。  
    *   キャッシュやログ処理で、秒単位で大量のI/Oが発生するワークロード。  
    **→ インスタンスストアはEBSよりも一般的に高いI/O性能を提供しますが、EBSも`io2 Block Express`のような超高性能タイプがあります。**  
    **EBS最適化インスタンスと適切なEBSボリュームタイプを選択することで、多くの高性能要件を満たすことができます。**  

#### 3. コスト

*   **初期費用を抑えたい、またはI/O性能を細かく制御したい場合（EBS）:**  
    EBSは容量とI/O性能に対して個別に課金されますが、必要な分だけプロビジョニングできるため、無駄なコストを抑えやすいです。  
*   **インスタンス自体が短期間で破棄される前提で、最大性能を安価に利用したい場合（インスタンスストア）:**  
    インスタンスストアはインスタンス料金に含まれるため、追加費用なしでそのインスタンスが提供する最高のI/O性能を得られます。  
    ただし、永続性がないため、中断されても問題ないワークロードに限られます。  

### 併用による最適化

多くの場合、EBSとインスタンスストアは排他的ではなく、**併用することで最適な環境を構築できます。**  

*   **ルートボリューム:** 常にEBSを使用します。  
*   **アプリケーションデータ、データベース:** 永続性が必要なためEBSを使用します。  
*   **キャッシュ、一時ファイル:** 高速なアクセスが必要な場合は、インスタンスストアをデータ損失が許容される範囲で活用します。  
    例えば、Webサーバーの静的コンテンツキャッシュや、動画エンコードの中間データなど。  

**例:**  
Webサーバーの場合、OSとWebアプリケーションのコードはEBSに置き、セッション情報や一時的なキャッシュはインスタンスストアに置くことで、高速化と永続性の両立を図ることができます。  

### まとめ

| 選択基準     | EBSを選択するケース                                           | インスタンスストアを選択するケース                          |
| :----------- | :------------------------------------------------------------ | :---------------------------------------------------------- |
| **永続性**   | データが永続的に保持される必要がある。                        | データ損失が許容される、またはレプリケーションで保護される。 |
| **パフォーマンス** | 高いI/O性能が必要だが、ネットワーク経由でも問題ない。柔軟なパフォーマンス調整が必要。 | 物理的な最高速I/Oが必須。超低レイテンシが求められる。      |
| **コスト**   | 容量やIOPSを細かく制御し、コストを最適化したい。              | インスタンスタイプに含まれる最高のI/O性能を、追加費用なしで利用したい。 |
| **可用性**   | 高い可用性（AZ内冗長化）とスナップショットによるバックアップが必要。 | インスタンスの障害によるデータ損失を許容できる。          |

これらの要素を総合的に考慮し、それぞれのストレージの利点を最大限に引き出すことで、効果的なEC2インスタンスの運用を実現しましょう。  

---

## S3やEFSとの違い

ここまで、EC2インスタンスに直接アタッチされるストレージとして、EBS（永続的なブロックストレージ）とインスタンスストア（一時的なブロックストレージ）について解説しました。  
しかし、AWSにはEC2インスタンスと連携する他のストレージサービスも存在します。  
ここでは、Amazon S3 (Simple Storage Service) と Amazon EFS (Elastic File System) がEBSやインスタンスストアとどのように異なり、どのような用途で利用されるのかを比較しながら解説します。  

### EC2インスタンスのストレージ再確認

まずは、これまでのEC2ストレージの理解を再確認しましょう。  

*   **EBS (Elastic Block Store):**  
    *   **タイプ:** ブロックストレージ  
    *   **接続:** EC2インスタンスにネットワーク経由で「1対1」でアタッチされ、OSからディスクドライブとして認識されます。  
    *   **永続性:** インスタンスの停止・終了後もデータは保持されます。  
    *   **用途:** OSのルートボリューム、データベース、アプリケーションの永続データ。  
*   **インスタンスストア (Instance Store):**  
    *   **タイプ:** ブロックストレージ  
    *   **接続:** EC2インスタンスが稼働する物理ホストに直接アタッチされます。  
    *   **永続性:** インスタンスの停止・終了、または物理ホストの障害でデータは失われます（一時的）。  
    *   **用途:** 高速なキャッシュ、スクラッチデータ、一時的なバッファ。  

これに対し、S3とEFSは異なる特性とユースケースを持っています。  

### Amazon S3 (Simple Storage Service) とは

Amazon S3は、インターネット上で利用できる、高い耐久性と可用性を持つ**オブジェクトストレージ**サービスです。  
ファイルやデータを「オブジェクト」としてバケットに保存し、HTTP/HTTPSプロトコル経由でアクセスします。  

#### S3の主な特徴

*   **オブジェクトストレージ:**  
    データはファイルシステム階層ではなく、「キーとバリュー（オブジェクト）」の形式で保存されます。  
    ファイルサイズは0バイトから最大5TBまで対応し、ファイル名（キー）とデータ（バリュー）に加えて、メタデータも保存できます。  
*   **無制限のスケーラビリティ:**  
    ストレージ容量は事実上無制限であり、必要に応じて自動的に拡張されます。  
    ユーザーは容量を事前にプロビジョニングする必要がありません。  
*   **非常に高い耐久性と可用性:**  
    99.999999999% (イレブンナイン) の耐久性と、99.99%の可用性を提供し、データ損失のリスクが極めて低いです。  
*   **APIアクセスとHTTP/HTTPS:**  
    WebアプリケーションやCLI、SDKを通じてAPIでアクセスします。  
    公開設定すれば、Webブラウザから直接URLでアクセスすることも可能です（静的Webサイトホスティング）。  
*   **低コストのアーカイブクラス:**  
    Glacierなどのストレージクラスを利用することで、長期保存やアーカイブ用途で非常に低コストに利用できます。  
*   **ファイルシステムとしての利用不可:**  
    S3はファイルシステムとしてはマウントできません（FUSEなどを利用した擬似的なマウントは可能ですが、ネイティブではありません）。  
    OSやアプリケーションから直接読み書きするには、API呼び出しが必要です。  

#### S3の主要なユースケース

*   **静的Webサイトホスティング:** HTML、CSS、JavaScript、画像などの静的コンテンツの配信。  
*   **バックアップとアーカイブ:** データベースのバックアップ、ログファイル、重要文書の長期保存。  
*   **データレイク:** 大規模な生データ（ログ、IoTデータ、分析データ）の一元的な保存場所。  
*   **メディアファイルの保存:** 画像、動画、音声などのメディアコンテンツの保存と配信。  

### Amazon EFS (Elastic File System) とは

Amazon EFSは、EC2インスタンスやオンプレミスサーバーから、NFS (Network File System) プロトコルを使用してアクセスできる、**フルマネージド型のファイルストレージ**サービスです。  
複数のEC2インスタンスから同時にアクセス・共有できる点が大きな特徴です。  

#### EFSの主な特徴

*   **ファイルストレージ:**  
    従来のファイルシステム（ディレクトリ、ファイル、パーミッションなど）として機能し、NFSプロトコルを通じてマウントできます。  
*   **複数のEC2インスタンスからの共有:**  
    異なるAZにある複数のEC2インスタンスから同時に同じEFSファイルシステムにマウントし、データを共有できます。  
    これはEBSが1つのインスタンスにしかアタッチできない点と大きく異なります。  
*   **エラスティックなスケーラビリティ:**  
    容量とパフォーマンスが自動的に拡張・縮小します。  
    ストレージ容量を事前にプロビジョニングする必要がなく、使用した分だけ課金されます。  
*   **高い可用性と耐久性:**  
    データは複数AZに冗長化して保存され、高い可用性と耐久性を提供します。  
*   **POSIX準拠:**  
    NFSv4.0およびNFSv4.1プロトコルをサポートし、POSIX準拠のファイルシステムインターフェースを提供します。  
*   **料金:**  
    保存されているデータ量と、データアクセス量に基づいて課金されます。  

#### EFSの主要なユースケース

*   **共有ファイルシステム:** 複数のWebサーバーやアプリケーションサーバー間で共通のコンテンツ（例: WordPressのテーマやプラグイン、アップロードファイル）を共有。  
*   **開発・テスト環境:** 開発チームが共有するコードリポジトリやビルド成果物の保存。  
*   **コンテンツ管理システム:** CMSのファイルストレージ。  
*   **ビッグデータ分析:** Apache HadoopやSparkクラスタで共有データにアクセスする場合。  
*   **コンテナワークロード:** Amazon ECS/EKSのコンテナから永続的な共有ストレージとして利用。  

### EBS、インスタンスストア、S3、EFSの比較まとめ

主要なストレージサービスの特性を比較します。  

| 特性           | EBS (ブロック)                            | インスタンスストア (ブロック)                 | S3 (オブジェクト)                           | EFS (ファイル)                             |
| :------------- | :---------------------------------------- | :------------------------------------------ | :------------------------------------------ | :----------------------------------------- |
| **ストレージタイプ** | ブロックストレージ                        | ブロックストレージ                          | オブジェクトストレージ                      | ファイルストレージ                         |
| **データの永続性** | 永続的                                    | 一時的 (インスタンス停止/終了でデータ消失) | 永続的                                      | 永続的                                     |
| **接続方法/プロトコル** | ネットワーク経由 (`/dev/sdX`)           | 物理ホストに直接 (`/dev/nvmeXn1`)           | HTTP/HTTPS (API)                            | NFSv4.0/4.1 (マウント)                     |
| **同時アクセス/共有** | 単一のEC2インスタンス                   | 単一のEC2インスタンス                     | 複数サービス/クライアントから同時アクセス | 複数のEC2インスタンスから同時マウント    |
| **スケーラビリティ** | ボリュームごとに設定、オンライン変更可能 | インスタンスタイプに固定                  | 無制限                                      | 自動的にスケーリング (容量・性能)          |
| **主なユースケース** | OS、DB、アプリケーションデータ          | キャッシュ、スクラッチデータ、HPC中間データ | 静的Web、バックアップ、データレイク       | 複数インスタンス共有データ、CMS、開発ツール |
| **料金体系**   | プロビジョニング容量とI/O性能で課金     | インスタンス料金に含まれる                | 保存容量、データ転送量、リクエスト数で課金 | 保存容量、データアクセス量で課金         |

### 各ストレージの使い分けシナリオ

*   **EC2インスタンスのOSやアプリケーションの実行ファイル、リレーショナルデータベースのデータ:**  
    **EBS** を使用します。  永続性、ブロックレベルアクセス、高いI/O性能が要求されるためです。  
*   **Webサーバーのログファイルや画像ファイルの一時的なキャッシュ、大量の計算処理の中間データ:**  
    **インスタンスストア** を検討します。  非常に高速なI/Oが必要で、データが一時的であるか、他の場所でバックアップ・レプリケートされている場合に適しています。  
*   **Webサイトの静的コンテンツ（画像、動画）、ユーザーがアップロードしたファイル、システムのバックアップ、分析用の生データ:**  
    **S3** を使用します。  無制限の容量、高い耐久性、Webからの直接アクセス、コスト効率の良い長期保存が強みです。  
*   **複数のWebサーバーやアプリケーションサーバーで共有する設定ファイル、WordPressのメディアライブラリ、CI/CDツールの共有成果物、開発チームのホームディレクトリ:**  
    **EFS** を使用します。  ファイルシステムとしての使いやすさ、複数インスタンスからの同時共有、容量・性能の自動スケーリングが大きなメリットです。  

このように、AWSのストレージサービスはそれぞれ異なる特性を持つため、ワークロードの要件に応じて最適なサービスを選択し、組み合わせて利用することが、効率的で堅牢なシステム構築の鍵となります。  
