
# VPCとネットワーク

---

## サブネット

### 概要

サブネットは、VPCのIPアドレス範囲をさらに小さな区画に分割したものです。  
AWSリソース（EC2インスタンス、RDSデータベースなど）は、このサブネット内にデプロイされます。  
サブネットは、ネットワークの論理的な区切りとして機能し、リソースの配置、アクセス制御、および耐障害性を考慮した設計において非常に重要な要素となります。  

### サブネットとアベイラビリティーゾーン (AZ)

AWSの各リージョンは、複数のアベイラビリティーゾーン (AZ) で構成されています。  
AZは、互いに物理的に分離された独立したデータセンター群であり、高い耐障害性を提供します。  

*   **1対1の関係**: 各サブネットは、必ず1つのAZに属します。  
    これは、特定のサブネット内のリソースがそのAZ内で起動されることを意味します。  
*   **高可用性**: アプリケーションの可用性を高めるためには、複数のAZにサブネットを作成し、それぞれにリソースを分散配置する設計が推奨されます。  
    例えば、Webサーバーを複数のAZにあるパブリックサブネットに配置することで、単一のAZ障害時でもサービスを継続できます。  

### サブネットの種類：パブリックとプライベート

サブネットは、インターネットへの直接的な接続が可能かどうかによって、「パブリックサブネット」と「プライベートサブネット」の2種類に大別されます。  

#### パブリックサブネット

*   **特徴**: インターネットゲートウェイ (IGW) へのルート（デフォルトゲートウェイ`0.0.0.0/0`がIGWを指す）を持つサブネットです。  
    このサブネットに配置されたリソースは、パブリックIPアドレスまたはElastic IPアドレスを持つことで、インターネットと直接通信できます。  
*   **用途**: 一般的に、外部からのアクセスが必要なWebサーバー、ロードバランサー (ALB/NLB)、NATゲートウェイなどが配置されます。  
    インターネットに直接公開される層（フロントエンド）を構成します。  

#### プライベートサブネット

*   **特徴**: インターネットゲートウェイへの直接的なルートを持たないサブネットです。  
    このサブネットに配置されたリソースは、インターネットから直接アクセスされることがありません。  
*   **用途**: セキュリティ上、外部に公開すべきでないデータベースサーバー、アプリケーションサーバー、内部APIなどが配置されます。  
    インターネットへのアウトバウンド通信が必要な場合は、NATゲートウェイやNATインスタンスを介して行われます。  

#### 比較表

| 特徴                 | パブリックサブネット                                   | プライベートサブネット                                 |
| :------------------- | :----------------------------------------------------- | :----------------------------------------------------- |
| **インターネット接続** | インターネットゲートウェイ経由で直接接続可能         | インターネットゲートウェイへの直接ルートなし             |
| **ルーティング**     | デフォルトルートがインターネットゲートウェイを指す   | デフォルトルートはNATゲートウェイなどを指すか、存在しない |
| **IPアドレス**       | パブリックIPアドレス/EIPを割り当て可能               | プライベートIPアドレスのみ                           |
| **主な用途**         | Webサーバー、ロードバランサー、NATゲートウェイ       | DBサーバー、アプリケーションサーバー、内部処理サーバー |
| **セキュリティ**     | 外部からのアクセス制御に特に注意が必要               | 内部リソースの保護、外部からの直接アクセスを遮断       |

### サブネットのIPアドレス割り当て

VPCを作成する際に指定したCIDRブロックから、各サブネットのCIDRブロックを切り出して割り当てます。  
例えば、`10.0.0.0/16` のVPC内に、以下のようなサブネットを作成できます。  

*   AZ-Aのパブリックサブネット: `10.0.1.0/24`  
*   AZ-Aのプライベートサブネット: `10.0.2.0/24`  
*   AZ-Bのパブリックサブネット: `10.0.11.0/24`  
*   AZ-Bのプライベートサブネット: `10.0.12.0/24`  

#### 予約済みのIPアドレス

AWSは、各サブネットのCIDRブロックから5つのIPアドレスを内部的に予約します。  
これらのIPアドレスは、リソースに割り当てることはできません。  

| IPアドレスのオフセット | 用途                                     |
| :--------------------- | :--------------------------------------- |
| `.0`                   | ネットワークアドレス                     |
| `.1`                   | VPCルーター用                            |
| `.2`                   | DNSサーバー用                            |
| `.3`                   | 将来の利用のために予約済み               |
| `.255`                 | ネットワークブロードキャストアドレス（現在は未使用） |

したがって、例えば`/24`のサブネット（256個のIPアドレス）を作成した場合、実際にリソースに割り当て可能なIPアドレスは251個となります。  

### サブネットのセキュリティ

サブネットは、VPCのセキュリティ設計における重要な境界の一つです。  
以下のセキュリティ機能がサブネットに関連付けられます。  

*   **ネットワークACL (NACL)**: サブネットレベルでインバウンドおよびアウトバウンドのトラフィックを制御するステートレスなファイアウォールです。  
    特定のサブネットへのアクセスを許可または拒否するために使用されます。  
*   **セキュリティグループ**: サブネット内の個々のリソース（EC2インスタンスなど）に適用されるステートフルなファイアウォールです。  
    NACLと連携し、多層防御を実現します。  

これらのセキュリティ要素については、後続の項目で詳しく解説します。  

### まとめ

サブネットは、VPC内でリソースを論理的に整理し、アベイラビリティーゾーンを考慮した高可用性設計を可能にする基盤です。  
パブリックとプライベートの区別、適切なIPアドレス範囲の割り当て、そしてAZ間の分散配置は、VPC設計の初期段階で慎重に検討すべき重要なポイントとなります。  
これらの設計が、アプリケーションのセキュリティ、スケーラビリティ、および可用性に大きく影響します。

## インターネットゲートウェイ

### 概要

インターネットゲートウェイ (Internet Gateway, IGW) は、VPCとインターネット間の通信を可能にするために不可欠なVPCコンポーネントです。  
これは、VPC内のリソースがインターネットに接続したり、インターネット上のリソースからVPC内のリソースにアクセスしたりするための「玄関」のような役割を果たします。  
IGW自体は、AWSによって完全に管理される高可用性かつスケーラブルなサービスであり、その運用を意識する必要はありません。  

### インターネットゲートウェイの役割

IGWは、VPCにおいて以下の主要な役割を担います。  

*   **インターネットへの接続性の提供**: VPC内のリソースがインターネット上のWebサイト、API、SaaSサービスなどと通信できるようにします。  
*   **パブリックIPアドレスの変換**: パブリックIPアドレスまたはElastic IPアドレス (EIP) が割り当てられたVPC内のEC2インスタンスなどのリソースに対して、インターネットと通信するためのネットワークアドレス変換 (NAT) を実行します。  
    これにより、インスタンスのプライベートIPアドレスとパブリックIPアドレス間のマッピングを処理し、外部からのアクセスや外部へのアクセスを可能にします。  
*   **ルーティングターゲット**: ルートテーブルにおいて、インターネット宛のトラフィック（通常は`0.0.0.0/0`）のターゲットとして指定されます。  
    これにより、VPC内のサブネットからインターネットへのトラフィックがIGWを経由してルーティングされます。  

### インターネットゲートウェイの特性

| 特性           | 説明                                                                                             |
| :------------- | :----------------------------------------------------------------------------------------------- |
| **冗長性と高可用性** | AWSによって管理されており、単一障害点とならないように設計されています。                             |
| **スケーラビリティ** | インターネットトラフィックの増減に合わせて自動的にスケールアップ/ダウンするため、帯域幅の心配はほとんどありません。 |
| **ステートフル** | インバウンドトラフィックとアウトバウンドトラフィックの両方を処理し、関連する応答トラフィックは自動的に許可されます。 |
| **1VPCあたり1つ** | 1つのVPCにアタッチできるインターネットゲートウェイは1つだけです。                                  |
| **料金**       | インターネットゲートウェイ自体の利用には費用はかかりません。データ転送量に応じて料金が発生します。     |

### インターネットゲートウェイの設定手順（概念）

インターネットゲートウェイをVPCに設定して利用するには、以下のステップが必要です。  

1.  **インターネットゲートウェイの作成**: まず、AWSマネジメントコンソールやCLIからインターネットゲートウェイを作成します。  
2.  **VPCへのアタッチ**: 作成したインターネットゲートウェイを、インターネット接続を有効にしたいVPCにアタッチします。  
3.  **ルートテーブルの設定**: パブリックサブネットに関連付けられたルートテーブルに、インターネットゲートウェイをターゲットとするデフォルトルート (`0.0.0.0/0`) を追加します。  
    これにより、そのサブネットからのインターネット宛のトラフィックがIGWを経由するようになります。  
4.  **リソースのパブリックIP割り当て**: パブリックサブネットに配置するEC2インスタンスなどには、パブリックIPアドレスまたはElastic IPアドレスを割り当てる必要があります。  
5.  **セキュリティ設定**: セキュリティグループやネットワークACLで、必要なポートとプロトコルをインターネットからのアクセスに対して開放します。  

### インターネットゲートウェイとNATゲートウェイの違い

VPCのコンポーネントとして、インターネットとの通信に関連するものに「NATゲートウェイ」があります。  
両者の違いを明確に理解することが重要です。  

| 項目         | インターネットゲートウェイ (IGW)                                   | NATゲートウェイ                                                    |
| :----------- | :----------------------------------------------------------------- | :----------------------------------------------------------------- |
| **目的**     | パブリックサブネットのリソースがインターネットと直接双方向通信する | プライベートサブネットのリソースがインターネットへアウトバウンド通信する |
| **IPアドレス** | パブリックIP/EIPを持つリソースと関連付けられる                     | NATゲートウェイ自体にEIPをアタッチする                             |
| **インバウンド** | インターネットからパブリックIPを持つリソースへの直接アクセスを許可 | インターネットからプライベートサブネットへの直接アクセスは**不許可** |
| **アウトバウンド** | パブリックIPを持つリソースからインターネットへの通信を許可         | プライベートIPを持つリソースからインターネットへの通信を許可         |
| **配置場所** | VPCにアタッチされる（特定のサブネットには配置されない）           | パブリックサブネット内に配置される                                 |

### まとめ

インターネットゲートウェイは、VPCがインターネットと接続するための基本的な機能を提供する、非常に重要なVPCコンポーネントです。  
VPC内のリソースがインターネットにアクセスしたり、外部からアクセスされたりするためには、IGWの適切な設定と、それに関連するルートテーブル、セキュリティ設定が不可欠となります。  
特にパブリックサブネットでは、このIGWの設定がインターネット接続の可否を決定します。

## ルートテーブル

### 概要

ルートテーブルは、VPC内のネットワークトラフィックがどこへ向かうべきかを指示するルール（ルート）の集合です。  
VPC内の各サブネットは、必ず1つのルートテーブルに関連付けられ、そのサブネットからのすべてのトラフィックは、関連付けられたルートテーブルのルールに従ってルーティングされます。  
これにより、VPC内のリソース間の通信、インターネットへの通信、VPN接続など、あらゆるネットワークフローを制御できます。  

### ルートテーブルの構成要素

ルートテーブルは、主に以下の要素で構成されます。  

#### 1. 宛先 (Destination)

*   **定義**: ネットワークトラフィックが目指すIPアドレス範囲（CIDRブロック）です。  
*   **例**:  
    *   `10.0.0.0/16`: VPC全体のCIDRブロック。  
    *   `0.0.0.0/0`: すべてのIPアドレス（デフォルトルート）。インターネット宛のトラフィックによく使われます。  
    *   `192.168.1.0/24`: 特定のオンプレミスネットワーク宛のトラフィック。  

#### 2. ターゲット (Target)

*   **定義**: 宛先に一致するトラフィックを転送する先のネットワークデバイスやゲートウェイです。  
*   **主なターゲットの種類**:  

    | ターゲットの種類               | 説明                                                                     | 用途例                                              |
    | :----------------------------- | :----------------------------------------------------------------------- | :-------------------------------------------------- |
    | `local`                        | VPC内のトラフィック。VPCのCIDRブロック範囲内の通信を処理します。     | 同一VPC内のサブネット間の通信                       |
    | **インターネットゲートウェイ (IGW)** | インターネットへの通信。パブリックサブネットからのインターネットアクセス。 | インターネットへのWebアクセス、外部APIへの接続      |
    | **NATゲートウェイ**                | プライベートサブネットからインターネットへのアウトバウンド通信。       | プライベートなWebサーバーがOSアップデートを確認する |
    | **仮想プライベートゲートウェイ (VGW)** | VPN接続を介したオンプレミスネットワークへの通信。                        | オンプレミスデータセンターとの接続                  |
    | **ピアリング接続**                 | 別のVPCへの通信。                                                        | VPCピアリングを介したVPC間通信                      |
    | **ネットワークインターフェース (ENI)** | 特定のインスタンスへのルーティング。通常、NATインスタンスやファイアウォールインスタンスで使用。 | カスタムアプライアンスへのルーティング              |
    | **Gateway Load Balancer Endpoint** | Gateway Load Balancer を使用したトラフィック検査。                       | ネットワークセキュリティアプライアンス経由の通信    |
    | **Transit Gateway**            | 複数のVPCやオンプレミスネットワークを集約して接続する。                  | 大規模なネットワーク統合                            |

### ルートテーブルの動作原理

1.  **最長一致ルール**: 特定の宛先IPアドレスを持つトラフィックが発生すると、ルートテーブル内のすべてのルートが評価されます。  
    この際、最も長く一致するCIDRブロックを持つルートが優先されます（より具体的なルートが優先）。  
    例えば、`10.0.0.0/16`と`10.0.1.0/24`の両方のルートがある場合、`10.0.1.0/24`宛のトラフィックは後者のルートが適用されます。  
2.  **デフォルトルート**: どのルートにも一致しないトラフィックは、デフォルトルート（宛先`0.0.0.0/0`）があれば、それに従って転送されます。  
    デフォルトルートがない場合、そのトラフィックは破棄されます。  

### ルートテーブルの種類

#### メインルートテーブル (Main Route Table)

*   すべてのVPCに自動的に作成され、どのサブネットにも明示的に関連付けられていないサブネットに自動的に関連付けられます。  
*   通常、セキュリティ上の理由から、メインルートテーブルには最小限のルート（例: `local`ルートのみ）を設定し、各サブネットにはカスタムルートテーブルを明示的に関連付けることが推奨されます。  

#### カスタムルートテーブル (Custom Route Table)

*   作成し、特定のサブネットに明示的に関連付けるルートテーブルです。  
*   これにより、サブネットごとに異なるルーティングポリシーを適用できます。  
*   ほとんどの場合、セキュリティと管理の容易さのために、サブネットごとにカスタムルートテーブルを作成し、関連付けます。  

### サブネットとルートテーブルの関連付け

*   各サブネットは、**必ず1つのルートテーブル**に関連付けられます。  
*   サブネットの作成時にルートテーブルを明示的に指定しない場合、そのサブネットは自動的にメインルートテーブルに関連付けられます。  
*   メインルートテーブルの動作を変更すると、明示的にカスタムルートテーブルが関連付けられていないすべてのサブネットに影響を与えます。  

### ルートテーブルの設計例

#### パブリックサブネット用ルートテーブル

| 宛先          | ターゲット                      | 備考                                 |
| :------------ | :------------------------------ | :----------------------------------- |
| `10.0.0.0/16` | `local`                         | VPC内通信を許可                      |
| `0.0.0.0/0`   | `igw-xxxxxxxxxxxxxxxxx` (IGW ID) | インターネットへのアウトバウンド/インバウンド通信を許可 |

#### プライベートサブネット用ルートテーブル

| 宛先          | ターゲット                          | 備考                                      |
| :------------ | :---------------------------------- | :---------------------------------------- |
| `10.0.0.0/16` | `local`                             | VPC内通信を許可                           |
| `0.0.0.0/0`   | `nat-xxxxxxxxxxxxxxxxx` (NAT GW ID) | NATゲートウェイ経由でインターネットへのアウトバウンド通信を許可 |
