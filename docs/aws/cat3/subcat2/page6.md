# VPC作成の手順

---

## VPC作成手順

### 概要

これまでの項目で、VPCの各コンポーネントとその設計方法について学んできました。  
この項目では、実際にVPCを構築し、日々の運用で管理していくための具体的な手順と考慮事項について解説します。  
VPCの設定と管理は、AWS環境の安定稼働とセキュリティ維持のために継続的に行うべき重要なタスクです。  

### 1. VPCの作成

AWSアカウントには、デフォルトでリージョンごとに「デフォルトVPC」が用意されていますが、通常は独自の要件に合わせた「カスタムVPC」を作成することが推奨されます。  

#### 1.1. VPC作成の手順

1.  **AWSマネジメントコンソールにサインイン**: VPCサービスコンソールに移動します。  
2.  **「VPCの作成」または「VPCウィザードの起動」を選択**:  
    *   **「VPCの作成」**: 最も基本的なVPCをCIDRブロックを指定して作成します。サブネットやゲートウェイは別途作成が必要です。  
    *   **「VPCウィザードの起動」**: 一般的なシナリオ（例: 「VPCとパブリックサブネットおよびプライベートサブネット」）を選択すると、VPC本体、サブネット、インターネットゲートウェイ、NATゲートウェイ、ルートテーブルなどが自動的に作成され、初期設定が完了します。  
        初めてVPCを構築する場合や、一般的な構成で始めたい場合に便利です。  
3.  **CIDRブロックの指定**: VPCのプライマリCIDRブロック（例: `10.0.0.0/16`）を慎重に選択し、入力します。  
4.  **テナンシーの選択**:  
    *   **Default**: ほとんどのVPCリソースが共有ハードウェアで稼働します（最も一般的でコスト効率が良い）。  
    *   **Dedicated**: 専用の物理ハードウェアでVPCが稼働します（特定のコンプライアンス要件がある場合など）。  
5.  **VPCの作成を実行**: 設定内容を確認し、VPCを作成します。  

#### 1.2. デフォルトVPCについて

*   新規AWSアカウントには、リージョンごとにデフォルトVPCが自動的に作成されます。  
*   このVPCは、各AZにパブリックサブネットを持ち、インターネットゲートウェイに接続され、すぐにリソースを起動できる状態になっています。  
*   簡易的なテストや、すぐにリソースをデプロイしたい場合には便利ですが、本番環境では要件に合わせたカスタムVPCの使用が推奨されます。  
*   誤操作を防ぐため、デフォルトVPCを削除する前に、そのVPC内にリソースが残っていないことを確認する必要があります。  

### 2. サブネットの作成

VPCを作成したら、そのVPCのCIDRブロックからIPアドレス範囲を切り出し、サブネットを作成します。  

#### 2.1. サブネット作成の手順

1.  **VPCコンソールから「サブネット」を選択**: 「サブネットの作成」をクリックします。  
2.  **VPCの選択**: サブネットを作成するVPCを指定します。  
3.  **アベイラビリティーゾーン (AZ) の選択**: サブネットを配置するAZを選択します。高可用性のために複数のAZに分散させます。  
4.  **CIDRブロックの指定**: VPCのCIDRブロック内から、サブネットのCIDRブロック（例: `10.0.1.0/24`）を指定します。  
5.  **サブネットの作成を実行**: 設定内容を確認し、サブネットを作成します。  

#### 2.2. サブネットのプロパティ設定

サブネット作成後、または作成中に以下の設定を検討します。  

*   **自動割り当てパブリックIPv4アドレス**: パブリックサブネットでは、EC2インスタンス起動時に自動的にパブリックIPアドレスを割り当てるように設定できます。  
    この設定は、パブリックサブネットの運用を簡素化します。  
*   **ルートテーブルの関連付け**: 作成したカスタムルートテーブルをサブネットに明示的に関連付けます。  
    これにより、サブネットごとのルーティングポリシーを適用できます。  

### 3. セキュリティ設定

VPCのセキュリティは、セキュリティグループとネットワークACLによって実現されます。  

#### 3.1. セキュリティグループ (SG) の設定

1.  **VPCコンソールから「セキュリティグループ」を選択**: 「セキュリティグループの作成」をクリックします。  
2.  **VPCの選択**: セキュリティグループを適用するVPCを指定します。  
3.  **インバウンド/アウトバウンドルールの設定**:  
    *   **タイプ**: HTTP, HTTPS, SSH, MySQL/Aurora, Custom TCPなど。  
    *   **プロトコル**: TCP, UDP, ICMPなど。  
    *   **ポート範囲**: 80, 443, 22, 3306など。  
    *   **ソース/宛先**: IPアドレス (CIDR) または別のセキュリティグループIDを指定します。  
    *   最小権限の原則に基づき、必要な通信のみを許可するよう設定します。  
4.  **EC2インスタンスへの適用**: EC2インスタンスの起動時、または実行中のインスタンスにセキュリティグループをアタッチします。  

#### 3.2. ネットワークACL (NACL) の設定

1.  **VPCコンソールから「ネットワークACL」を選択**: 「ネットワークACLの作成」をクリックします。  
2.  **VPCの選択**: NACLを適用するVPCを指定します。  
3.  **インバウンド/アウトバウンドルールの設定**:  
    *   **ルール番号**: 1から32766の範囲で、小さい番号から評価されます。  
    *   **タイプ/プロトコル/ポート範囲/ソース/宛先**: セキュリティグループと同様。  
    *   **許可/拒否**: 明示的な許可と拒否のルールを設定します。  
    *   デフォルトの「\* 拒否」ルール（ルール番号が大きい）は変更できません。  
4.  **サブネットへの関連付け**: 作成したNACLをサブネットに明示的に関連付けます。  
    1つのサブネットには1つのNACLしか関連付けられません。  

### 4. その他のVPC管理タスク

#### 4.1. ルートテーブルの管理

*   **ルートの追加/編集**: 新しいゲートウェイ（NATゲートウェイ、VGW、Transit Gatewayなど）をVPCに接続した場合、それらのゲートウェイへのルートをルートテーブルに追加する必要があります。  
*   **メインルートテーブルの変更**: 通常はカスタムルートテーブルを各サブネットに関連付けるべきですが、メインルートテーブルの変更は、明示的に関連付けられていないすべてのサブネットに影響を与えるため、慎重に行う必要があります。  

#### 4.2. インターネットゲートウェイ (IGW) / NATゲートウェイ (NAT GW) の管理

*   **作成/アタッチ/デタッチ**: 必要に応じてIGWやNAT GWを作成し、VPCにアタッチまたはデタッチします。  
*   **AZごとのNAT GW**: 高可用性のため、各AZのプライベートサブネットからインターネットにアクセスする場合は、そのAZごとにNAT GWを配置し、ルーティングを設定します。  

#### 4.3. VPC Flow Logs の設定

*   **有効化**: VPC内のIPトラフィックに関する情報をキャプチャするために、VPC Flow Logsを有効にします。  
*   **送信先**: CloudWatch LogsまたはAmazon S3にログを送信するように設定できます。  
*   **用途**: ネットワーク監視、セキュリティ分析、トラブルシューティングに活用します。  

#### 4.4. IPアドレスの管理

*   **CIDRブロックの監視**: 将来的なIPアドレスの枯渇を防ぐため、VPCおよびサブネットのIPアドレス使用状況を定期的に監視します。  
*   **セカンダリCIDRブロックの追加**: プライマリCIDRブロックが枯渇し始めた場合、VPCにセカンダリCIDRブロックを追加することを検討します。  
*   **Elastic IPアドレス (EIP) の管理**: 使用していないEIPは解放することでコストを削減できます。  

#### 4.5. タグ付け

*   VPC、サブネット、ゲートウェイ、ルートテーブル、セキュリティグループなど、すべてのVPCリソースに意味のあるタグ（例: `Project: WebApp`, `Environment: Production`, `Owner: TeamA`）を付与します。  
*   タグは、リソースの識別、コスト配分、自動化、ガバナンスに役立ちます。  

### まとめ

VPCの設定と管理は、計画、実装、監視、そして継続的な改善のサイクルで成り立っています。  
VPCの作成、サブネットの配置、そして特にセキュリティグループとネットワークACLによる厳格なセキュリティ設定は、安全で可用性の高いクラウドインフラを構築するための基盤です。  
VPC Flow Logsによる監視や適切なIPアドレス管理、リソースのタグ付けなどの運用タスクを継続的に行うことで、VPC環境を健全に維持し、ビジネス要件の変化にも柔軟に対応できるようになります。

## VPCの作成

### 概要

AWSクラウド上に独自の仮想ネットワーク環境を構築するための最初のステップが、VPCの作成です。  
AWSアカウントには、リージョンごとに「デフォルトVPC」が自動的に用意されていますが、多くの場合、特定の要件（IPアドレス範囲、セキュリティポリシー、接続要件など）に合わせて「カスタムVPC」を作成することが推奨されます。  
ここでは、VPCを作成するための具体的な手順と、その際に考慮すべきオプションについて解説します。  

### 1. VPC作成の主な方法

AWSマネジメントコンソールからは、主に2つの方法でVPCを作成できます。  

#### 1.1. 「VPCのみ」を作成する

これは、最も基本的なVPCを作成する方法です。  
VPC本体とそのIPアドレス範囲のみを定義し、サブネット、インターネットゲートウェイ、ルートテーブルなどの他のコンポーネントは後から手動で追加する必要があります。  
より詳細な制御が必要な場合や、特定のアーキテクチャに厳密に従いたい場合に適しています。  

**手順（概念）:**

1.  AWSマネジメントコンソールにサインインし、「VPC」サービスに移動します。  
2.  左側のナビゲーションペインから「VPC」を選択し、「VPCを作成」ボタンをクリックします。  
3.  **「VPCの設定」**:  
    *   **リソース名**: 任意のVPC名を指定します（例: `MyProductionVPC`）。  
    *   **IPv4 CIDR ブロック**: VPC全体で使用するプライベートIPv4アドレス範囲をCIDR形式で指定します（例: `10.0.0.0/16`）。  
        *   **重要な考慮事項**: このCIDRブロックは、後からサブネットに分割され、VPC内のリソースにIPアドレスが割り当てられる基盤となります。  
            将来の拡張性や他のネットワーク（オンプレミス、他のVPC）との重複を避けるために、慎重に決定する必要があります。  
    *   **IPv6 CIDR ブロック**: 必要に応じてIPv6アドレス範囲も指定できます（オプション）。  
    *   **テナンシー**:  
        *   **デフォルト**: ほとんどのVPCリソースが共有ハードウェア上で稼働します。これが最も一般的でコスト効率の良い選択肢です。  
        *   **専用**: 専用の物理ホスト上でVPCリソースが稼働します。特定のコンプライアンス要件やライセンス要件がある場合に選択します。  
    *   **タグ**: 必要に応じて、VPCを識別するためのキーと値のペアを追加します。  
4.  設定内容を確認し、「VPCを作成」をクリックします。  

#### 1.2. 「VPCと追加リソース」を作成する (VPCウィザード)

これは、一般的なVPC構成（例: パブリックサブネットとプライベートサブネットを持つVPC）を迅速に構築するためのウィザード形式の作成方法です。  
VPC本体だけでなく、サブネット、インターネットゲートウェイ、NATゲートウェイ、ルートテーブルなどの必要なコンポーネントも自動的に作成・設定されます。  
初めてVPCを構築する方や、標準的な構成で始めたい場合に非常に便利です。  

**手順（概念）:**

1.  AWSマネジメントコンソールにサインインし、「VPC」サービスに移動します。  
2.  左側のナビゲーションペインから「VPC」を選択し、「VPCを作成」ボタンをクリックします。  
3.  **「VPCの設定」で「VPCと追加リソース」を選択**します。  
4.  **「VPC構成」を選択**: 一般的なシナリオから選択します。  
    *   **VPCのみ**: 前述の「VPCのみ」の作成と同じ。  
    *   **VPC、サブネット、ゲートウェイなど**: 最も一般的な選択肢で、以下のような構成が作成されます。  
        *   VPC、インターネットゲートウェイ、ルートテーブル、複数のパブリックサブネット、複数のプライベートサブネット、NATゲートウェイ（オプション）。  
    *   **VPN接続を持つVPC**: オンプレミスとのVPN接続を含むVPCを構築します。  
    *   **プライベートサブネットのみのVPC**: インターネットゲートウェイを持たないVPC。  
5.  選択した構成に応じて、以下の詳細を設定します。  
    *   **IPv4 CIDR ブロック**: VPCのCIDRブロック。  
    *   **アベイラビリティーゾーンの数**: 高可用性のために何AZにサブネットを分散するか。  
    *   **パブリックサブネットの数 / プライベートサブネットの数**: 各AZに作成するサブネットの数と、そのCIDRブロック。  
    *   **NATゲートウェイ**: 必要に応じて、「AZごと」または「なし」を選択。AZごとに作成することで高可用性が向上します。  
    *   **VPCエンドポイント**: S3へのGateway Endpointを自動で作成するかどうか（オプション）。  
    *   **DNS解決 / DNSホスト名**: 名前解決に関する設定。  
    *   **タグ**: リソースに付与するタグ。  
6.  設定内容を確認し、「VPCを作成」をクリックします。  

### 2. デフォルトVPCとカスタムVPC

| 特徴           | デフォルトVPC                                        | カスタムVPC                                              |
| :------------- | :--------------------------------------------------- | :------------------------------------------------------- |
| **作成者**     | AWSアカウント作成時に自動作成                        | 手動で作成                                       |
| **IPアドレス** | AWSが定義したデフォルトのCIDRブロック (`172.31.0.0/16` など) | 任意のRFC 1918準拠のCIDRブロックを指定         |
| **サブネット** | 各AZに1つのパブリックサブネットが自動作成される      | 任意でパブリック/プライベートサブネットを作成  |
| **ゲートウェイ** | インターネットゲートウェイが自動的にアタッチされる | 手動でインターネットゲートウェイなどをアタッチ |
| **用途**       | 簡易的なテスト、学習用                               | 本番環境、特定の要件を持つシステム                       |
| **推奨**       | 本番利用は非推奨                                     | 本番環境では常にカスタムVPCを推奨                      |

本番環境でカスタムVPCを推奨する主な理由は、IPアドレス計画の自由度、セキュリティ要件への対応、オンプレミス環境や他のVPCとの連携の容易さ、および将来の拡張性において、より高度な制御が可能となるためです。  

### 3. VPC作成後のステップ

VPCを正常に作成した後も、そのVPCを実際に活用するためには、以下の追加のステップが必要になります。  

*   **サブネットの作成**: 複数のAZにパブリック/プライベートサブネットを作成し、それぞれに適切なCIDRブロックを割り当てます。  
*   **インターネットゲートウェイのデタッチ/アタッチ**: 必要に応じて、IGWが正しくアタッチされているかを確認します。  
*   **ルートテーブルの設定**: 各サブネットに適切なルートテーブルを関連付け、インターネットゲートウェイ、NATゲートウェイなどへのルートを設定します。  
*   **セキュリティグループ/ネットワークACLの準備**: EC2インスタンスやRDSなどのリソースに適用するセキュリティルールを定義します。  
*   **NATゲートウェイの作成**: プライベートサブネットからのインターネットアウトバウンド通信が必要な場合に作成します。  

これらの詳細については、後続の項目でそれぞれ詳しく解説していきます。  
VPCの作成は、AWSクラウドでのネットワーク基盤構築のまさに第一歩となります。

## サブネットの作成

### 概要

VPCが仮想データセンターの「建物全体」だとすると、サブネットはその建物内の「各部屋」や「フロア」に相当します。  
VPCのCIDRブロックからIPアドレス範囲を切り出し、サブネットを作成することで、VPC内のリソースを論理的に分割し、管理しやすくします。  
このステップは、アプリケーションの可用性、セキュリティ、およびスケーラビリティを確保する上で非常に重要です。  

### 1. サブネット作成の基本的な手順

AWSマネジメントコンソールを使用してサブネットを作成する手順は以下の通りです。  

1.  **AWSマネジメントコンソールにサインイン**: 「VPC」サービスに移動します。  
2.  左側のナビゲーションペインから「サブネット」を選択し、「サブネットを作成」ボタンをクリックします。  
3.  **VPCの選択**:  
    *   サブネットを作成したいVPCを選択します。すでにVPCが作成されている必要があります。  
4.  **サブネットの詳細設定**:  
    *   **サブネット名**: 任意のサブネット名を指定します（例: `Public-Subnet-AZ1`, `Private-App-Subnet-AZ2`）。  
    *   **アベイラビリティーゾーン (AZ)**:  
        *   サブネットを配置するAZを選択します。  
        *   **重要**: 各サブネットは、必ず1つのAZにのみ関連付けられます。  
            高可用性を実現するためには、複数のAZにサブネットを分散して作成する必要があります。  
    *   **IPv4 CIDR ブロック**:  
        *   選択したVPCのCIDRブロック内から、サブネットに割り当てるIPアドレス範囲をCIDR形式で指定します（例: `10.0.1.0/24`）。  
        *   このCIDRブロックは、VPCのCIDRブロックと重複しないように、かつVPCのCIDRブロックの範囲内に収まるように指定します。  
        *   **推奨サイズ**: 一般的には`/24`（256個のIPアドレス、利用可能251個）がよく使用されますが、リソース数に応じて`/25`や`/26`なども検討します。  
        *   **予約済みIPアドレス**: 各サブネットのCIDRブロックから5つのIPアドレスがAWSによって予約されることに注意してください。  
    *   **IPv6 CIDR ブロック**: 必要に応じてIPv6アドレス範囲も指定できます（オプション）。  
    *   **タグ**: 必要に応じて、サブネットを識別するためのキーと値のペアを追加します。  
5.  設定内容を確認し、「サブネットを作成」をクリックします。  

### 2. サブネット作成後の設定（プロパティ）

サブネット作成後、その用途に応じて追加のプロパティ設定が必要になる場合があります。  

#### 2.1. ルートテーブルの関連付け

*   **メインルートテーブル**: サブネット作成時に明示的にルートテーブルを関連付けない場合、そのサブネットは自動的にVPCのメインルートテーブルに関連付けられます。  
*   **カスタムルートテーブルの関連付け**:  
    *   通常は、サブネットの役割（パブリック/プライベート）に応じて、専用のカスタムルートテーブルを作成し、各サブネットに明示的に関連付けることを推奨します。  
    *   これにより、サブネットごとのルーティングポリシーをきめ細かく制御できます。  
*   **手順**:  
    1.  VPCコンソールで「ルートテーブル」を選択します。  
    2.  対象のカスタムルートテーブルを選択し、「サブネットの関連付け」タブを選択します。  
    3.  「サブネットの関連付けを編集」をクリックし、関連付けたいサブネットを選択して保存します。  

#### 2.2. 自動割り当てパブリックIPv4アドレスの有効化 (パブリックサブネットの場合)

*   **目的**: この設定を有効にすると、そのサブネットで起動されるEC2インスタンスに自動的にパブリックIPv4アドレスが割り当てられるようになります。  
*   **用途**: パブリックサブネットでは、この設定を有効にすることで、インターネットから直接アクセスされるWebサーバーなどを起動する手間を省けます。  
*   **手順**:  
    1.  VPCコンソールで「サブネット」を選択します。  
    2.  対象のパブリックサブネットを選択し、「アクション」ドロップダウンメニューから「自動割り当てIP設定を変更」を選択します。  
    3.  「Enable auto-assign public IPv4 address」のチェックボックスをオンにして保存します。  

### 3. サブネット配置のベストプラクティス

前述の「サブネットの配置」で詳しく解説しましたが、サブネット作成時に再度以下の点を考慮することが重要です。  

*   **複数AZへの分散**:  
    *   アプリケーションの高可用性を確保するため、少なくとも2つ、可能であれば3つの異なるAZにサブネットを分散して作成します。  
*   **パブリック/プライベートの分離**:  
    *   インターネットから直接アクセスされるリソース（Webサーバー、ロードバランサーなど）はパブリックサブネットに、機密性の高いリソース（データベース、アプリケーションサーバーなど）はプライベートサブネットに配置します。  
*   **論理的な層での分割**:  
    *   Web層、アプリケーション層、データベース層など、アプリケーションのアーキテクチャに合わせてサブネットを分割することで、セキュリティグループやネットワークACLによるアクセス制御を容易にします。  
    *   例えば、AZ-Aに`Public-Subnet-A`、`Private-App-Subnet-A`、`Private-DB-Subnet-A`を作成し、AZ-Bにも同様に`Public-Subnet-B`、`Private-App-Subnet-B`、`Private-DB-Subnet-B`を作成する、といった形です。  

#### サブネットCIDRブロックの割り当て例

VPC CIDR: `10.0.0.0/16`

| AZ                | サブネット名              | CIDRブロック    | 用途          |
| :---------------- | :------------------------ | :-------------- | :------------ |
| `ap-northeast-1a` | `Public-Subnet-A`         | `10.0.1.0/24`   | Web/LB/NAT    |
| `ap-northeast-1a` | `Private-App-Subnet-A`    | `10.0.2.0/24`   | App Server    |
| `ap-northeast-1a` | `Private-DB-Subnet-A`     | `10.0.3.0/24`   | DB Server     |
| `ap-northeast-1c` | `Public-Subnet-C`         | `10.0.11.0/24`  | Web/LB/NAT    |
| `ap-northeast-1c` | `Private-App-Subnet-C`    | `10.0.12.0/24`  | App Server    |
| `ap-northeast-1c` | `Private-DB-Subnet-C`     | `10.0.13.0/24`  | DB Server     |

### まとめ

サブネットの作成は、VPCの設計図を具体的な形にする重要なステップです。  
適切なAZへの分散、パブリック/プライベートの明確な分離、そして用途に応じたCIDRブロックの割り当ては、VPCのセキュリティ、可用性、およびスケーラビリティに直接影響します。  
サブネット作成後は、ルートテーブルの関連付けや、パブリックIPアドレスの自動割り当て設定などのプロパティを適切に設定し、VPC内のネットワーク環境を最適化することが求められます。

## セキュリティ設定

### 概要

VPCにおけるセキュリティ設定は、AWSクラウド上に構築されるシステム全体の安全性を確保するために不可欠な要素です。  
これまでの項目で、VPCの基本要素としての「セキュリティグループ」と「ネットワークACL」の役割を学びました。  
ここでは、これらの主要なファイアウォール機能を実際にどのように設定し、VPC全体のセキュリティポスチャを向上させるための具体的なアプローチと、その他の重要な考慮事項について解説します。  
多層防御の原則に基づき、複数のセキュリティ層を組み合わせることが重要です。  

### 1. セキュリティグループ (Security Group) の設定

セキュリティグループは、EC2インスタンスなど、個々のリソースにアタッチされるインスタンスレベルの仮想ファイアウォールです。  

#### 1.1. 設定手順

1.  **AWSマネジメントコンソールにサインイン**: 「VPC」サービスに移動します。  
2.  左側のナビゲーションペインから「セキュリティグループ」を選択し、「セキュリティグループを作成」ボタンをクリックします。  
3.  **基本情報の入力**:  
    *   **セキュリティグループ名**: 任意の分かりやすい名前（例: `sg-web-server`, `sg-app-server`, `sg-db-mysql`）。  
    *   **説明**: セキュリティグループの目的を記述します。  
    *   **VPC**: このセキュリティグループを適用するVPCを選択します。  
4.  **インバウンドルールの設定**: インスタンスへの着信トラフィックを許可するルールを設定します。  

    | フィールド     | 説明                                                                                                     | 例                                               |
    | :------------- | :------------------------------------------------------------------------------------------------------- | :----------------------------------------------- |
    | **タイプ**     | プロトコルの種類を抽象的に表現したもの（例: HTTP, HTTPS, SSH, MySQL/Aurora, カスタムTCP）。                 | HTTP, HTTPS, SSH, Custom TCP                     |
    | **プロトコル** | TCP, UDP, ICMPなど。                                                                                     | TCP                                              |
    | **ポート範囲** | 許可するポート番号または範囲（例: 80, 443, 22, 3306, 8080-8088）。                                        | 80, 443, 22, 3306                                |
    | **ソース**     | 許可する接続元のIPアドレス範囲 (CIDR) または別のセキュリティグループID。                               | `0.0.0.0/0` (すべてのIP), `192.168.1.0/24`, `sg-xxxxxxxxxxxxx` (WebサーバSG) |
    | **説明**       | ルールの目的を記述します。                                                                               | Webアクセス許可, 管理者からのSSH                 |
5.  **アウトバウンドルールの設定**: インスタンスからの送信トラフィックを許可するルールを設定します。  
    *   デフォルトでは、すべての (`0.0.0.0/0`) アウトバウンドトラフィックが許可されています。  
    *   より厳密な制御が必要な場合は、このデフォルトルールを削除し、必要な通信のみを明示的に許可します。  
6.  設定内容を確認し、「セキュリティグループを作成」をクリックします。  
7.  **インスタンスへの適用**: EC2インスタンスの起動時、または実行中のインスタンスに作成したセキュリティグループをアタッチします。  
    1つのインスタンスに複数のセキュリティグループをアタッチできます。  

#### 1.2. セキュリティグループのベストプラクティス

*   **最小権限の原則**: 必要なポートとプロトコル、信頼できるソースIPアドレス（またはセキュリティグループ）からのアクセスのみを許可します。  
    `0.0.0.0/0`（全開放）は、WebサーバーのHTTP/HTTPSポートなど、本当に必要な場合にのみ使用し、管理ポート（SSH, RDPなど）は特定の管理者IPアドレスに限定します。  
*   **セキュリティグループ参照**: 同じVPC内のリソース間の通信（例: Webサーバーからアプリケーションサーバーへの接続）では、ソースとして相手のインスタンスのプライベートIPアドレスではなく、**相手のインスタンスが属するセキュリティグループID**を指定することを強く推奨します。  
    これにより、プライベートIPアドレスが変更されても、セキュリティグループの設定を変更する必要がなくなります。  
*   **デフォルトアウトバウンドルールの変更**: 特殊な要件がない限り、デフォルトで全許可となっているアウトバウンドルールを明示的に制限することを検討します。  
    例えば、インターネットへのアウトバウンドは特定のポートのみ許可し、VPC内への通信は全面的に許可するなどです。  

### 2. ネットワークACL (Network Access Control List, NACL) の設定

NACLは、サブネットレベルでトラフィックを制御するステートレスな仮想ファイアウォールです。  

#### 2.1. 設定手順

1.  **AWSマネジメントコンソールにサインイン**: 「VPC」サービスに移動します。  
2.  左側のナビゲーションペインから「ネットワークACL」を選択し、「ネットワークACLを作成」ボタンをクリックします。  
3.  **基本情報の入力**:  
    *   **名前**: 任意の分かりやすい名前（例: `nacl-public-subnet`, `nacl-private-db`）。  
    *   **VPC**: このNACLを適用するVPCを選択します。  
4.  **インバウンドルールの編集**: サブネットへの着信トラフィックを許可/拒否するルールを設定します。  

    | フィールド     | 説明                                                                                                     | 例                                               |
    | :------------- | :------------------------------------------------------------------------------------------------------- | :----------------------------------------------- |
    | **ルール番号** | 1から32766の範囲で、数値が小さい順に評価されます。一致した時点で評価は停止します。                           | 100, 110, 200                                    |
    | **タイプ**     | プロトコルの種類。                                                                                       | HTTP, HTTPS, SSH, Custom TCP, All Traffic        |
    | **プロトコル** | TCP, UDP, ICMPなど。                                                                                     | TCP                                              |
    | **ポート範囲** | 許可/拒否するポート番号または範囲。                                                                      | 80, 443, 22, 1024-65535 (エフェメラルポート)     |
    | **ソース**     | 許可/拒否する接続元のIPアドレス範囲 (CIDR)。                                                           | `0.0.0.0/0`, `192.168.1.0/24`, `特定の不正IP/32` |
    | **許可/拒否**  | **許可** または **拒否** を選択します。                                                                  | 許可, 拒否                                       |
5.  **アウトバウンドルールの編集**: サブネットからの送信トラフィックを許可/拒否するルールを設定します。  
    *   インバウンドルールと同様に、ルール番号、タイプ、プロトコル、ポート範囲、宛先 (CIDR)、許可/拒否を設定します。  
6.  設定内容を確認し、NACLを保存します。  
7.  **サブネットへの関連付け**:  
    1.  作成したNACLを選択し、「サブネットの関連付け」タブを選択します。  
    2.  「サブネットの関連付けを編集」をクリックし、関連付けたいサブネットを選択して保存します。  
        1つのサブネットには1つのNACLしか関連付けられません。  

#### 2.2. ネットワークACLのベストプラクティス

*   **暗黙の拒否ルール**: カスタムNACLを作成した場合、明示的に許可されていないすべてのトラフィックは、ルール番号が大きい暗黙の拒否ルール (`* All traffic All All 0.0.0.0/0 DENY`) によって拒否されます。  
    この特性を理解し、必要なルールのみを明示的に許可するようにします。  
*   **エフェメラルポートの考慮**: NACLはステートレスであるため、インバウンドとアウトバウンドの両方で、応答トラフィックのルールも明示的に許可する必要があります。  
    特に、クライアントからの応答は、一時的に使用されるエフェメラルポート（TCP 1024-65535など）で返されることが多いため、この範囲を許可するルールを設定することがよくあります。  
*   **特定のIPアドレスの拒否**: 特定の不正なIPアドレスからのアクセスをVPCの特定部分（サブネット）全体でブロックしたい場合に、NACLの拒否ルールが非常に有効です。  

### 3. セキュリティグループとネットワークACLの使い分けと連携

| 特徴           | セキュリティグループ (SG)                | ネットワークACL (NACL)             |
| :------------- | :--------------------------------------- | :----------------------------------- |
| **適用対象**   | EC2インスタンスなど個別のリソース        | サブネット                           |
| **適用レベル** | インスタンスレベル                       | サブネットレベル                     |
| **動作**       | ステートフル（応答トラフィックは自動許可） | ステートレス（応答トラフィックも明示的に許可が必要） |
| **ルール評価** | すべてのルールを評価し、許可ルールがあれば許可 | ルール番号の小さい順に評価し、一致した時点で適用 |
| **ルール**     | 許可ルールのみ                           | 許可ルールと拒否ルールの両方           |
| **デフォルト** | デフォルトではすべてのアウトバウンドを許可、すべてのインバウンドを拒否 | デフォルトではすべて許可（カスタム作成時は暗黙的にすべて拒否） |
| **制限**       | 1インスタンスに最大5つ                   | 1サブネットに1つ                     |

*   **多層防御**: 通常は、セキュリティグループを主要なインスタンスレベルのファイアウォールとして使用し、ネットワークACLはオプションで、より広範なサブネットレベルでのアクセス制御や、特定のIPアドレスからの通信の明示的な拒否に利用します。  
    例えば、NACLでサブネットへの基本的なアクセス（HTTP/HTTPS/SSH）を許可または拒否し、SGで個々のインスタンスへのより詳細なアクセス（DBポートなど）を制御する、といった組み合わせが考えられます。  

### 4. その他のセキュリティ強化策

*   **VPC Flow Logs**: VPC内のIPトラフィック情報をキャプチャし、CloudWatch LogsやS3に発行します。  
    これにより、異常な通信の監視やセキュリティイベントの調査が可能になります。  
*   **NATゲートウェイの利用**: プライベートサブネット内のリソースがインターネットにアウトバウンド通信する必要がある場合、NATゲートウェイを経由させることで、インターネットからの直接アクセスを防止しつつ、必要な通信を可能にします。  
*   **踏み台サーバー / AWS Systems Manager Session Manager**: プライベートサブネット内のインスタンスへの管理アクセスは、パブリックサブネットに置かれた踏み台サーバーを経由するか、よりセキュアなAWS Systems Manager Session Managerを利用します。  
*   **VPCエンドポイント**: Amazon S3やDynamoDBなどのAWSサービスへのアクセスは、VPCエンドポイントを介してプライベートに行い、インターネットゲートウェイを経由しないようにします。  
*   **AWS WAF / Shield**: WebアプリケーションをWeb攻撃やDDoS攻撃から保護するために、AWS WAF (Web Application Firewall) や AWS Shield を利用します。  
*   **IAMによるアクセス制御**: VPCコンポーネントの作成、変更、削除などの操作は、AWS IAM (Identity and Access Management) ポリシーによって厳密に制御し、最小権限の原則を適用します。  
*   **ログ監視と監査**: CloudTrailでAPIアクティビティを記録し、Amazon GuardDutyで脅威を検出するなど、VPCを含むAWS環境全体のログ監視と監査体制を構築します。  

### まとめ

VPCのセキュリティ設定は、システムを外部の脅威から保護するための最も重要な側面です。  
セキュリティグループとネットワークACLを効果的に組み合わせることで、多層的な防御を構築し、VPC内のリソースを保護します。  
常に「最小権限の原則」に従い、必要な通信のみを許可する設定を心がけ、VPC Flow Logsによる監視やIAMによるアクセス制御など、様々なセキュリティサービスと連携させることで、AWS環境全体のセキュリティポスチャを継続的に強化していく必要があります。 

## よくある質問

### 概要

VPCに関する基本的な概念から応用的な設計までを学んできましたが、ここではVPCの運用や設計においてよく寄せられる質問とその回答をまとめます。  
これにより、皆様のVPCに関する理解をさらに深め、実践に役立てることを目的とします。  

### VPC内のリソースへのアクセス方法

**Q1: プライベートサブネット内のEC2インスタンスに、外部から安全に接続するにはどうすればよいですか？**  

**A1:** プライベートサブネット内のEC2インスタンスは、インターネットから直接アクセスできないようになっています。  
そのため、いくつかの安全な接続方法があります。  

*   **踏み台サーバー (Bastion Host) を経由する**:  
    パブリックサブネットに踏み台サーバーを配置し、まずその踏み台サーバーにSSHなどで接続します。  
    その後、踏み台サーバーからプライベートサブネット内の目的のインスタンスに接続します。  
    踏み台サーバーには厳格なセキュリティグループを適用し、アクセス元IPアドレスを制限することが重要です。  

*   **AWS Systems Manager Session Manager を利用する**:  
    これが最も推奨される方法です。  
    Session Managerを使用すると、踏み台サーバー、SSHキーペア、パブリックIPアドレス、セキュリティグループでのポート開放が不要になります。  
    EC2インスタンスにSSMエージェントがインストールされ、適切なIAMロールが割り当てられていれば、AWSコンソールやCLIから直接セキュアに接続できます。  
    VPCエンドポイント (Interface Endpoint) を利用することで、インターネットゲートウェイを経由せずにプライベートにSSMサービスにアクセスできます。  

*   **AWS Client VPN を利用する**:  
    デバイスからVPCにVPN接続を確立し、VPC内のプライベートIPアドレス空間にアクセスできるようにする方法です。  
    これにより、自宅やオフィスから直接VPC内のプライベートリソースにアクセスできるようになります。  

---

### VPCのサイズの決定基準

**Q2: 新しいVPCを作成する際、IPv4 CIDRブロックのサイズ（例: `/16`、`/20`）はどのように決定すれば良いですか？**  

**A2:** VPCのCIDRブロックのサイズは、将来の拡張性やIPアドレスの枯渇を防ぐために非常に重要な決定です。  
以下の点を考慮して決定してください。  

*   **現在のリソース数と将来の予測**:  
    現在デプロイする予定のEC2インスタンス、RDS、Lambda ENIなどのリソース数に加え、将来的な成長やサービス追加を予測します。  
    サブネットは通常`/24`や`/25`単位で作成され、各サブネットにはAWSが5つのIPアドレスを予約します。  
    これらを考慮し、十分なアドレス空間を確保します。  

*   **アベイラビリティーゾーン (AZ) の数**:  
    高可用性のために複数のAZにサブネットを分散する場合、それぞれのAZにパブリック/プライベートサブネットを割り当てることになります。  
    例えば、3つのAZにそれぞれ2つのサブネット（パブリック、プライベート）を`/24`で作成する場合、最低でも `256 * 2 * 3 = 1536` 個のIPアドレスが必要です。  

*   **他のネットワークとの接続**:  
    オンプレミス環境や他のAWSアカウントのVPCと接続（VPN、Direct Connect、VPCピアリング、Transit Gatewayなど）する予定がある場合、それらのネットワークのCIDRブロックと**重複しない**範囲を選択する必要があります。  
    これは最も重要な考慮事項の一つです。  

*   **再設計の困難さ**:  
    一度設定したVPCのプライマリCIDRブロックは、後から変更することが非常に困難です。  
    変更するには、通常VPCの再構築が必要となり、既存のリソースへの影響が大きいため、最初に余裕を持った設計をすることが推奨されます。  
    一般的には`/16`や`/17`が多くのシナリオで十分な柔軟性を提供します。  
    より小規模なシステムであれば`/20`なども検討できますが、将来の拡張に注意が必要です。  

---

### セキュリティグループとネットワークACLの違い

**Q3: セキュリティグループ (SG) とネットワークACL (NACL) の主な違いは何ですか？ どちらを使用すべきですか？**  

**A3:** セキュリティグループとネットワークACLは、VPCにおけるネットワークトラフィック制御の2つの主要なファイアウォール機能ですが、異なるレベルで動作し、異なる特性を持っています。  
両者の主な違いは以下の表の通りです。  

| 特徴           | セキュリティグループ (SG)                | ネットワークACL (NACL)             |
| :------------- | :--------------------------------------- | :----------------------------------- |
| **適用対象**   | EC2インスタンスなど個別のリソース        | サブネット                           |
| **適用レベル** | インスタンスレベル                       | サブネットレベル                     |
| **動作**       | **ステートフル**（応答トラフィックは自動許可） | **ステートレス**（応答トラフィックも明示的に許可が必要） |
| **ルール評価** | すべてのルールを評価し、許可ルールがあれば許可 | ルール番号の小さい順に評価し、一致した時点で適用 |
| **ルール**     | **許可ルールのみ**                       | **許可ルールと拒否ルールの両方**           |
| **デフォルト** | デフォルトではすべてのアウトバウンドを許可、すべてのインバウンドを拒否 | デフォルトではすべて許可（カスタム作成時は暗黙的にすべて拒否） |
| **制限**       | 1インスタンスに最大5つ                   | 1サブネットに1つ                     |

**どちらを使用すべきか？**  
通常は、**セキュリティグループを主要なファイアウォールとして使用し、ネットワークACLはオプションで追加のセキュリティレイヤーとして利用する**ことが推奨されます。  

*   **セキュリティグループを優先する理由**:  
    *   ステートフルであるため、設定がシンプルで管理しやすい。  
    *   インスタンスレベルでよりきめ細やかな制御が可能。  
    *   セキュリティグループIDをソース/宛先に指定できるため、動的なIPアドレス変更にも対応しやすい。  

*   **ネットワークACLの利用が有効なケース**:  
    *   特定のサブネット全体に対して、広範なアクセス制限や明示的な拒否ルールを設定したい場合。  
    *   例えば、特定の不正IPアドレスからのアクセスをサブネット全体でブロックしたい場合。  
    *   多層防御の一環として、セキュリティグループの手前でさらに厳格なフィルターをかけたい場合。  

結論として、セキュリティグループで最小権限のアクセス制御を行い、必要に応じてネットワークACLでサブネット全体のセキュリティを補強するというアプローチがベストプラクティスです。  

---前後の文脈を考慮し、VPC内のリソースへのアクセス方法についてのマークダウンを生成して下さい。見出しは## VPC内のリソースへのアクセス方法、付随する見出しは適宜「###」や「####」を使用して下さい。## VPC内のリソースへのアクセス方法

### 概要

VPC内にデプロイされたリソース（主にEC2インスタンスやRDSデータベースなど）へのアクセス方法は、そのリソースがパブリックサブネットに配置されているか、プライベートサブネットに配置されているかによって大きく異なります。  
セキュリティ要件と運用のしやすさを考慮し、適切なアクセス方法を選択することが重要です。  
ここでは、VPC内のリソースにアクセスするための様々な方法について解説します。  

### 1. パブリックサブネット内のリソースへのアクセス

パブリックサブネットに配置されたリソースは、インターネットゲートウェイ (IGW) を介してインターネットと直接通信できます。  

#### 1.1. インターネット経由の直接接続

*   **対象**: パブリックIPアドレスまたはElastic IPアドレス (EIP) が割り当てられたEC2インスタンスなど。  
*   **方法**:  
    *   **SSH (Linux)**: SSHクライアントを使用して、インスタンスのパブリックIPアドレスまたはEIP宛に接続します。  
        鍵ペア認証が一般的です。  
    *   **RDP (Windows)**: リモートデスクトップクライアントを使用して、インスタンスのパブリックIPアドレスまたはEIP宛に接続します。  
        ユーザー名とパスワード認証が一般的です。  
*   **必要な設定**:  
    *   インスタンスが起動されているサブネットに関連付けられたルートテーブルに、インターネットゲートウェイへのルート (`0.0.0.0/0` を IGW にルーティング) が存在すること。  
    *   インスタンスにアタッチされたセキュリティグループで、SSH (TCP 22) またはRDP (TCP 3389) ポートが、接続元のIPアドレス（例: `ご自身のIPアドレス/32`）から許可されていること。  
    *   EC2インスタンスの場合、起動時に指定した鍵ペア（Linux）または生成したパスワード（Windows）が必要です。  

| 接続元   | 接続先       | プロトコル | ポート | 必要なVPCコンポーネント | 備考                               |
| :------- | :----------- | :--------- | :----- | :---------------------- | :--------------------------------- |
| インターネット | EC2 (Public) | SSH/RDP    | 22/3389 | IGW, ルートテーブル, SG       | EIPまたはパブリックIPが必要          |

### 2. プライベートサブネット内のリソースへのアクセス

プライベートサブネットに配置されたリソースは、インターネットから直接アクセスできません。  
そのため、特別な方法を用いてアクセスする必要があります。  

#### 2.1. 踏み台サーバー (Bastion Host) 経由での接続

*   **対象**: プライベートサブネット内のEC2インスタンス、RDSデータベースなど。  
*   **仕組み**: パブリックサブネットに、インターネットからアクセス可能なEC2インスタンス（踏み台サーバー）を配置し、これを中継点としてプライベートサブネット内のリソースにアクセスします。  
*   **手順**:  
    1.  まず、ローカル環境から踏み台サーバーにSSHなどで接続します。  
    2.  次に、踏み台サーバーから目的のプライベートインスタンスにSSHなどで接続します。  
*   **利点**: 比較的シンプルで、多くの環境で利用されています。  
*   **セキュリティ考慮事項**:  
    *   踏み台サーバーはインターネットに公開されるため、厳格なセキュリティグループでSSH (TCP 22) やRDP (TCP 3389) ポートへのアクセスを信頼できるIPアドレスのみに制限する必要があります。  
    *   踏み台サーバーからプライベートインスタンスへの通信も、それぞれのセキュリティグループで許可する必要があります。  
    *   踏み台サーバー自体のセキュリティパッチ適用やログ監視も重要です。  

| 接続元       | 中継点           | 接続先              | プロトコル | ポート | 必要なVPCコンポーネント | 備考                                       |
| :----------- | :--------------- | :------------------ | :--------- | :----- | :---------------------- | :----------------------------------------- |
| インターネット | EC2 (Bastion Host) | EC2 (Private)       | SSH/RDP    | 22/3389 | IGW, ルートテーブル, SG       | Bastion Host経由でアクセス                   |
| インターネット | EC2 (Bastion Host) | RDS (Private)       | DB Port    | 3306/5432など | IGW, ルートテーブル, SG       | Bastion HostからDBクライアントで接続         |

#### 2.2. AWS Systems Manager Session Manager を利用した接続

*   **対象**: プライベートサブネット内のEC2インスタンス。  
*   **仕組み**: インターネットゲートウェイやSSHキーペア、開かれたSSHポートが不要で、AWSマネジメントコンソールやCLIからEC2インスタンスにセキュアにアクセスできます。  
    Session Managerは、EC2インスタンスにインストールされたSSMエージェントとSSMサービス間の通信を利用します。  
*   **利点**:  
    *   **セキュリティ強化**: SSHポートの開放が不要で、踏み台サーバーも不要です。  
    *   **監査**: すべてのセッション操作がCloudTrailにログ記録され、監査性が高いです。  
    *   **アクセス制御**: IAMポリシーできめ細かくアクセスを制御できます。  
*   **必要な設定**:  
    *   EC2インスタンスにSSMエージェントがインストールされていること。  
    *   EC2インスタンスに、SSMサービスと通信するための適切なIAMロールがアタッチされていること。  
    *   プライベートサブネットからSSMサービスにアクセスするために、VPCエンドポイント (Interface Endpoint) for SSM を設定することが推奨されます。  
        これにより、インターネットゲートウェイを経由せずにSSMにプライベートに接続できます。  

#### 2.3. AWS Client VPN を利用した接続

*   **対象**: プライベートサブネット内のすべてのリソース（EC2、RDSなど）。  
*   **仕組み**: PCやデバイスからVPCにVPN接続を確立し、ローカルネットワークをVPCのプライベートネットワークに一時的に拡張します。  
    これにより、デバイスがVPC内のプライベートIPアドレス空間に直接アクセスできるようになります。  
*   **利点**: 自宅やオフィスなど、どこからでも安全にVPC内のプライベートリソースにアクセスできます。  
*   **必要な設定**:  
    *   AWS Client VPNエンドポイントを作成し、VPC内のターゲットネットワーク（サブネット）に関連付けます。  
    *   認証方式（Active Directory、相互認証、SAMLなど）を設定します。  
    *   クライアントにVPNプロファイルを提供し、接続を設定します。  

| 接続元   | 接続先       | プロトコル | ポート | 必要なVPCコンポーネント | 備考                               |
| :------- | :----------- | :--------- | :----- | :---------------------- | :--------------------------------- |
| ローカルPC | VPC (Client VPN) | EC2 (Private), RDS (Private) | Any        | Any    | Client VPN Endpoint, ルートテーブル, SG | 全てのVPC内プライベートリソースへアクセス可能 |

#### 2.4. オンプレミス環境からの接続 (AWS Site-to-Site VPN / AWS Direct Connect)

*   **対象**: プライベートサブネット内のすべてのリソース。  
*   **仕組み**: オンプレミスデータセンターとVPC間にセキュアなVPN接続 (AWS Site-to-Site VPN) または専用線接続 (AWS Direct Connect) を確立します。  
    これにより、オンプレミスのサーバーやクライアントがVPC内のプライベートリソースに直接アクセスできるようになります。  
*   **利点**: ハイブリッドクラウド環境を構築し、オンプレミスとクラウド間でシームレスな通信を実現します。  
*   **必要な設定**:  
    *   仮想プライベートゲートウェイ (VGW) またはTransit Gateway をVPCにアタッチします。  
    *   カスタマーゲートウェイ (オンプレミス側) を設定します。  
    *   Site-to-Site VPN接続またはDirect Connect接続を設定します。  
    *   VPCおよびオンプレミス側のルーティングテーブルに、相手側のネットワークへのルートを設定します。  
    *   RDSなどのセキュリティグループで、オンプレミス側のCIDRブロックからのアクセスを許可します。  

### 3. VPC内リソースから外部へのアクセス

VPC内のリソースがVPC外部のインターネットや他のAWSサービスにアクセスする方法も重要です。  

*   **インターネットへのアウトバウンド通信**:  
    *   **パブリックサブネットのリソース**: パブリックIP/EIPを持つリソースは、インターネットゲートウェイ (IGW) を介して直接インターネットにアクセスできます。  
    *   **プライベートサブネットのリソース**: NATゲートウェイ（またはNATインスタンス）を介してインターネットにアクセスします。  
        これにより、内部リソースのプライベートIPアドレスを隠蔽しつつ、必要なアップデートや外部API連携が可能です。  
*   **AWSサービスへのプライベートアクセス**:  
    VPCエンドポイント (Gateway Endpoint/Interface Endpoint) を利用することで、Amazon S3, DynamoDB, CloudWatch, SQSなどのAWSサービスに、インターネットゲートウェイを経由せずにプライベートにアクセスできます。  
    これにより、セキュリティが強化され、データ転送コストが削減される場合があります。  

### 4. セキュリティの考慮事項

どのようなアクセス方法を選択するにしても、以下のセキュリティ原則を常に適用することが重要です。  

*   **最小権限の原則**: 必要なポートとプロトコルのみを許可し、アクセス元IPアドレスを最小限に制限します。  
*   **多層防御**: セキュリティグループとネットワークACLの両方を活用し、インスタンスレベルとサブネットレベルの両方でセキュリティ対策を講じます。  
*   **VPC Flow Logs**: VPC内のIPトラフィックを監視し、異常なアクセスパターンを検出できるようにVPC Flow Logsを有効にします。  
*   **IAMによるアクセス制御**: AWSサービスへのアクセスや管理操作は、IAMポリシーによって厳密に制御します。  

### まとめ

VPC内のリソースへのアクセス方法は、リソースの配置場所、接続元、およびセキュリティ要件によって多岐にわたります。  
パブリックサブネットのリソースにはインターネットからの直接アクセスが可能ですが、プライベートサブネットのリソースには踏み台サーバー、Session Manager、Client VPN、またはオンプレミスからのVPN/Direct Connectといった安全な経路を利用する必要があります。  
これらのアクセス方法を適切に理解し、最小権限の原則に基づいたセキュリティ設定と組み合わせることで、堅牢で効率的なクラウド環境を構築・運用できます。

## VPCのサイズの決定基準

### 概要

VPCを作成する際に、最初に指定するIPv4 CIDRブロック（例: `10.0.0.0/16`）のサイズは、VPCの将来の拡張性、管理の容易さ、および他のネットワークとの接続性に大きく影響します。  
一度VPCを作成し、多くのリソースをデプロイした後にプライマリCIDRブロックを変更することは非常に困難であり、多大な手間とリスクを伴います。  
そのため、VPCのサイズは慎重に計画し、決定する必要があります。  

### 1. 将来的なIPアドレスの枯渇と拡張性

VPCのCIDRブロックは、そのVPCが利用できるIPアドレスの総量を決定します。  
小さすぎるCIDRブロックを選択すると、以下のような問題が発生する可能性があります。  

*   **IPアドレスの枯渇**: サブネットの追加、新しいサービスのデプロイ（例: LambdaのENI、EKSのPod IP）、VPCピアリングによる連携など、VPC内のリソースが増加するにつれて、利用可能なIPアドレスが不足する可能性があります。  
*   **サブネット分割の制約**: 小さなVPC CIDRブロックでは、各アベイラビリティーゾーン (AZ) に複数のサブネット（パブリック、プライベート、データベースなど）を配置するための十分なIPアドレス空間を確保できない場合があります。  
*   **再設計のコスト**: IPアドレスが枯渇した場合、VPCを再構築するか、セカンダリCIDRブロックを追加する必要があります。  
    VPCの再構築は、すべてのリソースを再デプロイする必要があり、非常に時間とコストがかかります。  

**推奨事項**:  
通常は、将来的な拡張性を十分に考慮し、**`/16`や`/17`**といった比較的大きなCIDRブロックを選択することが推奨されます。  
これは、約65,000または32,000個のIPアドレスを提供し、多くのユースケースに対応できる十分な柔軟性を提供します。  
小規模なシステムや、単一の用途に特化したVPCであれば`/20`（約4,000個のIPアドレス）なども検討されますが、将来の拡張計画を明確にしておくべきです。  

### 2. 他のネットワークとの重複回避

VPCのCIDRブロックを決定する上で最も重要な考慮事項の一つは、他の既存ネットワークのCIDRブロックと重複しないようにすることです。  

*   **オンプレミス環境との接続**:  
    *   AWS Site-to-Site VPNやAWS Direct Connectを使用してオンプレミスデータセンターとVPCを接続する場合、VPCのCIDRブロックとオンプレミスのIPアドレス範囲が重複していると、ルーティングが正しく機能せず、通信が確立できません。  
*   **他のVPCとの接続**:  
    *   VPCピアリングやAWS Transit Gatewayを使用して複数のVPCを接続する場合も、接続するVPC間でCIDRブロックが重複していると、通信ができません。  
    *   大規模な組織で複数のAWSアカウントやVPCを管理する場合、会社全体のIPアドレス管理計画を策定し、CIDRブロックの割り当てを厳密に行うことが不可欠です。  

**推奨事項**:  
既存のオンプレミスネットワーク図や、他のAWS環境のVPC設計を事前に確認し、**重複しないプライベートIPアドレス範囲を慎重に選定**してください。  
可能であれば、将来的に接続する可能性のあるネットワークのIPアドレス計画も含めて検討します。  

### 3. サブネットの構成計画

VPCのCIDRブロックは、後からサブネットに分割されます。  
そのため、サブネットの構成計画がVPCのサイズ決定に影響を与えます。  

*   **アベイラビリティーゾーン (AZ) の数**: 高可用性のために何AZにサブネットを分散するかを決定します。  
    例えば、3つのAZを利用する場合、それぞれのAZにサブネットを割り当てる必要があります。  
*   **サブネットの種類**: パブリックサブネット、プライベートアプリケーションサブネット、プライベートデータベースサブネットなど、役割ごとにサブネットを分割します。  
    各AZにこれらのサブネットを作成することを考えると、多くのサブネットが必要になります。  
*   **サブネットのサイズ**: 各サブネットに必要なIPアドレス数を見積もります。  
    一般的には`/24`（256アドレス、利用可能251）がよく利用されますが、用途によっては`/25`や`/26`も検討されます。  
    Lambda関数やECS/EKSのFargateタスクなど、ENIを多く消費するサービスを多用する場合は、サブネット内のIPアドレス枯渇に特に注意が必要です。  
*   **AWSによるIPアドレスの予約**: 各サブネットのCIDRブロックから5つのIPアドレスがAWSによって予約され、リソースに割り当てられないことも考慮に入れる必要があります。  

**例**:  
3つのAZに、それぞれパブリック、プライベートアプリケーション、プライベートデータベースの3つのサブネットを`/24`で作成する場合:  
`3 AZs * 3 Subnets/AZ * 256 IP Addresses/Subnet = 2,304` 個のIPアドレスが必要です。  
これに将来的な追加サブネットやサービス拡張を考慮すると、`/16`や`/17`程度のVPCサイズが妥当であると判断できます。  

### 4. セカンダリCIDRブロックの活用

VPCのプライマリCIDRブロックの枯渇が予見されたり、特定の目的のために追加のIPアドレス範囲が必要になったりした場合、VPCに**セカンダリCIDRブロック**を追加することができます。  

*   **メリット**: 既存のVPCを再構築することなく、IPアドレス空間を拡張できます。  
*   **注意点**: セカンダリCIDRブロックからのIPアドレスを使用するサブネットを作成した場合、その新しいIPアドレス範囲へのルーティングが正しく設定されていることを確認する必要があります。  

### まとめ

VPCのIPv4 CIDRブロックのサイズ決定は、AWS上でのネットワーク設計の基盤となる重要な意思決定です。  
将来的なIPアドレスの枯渇、他の既存ネットワークとの重複、およびサブネットの構成計画を総合的に考慮し、慎重に余裕を持ったCIDRブロックを選択することが成功の鍵となります。  
一度決定したプライマリCIDRブロックは変更が困難であるため、初期段階での十分な計画が長期的な運用コストと管理負荷の軽減に繋がります。 

## セキュリティグループとネットワークACLの違い

### 概要

AWS VPCにおけるネットワークセキュリティは、主に「セキュリティグループ (Security Group, SG)」と「ネットワークACL (Network Access Control List, NACL)」という2つの異なるファイアウォール機能によって提供されます。  
これらはどちらもトラフィックをフィルタリングしますが、適用される階層、動作の特性、ルールの評価方法など、いくつかの重要な違いがあります。  
これらの違いを理解し、適切に使い分けることが、堅牢なVPCセキュリティ設計の鍵となります。  

### 主な違いの比較

両者の違いを以下の表にまとめます。  

| 特徴           | セキュリティグループ (SG)                | ネットワークACL (NACL)             |
| :------------- | :--------------------------------------- | :----------------------------------- |
| **適用レベル** | **インスタンスレベル**（ENIにアタッチ）    | **サブネットレベル**（サブネットに関連付け） |
| **動作**       | **ステートフル**                         | **ステートレス**                     |
| **ルールタイプ** | **許可ルールのみ**                       | **許可ルールと拒否ルールの両方**           |
| **ルール評価** | すべてのルールを評価し、許可ルールがあれば許可 | ルール番号の小さい順に評価し、一致した時点で適用 |
| **デフォルトルール** | ・アウトバウンド：すべて許可<br />・インバウンド：すべて拒否 | ・すべてのインバウンド/アウトバウンドを許可（デフォルトVPCのNACL）<br />・カスタムNACLでは暗黙的にすべて拒否 |
| **ターゲット**   | IPアドレス (CIDR)、他のセキュリティグループID | IPアドレス (CIDR)                    |

### 詳細な違いの解説

#### 1. 適用レベルの違い

*   **セキュリティグループ (SG)**:  
    EC2インスタンスなどの**個々のリソース**（正確にはElastic Network Interface (ENI)）にアタッチされます。  
    これにより、インスタンスごとにきめ細やかなアクセス制御が可能です。  
    例えば、WebサーバーインスタンスにはHTTP/HTTPSを許可し、DBサーバーインスタンスにはDBポートへのアクセスをAppサーバーインスタンスからのみ許可するといった設定ができます。  

*   **ネットワークACL (NACL)**:  
    **サブネット全体**に関連付けられます。  
    特定のサブネットに出入りするすべてのトラフィックを制御するため、サブネットの境界で広範なフィルタリングを行います。  
    サブネット内のどのインスタンスに対しても、NACLのルールが適用されます。  

#### 2. 動作（ステートフル vs ステートレス）の違い

この違いは、両者の最も重要な特性です。  

*   **セキュリティグループ (SG)**: **ステートフル**  
    インバウンドまたはアウトバウンドのいずれかの方向でトラフィックが許可されると、その**応答トラフィックは、明示的なルールがなくても自動的に許可されます**。  
    例えば、WebサーバーのセキュリティグループでインバウンドHTTP (80番ポート) を許可すれば、Webサーバーがクライアントに返すHTTPレスポンス（アウトバウンド）は自動的に許可されます。  

*   **ネットワークACL (NACL)**: **ステートレス**  
    インバウンドまたはアウトバウンドのいずれかの方向でトラフィックが許可された場合でも、その**応答トラフィックも、反対方向のルールで明示的に許可する必要があります**。  
    例えば、NACLでインバウンドHTTP (80番ポート) を許可した場合、WebサーバーからのアウトバウンドHTTPレスポンス（送信元ポートはエフェメラルポート）も明示的に許可するルールがなければ、通信は成立しません。  
    これは、クライアントが外部サービスに接続する際に一時的に使用するポート番号の範囲（エフェメラルポート、例: TCP 1024-65535）を、インバウンドとアウトバウンドの両方で許可する必要があることを意味します。  

#### 3. ルールタイプと評価順序の違い

*   **セキュリティグループ (SG)**:  
    **許可ルールのみ**を定義します。明示的に許可されていないすべてのトラフィックは拒否されます。  
    すべてのルールが評価され、許可ルールに一致すればトラフィックは許可されます。  

*   **ネットワークACL (NACL)**:  
    **許可ルールと拒否ルールの両方**を定義できます。  
    ルールには**番号**が付けられ、**番号の小さい順**に評価されます。  
    トラフィックがルールに一致すると、そのルールが適用され、それ以降のルールは評価されません。  
    最後に、すべてのトラフィックを拒否する暗黙のルールが常に存在します（デフォルトVPCのNACLを除く）。  
    これにより、特定のIPアドレスからのアクセスを明示的に拒否する、といったきめ細やかな制御が可能になります。  

### 使い分けとベストプラクティス

これらの違いを踏まえて、両者をどのように活用すべきかのベストプラクティスは以下の通りです。  

*   **多層防御**:  
    セキュリティグループとネットワークACLは、どちらか一方を選ぶのではなく、多層防御の原則に基づいて**組み合わせて使用する**ことが推奨されます。  
    *   **NACL**: サブネットの境界で、より広範かつ厳格なアクセス制御（特定のIPアドレスからの拒否、エフェメラルポートを含む基本的な通信の許可/拒否）を行います。  
    *   **SG**: 個々のインスタンスに対して、最小権限の原則に基づいたきめ細やかなアクセス制御を行います（特定のアプリケーションポートの許可、他のSGからのアクセス許可など）。  

*   **セキュリティグループを優先**:  
    通常、日常的なアクセス制御や、リソース間の通信許可設定には、設定がシンプルで管理しやすい**セキュリティグループを主要なファイアウォールとして使用します**。  

*   **NACLの活用シーン**:  
    *   特定のIPアドレスからのアクセスをVPCの特定部分（サブネット）全体で**明示的に拒否したい**場合。  
    *   規制要件などにより、より厳格なステートレスフィルタリングが必要な場合。  
    *   セキュリティグループの手前で、さらに一段階粗い粒度のフィルターを適用したい場合。  

### まとめ

セキュリティグループはインスタンスレベルでステートフルな許可ルールを提供し、ネットワークACLはサブネットレベルでステートレスな許可/拒否ルールを番号順に評価します。  
この特性の違いを理解し、両者を効果的に組み合わせることで、VPC内のリソースを包括的かつ多層的に保護し、堅牢なネットワークセキュリティを構築することができます。

## まとめ

### 概要

この教材を通じて、AWSのVPC（Virtual Private Cloud）について、その概念から詳細なコンポーネント、設計方法、設定・管理、そしてよくある質問に至るまで、包括的に学習してきました。  
VPCは、AWSクラウド上に安全で柔軟なネットワーク基盤を構築するための中心的なサービスであり、その適切な理解と活用は、クラウドジャーニーにおいて不可欠です。  
ここでは、これまでに学んだ内容を簡潔に振り返り、VPCの重要性を再確認します。  

### 1. VPCとは何か？ - クラウド上の専用ネットワーク

VPCは、AWSクラウド内に論理的に分離された、専用の仮想ネットワーク空間を提供します。  
これにより、IPアドレス範囲、サブネット、ルーティング、セキュリティグループ、ネットワークACLといったネットワーク要素を完全に制御し、あたかも自社のデータセンターをクラウド上に持っているかのようにリソースを運用できます。  
VPCの最大の価値は、セキュリティと隔離された環境、そしてネットワークの自由な設計能力にあります。  

### 2. VPCの基本要素 - ネットワークの構成ブロック

VPCは、以下の主要なコンポーネントの組み合わせによって機能します。  

| コンポーネント             | 主な役割                                                               |
| :------------------------- | :--------------------------------------------------------------------- |
| **VPC本体とCIDRブロック**  | 仮想ネットワーク全体のIPアドレス範囲を定義する枠組み。                   |
| **サブネット**             | VPCのIPアドレス範囲をAZごとに分割し、リソースを配置する区画（パブリック/プライベート）。 |
| **インターネットゲートウェイ (IGW)** | VPCとインターネット間の双方向通信を可能にする出入り口。                   |
| **ルートテーブル**         | ネットワークトラフィックがどこへ向かうべきかを指示するルールセット。         |
| **セキュリティグループ (SG)** | インスタンスレベルでインバウンド/アウトバウンドトラフィックを制御するステートフルなファイアウォール。 |
| **ネットワークACL (NACL)** | サブネットレベルでインバウンド/アウトバウンドトラフィックを制御するステートレスなファイアウォール。 |
| **NATゲートウェイ**        | プライベートサブネットのリソースがインターネットへアウトバウンド通信を行うためのゲートウェイ。 |

これらの要素が連携し、VPC内のリソースがVPC内外と安全かつ効率的に通信できるようになります。  

### 3. VPCの設計の重要性 - 事前の計画が成功の鍵

VPCの設計は、その後のシステムのセキュリティ、可用性、スケーラビリティ、そして運用コストに直接影響するため、入念な計画が不可欠です。  

*   **ネットワークの範囲を定める**: VPCのCIDRブロックは、将来の拡張性、オンプレミスや他のVPCとの重複回避を考慮して慎重に決定します。  
*   **サブネットの配置**: 高可用性のため複数AZに分散させ、パブリック/プライベートサブネットを明確に分離し、アプリケーション層ごとに配置します。  
*   **セキュリティの考慮**: セキュリティグループとネットワークACLを組み合わせて多層防御を構築し、最小権限の原則に基づいてアクセスを制御します。  
*   **ルーティング**: 各サブネットの役割に応じたルートテーブルを設定し、トラフィックの流れを最適化します。  

### 4. 他のAWSサービスとの連携 - VPCはエコシステムの中心

VPCは、単体で存在するのではなく、他の多くのAWSサービスと密接に連携します。  

*   **EC2インスタンスとの接続**: パブリック/プライベートサブネットへの配置、SSH/RDP、踏み台サーバー、Session Managerなど、様々なアクセス方法を理解することが重要です。  
*   **RDSとの接続**: 通常プライベートサブネットに配置し、セキュリティグループで厳密にアクセスを制御します。  
*   **VPCエンドポイント**: S3やDynamoDBなどのAWSサービスへのプライベートアクセスを可能にし、セキュリティと効率性を向上させます。  
*   **VPCピアリング/Transit Gateway**: 複数のVPCやオンプレミス環境とのセキュアな接続を実現し、ハイブリッドクラウドや大規模ネットワークを構築します。  

### 5. VPCの設定と管理 - 継続的な運用

VPCは一度構築したら終わりではありません。  
日々の運用を通じて、継続的に監視し、必要に応じて設定を調整・改善していく必要があります。  

*   **VPCとサブネットの作成**: 要件に応じたカスタムVPCを構築し、高可用性を考慮してサブネットを配置します。  
*   **セキュリティ設定**: セキュリティグループとネットワークACLのルールを定期的に見直し、最新の脅威に対応させます。  
*   **VPC Flow Logs**: ネットワークトラフィックを監視し、異常な挙動を早期に検知します。  
*   **IPアドレス管理**: IPアドレスの枯渇を防ぐため、使用状況を監視し、必要に応じてセカンダリCIDRブロックを追加します。  
