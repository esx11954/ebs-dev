# AWSサービス連携

---

## EC2インスタンスとの接続

### 概要

Amazon VPCは、AWSクラウド環境におけるネットワークの基盤であり、EC2インスタンスやRDSデータベースといった主要なAWSサービスがこのVPC内で稼働します。  
しかし、VPCの機能は単にリソースをホストするだけに留まりません。  
VPCは、VPC内のリソースとVPC外のAWSサービス、他のVPC、さらにはオンプレミス環境との間でセキュアで効率的な連携を可能にするための中心的な役割を担います。  
ここでは、VPCが他のAWSサービスとどのように連携するのかについて解説します。  

### 1. VPC内のリソースとの連携

VPCの最も基本的な連携は、その内部にデプロイされるAWSサービスとの間で行われます。  

*   **EC2インスタンスとの接続**:  
    EC2インスタンスはVPC内の特定のサブネットに起動され、サブネットのIPアドレス範囲からプライベートIPアドレスが割り当てられます。  
    インターネットアクセスが必要な場合は、パブリックIPアドレスまたはElastic IPアドレスが割り当てられ、インターネットゲートウェイ (IGW) を介して通信します。  
    詳細については、次の「EC2インスタンスとの接続」の項目で詳しく解説します。  
*   **RDS（Relational Database Service）との接続**:  
    RDSデータベースは、通常、インターネットから直接アクセスされないよう、プライベートサブネットに配置されます。  
    これにより、セキュリティが強化されます。  
    詳細については、次の「RDSとの接続」の項目で詳しく解説します。  
*   **Elastic Load Balancing (ELB) との連携**:  
    Application Load Balancer (ALB) や Network Load Balancer (NLB) は、通常パブリックサブネットに配置され、インターネットからのトラフィックをVPC内のEC2インスタンスやECSサービスに分散させます。  
    これにより、アプリケーションの高可用性とスケーラビリティを実現します。  

### 2. VPCとVPC外のAWSサービスとのプライベート連携 (VPCエンドポイント)

VPC内のプライベートサブネットに配置されたリソースが、インターネットゲートウェイを介さずに、S3やDynamoDBなどのAWSサービスにプライベートにアクセスするための機能です。  
これにより、セキュリティの強化、データ転送コストの削減、ネットワーク帯域幅の最適化が図れます。  

#### VPCエンドポイントの種類

| エンドポイントの種類     | 説明                                                                                                 | 対象サービス例                                              |
| :----------------------- | :--------------------------------------------------------------------------------------------------- | :---------------------------------------------------------- |
| **Gateway Endpoint**     | ルートテーブルのターゲットとして指定され、トラフィックをVPCネットワークから直接AWSサービスへルーティングします。 | Amazon S3, Amazon DynamoDB                                  |
| **Interface Endpoint**   | VPC内にElastic Network Interface (ENI) を作成し、プライベートIPアドレスを介してAWSサービスへのアクセスを可能にします。 AWS PrivateLinkという技術に基づいています。 | Amazon EC2 API, AWS Systems Manager, Amazon CloudWatch, AWS Lambda, Amazon Kinesisなど、多数のサービス |

*   **メリット**:  
    *   **セキュリティの向上**: インターネットを経由しないため、不正アクセスやデータ漏洩のリスクを低減します。  
    *   **コスト削減**: VPCエンドポイントを介した特定のサービスへのデータ転送は、インターネット経由のデータ転送よりも安価、あるいは無料になる場合があります。  
    *   **パフォーマンス**: インターネットへの往復が不要なため、レイテンシーが低減し、パフォーマンスが向上する可能性があります。  

### 3. 他のVPCとの連携

複数のVPCを運用する際、それらのVPC間でセキュアに通信する必要が生じることがあります。  

*   **VPCピアリング (VPC Peering)**:  
    2つのVPC間をプライベートに接続し、あたかも同じネットワークに属しているかのように通信できるようにします。  
    主に少数のVPC間を接続する場合に適しています。  
    ただし、接続するVPC間でCIDRブロックが重複していてはなりません。  
*   **AWS Transit Gateway (TGW)**:  
    多数のVPCやオンプレミスネットワークを一元的に接続するネットワークハブとして機能します。  
    大規模なネットワークにおいて、ハブ＆スポークモデルを実現し、複雑なルーティングを簡素化します。  
    VPCピアリングと異なり、より柔軟なルーティングポリシーを適用できます。  

### 4. オンプレミス環境との連携

VPCは、既存のオンプレミスデータセンターとのセキュアな接続も可能にします。  

*   **AWS Site-to-Site VPN**:  
    インターネットを経由して、VPCとオンプレミスネットワーク間に暗号化されたトンネルを確立します。  
    比較的容易に導入でき、安価にハイブリッドクラウド環境を実現できます。  
*   **AWS Direct Connect**:  
    データセンターからAWSへの専用の物理回線接続を提供します。  
    VPNよりも安定した高帯域幅、低遅延、高いセキュリティを必要とする場合に利用されます。  

### 5. その他の主要サービスとの連携

*   **AWS Lambda**:  
    Lambda関数がVPC内のリソース（例: プライベートサブネット内のRDSデータベースやEC2インスタンス）にアクセスする必要がある場合、Lambda関数をVPC内に設定できます。  
    この場合、LambdaはVPC内にENI (Elastic Network Interface) をプロビジョニングし、VPC内のリソースにプライベートに接続します。  
*   **Amazon ECS / EKS**:  
    コンテナオーケストレーションサービスであるAmazon Elastic Container Service (ECS) や Amazon Elastic Kubernetes Service (EKS) でデプロイされるコンテナやタスクは、VPC内のサブネットに配置され、VPCのネットワーク機能を利用して通信します。  
    特にAWS Fargateを利用する場合、タスクはVPC内のENIを取得し、VPC内の他のリソースとシームレスに連携します。  
*   **AWS Systems Manager (SSM)**:  
    VPC内のEC2インスタンスを管理するためのサービスであり、インターネットゲートウェイを介さずに、VPCエンドポイントを通じてプライベートにSSM APIにアクセスできます。  
    これにより、踏み台サーバーなしでインスタンスへのセキュアなリモートアクセスが可能になります。  

### まとめ

VPCは単なる仮想ネットワークではなく、AWSエコシステム全体の中心に位置し、他のAWSサービスや外部ネットワークとの連携を可能にする多機能な基盤です。  
VPCエンドポイント、VPCピアリング、Transit Gateway、VPN、Direct Connectといった様々な連携オプションを理解し、適切に設計・実装することで、要件に合致したセキュアで高可用性、スケーラブルなクラウドアーキテクチャを実現できます。

## EC2インスタンスとの接続

### 概要

Amazon Elastic Compute Cloud (EC2) インスタンスは、VPC内で稼働する最も基本的なコンピューティングリソースです。  
VPC環境では、EC2インスタンスのネットワーク接続性、インターネットアクセス、および他のリソースとの連携方法を、完全に制御できます。  
ここでは、VPC内でのEC2インスタンスの接続方法について詳しく解説します。  

### 1. EC2インスタンスの配置とIPアドレス

EC2インスタンスは、VPC内の特定のサブネットに起動されます。  

*   **プライベートIPアドレス**:  
    *   すべてのEC2インスタンスには、そのインスタンスが起動されたサブネットのCIDRブロックから、プライベートIPアドレスが割り当てられます。  
    *   このプライベートIPアドレスは、VPC内でのインスタンス間の通信に利用されます。  
    *   例えば、アプリケーションサーバー（プライベートIP）がデータベースサーバー（プライベートIP）に接続する場合などです。  
*   **パブリックIPアドレス**:  
    *   パブリックサブネットに起動されたインスタンスには、オプションでパブリックIPアドレスを自動割り当てできます。  
    *   このパブリックIPアドレスは、インターネットゲートウェイ (IGW) を介してインターネットと直接通信するために使用されます。  
    *   パブリックIPアドレスは、インスタンスの停止/起動によって変更される可能性があります。  
*   **Elastic IPアドレス (EIP)**:  
    *   固定のパブリックIPアドレスが必要な場合は、Elastic IPアドレス (EIP) を割り当てることができます。  
    *   EIPはAWSアカウントに関連付けられ、インスタンスの停止/起動によって変更されません。  
    *   通常、外部から直接アクセスされるWebサーバー、NATゲートウェイ、踏み台サーバーなどに利用されます。  
    *   EIPは、関連付けられていない場合に費用が発生する点に注意が必要です。  

### 2. インターネットへの接続性

EC2インスタンスがインターネットと通信できるかどうかは、インスタンスが配置されているサブネットの種類とルーティング設定によって決まります。  

#### 2.1. パブリックサブネット内のEC2インスタンス

*   **インターネットへのアクセス**: パブリックサブネットに配置されたEC2インスタンスがパブリックIPアドレスまたはEIPを割り当てられている場合、インターネットゲートウェイ (IGW) と関連付けられたルートテーブルを通じて、インターネットと直接双方向通信が可能です。  
*   **用途**: ロードバランサー配下のWebサーバー、公開APIサーバー、踏み台サーバーなど、インターネットからの直接アクセスが必要なリソースが配置されます。  

#### 2.2. プライベートサブネット内のEC2インスタンス

*   **インターネットへのアウトバウンド通信**: プライベートサブネットに配置されたEC2インスタンスは、インターネットゲートウェイへの直接ルートを持たないため、インターネットから直接アクセスされることはありません。  
    インターネットへのアウトバウンド通信が必要な場合は、NATゲートウェイ（またはNATインスタンス）を経由するようにルートテーブルを設定します。  
    これにより、セキュリティを維持しつつ、OSのアップデートや外部APIへの接続などが可能になります。  
*   **用途**: データベースサーバー、アプリケーションサーバー、内部処理サーバーなど、インターネットから隔離すべきリソースが配置されます。  

### 3. セキュリティグループとネットワークACLによるアクセス制御

EC2インスタンスへのアクセスは、セキュリティグループとネットワークACLによって制御されます。  

*   **セキュリティグループ (SG)**:  
    *   インスタンスレベルのファイアウォールとして、個々のEC2インスタンスへのインバウンドおよびアウトバウンドトラフィックを制御します。  
    *   最も重要なセキュリティ層であり、SSH (22番ポート)、HTTP (80番ポート)、HTTPS (443番ポート) など、必要なポートとプロトコルのみを、信頼できるソースIPアドレス（または他のSG）から許可するように設定します。  
    *   例: WebサーバーのSGはHTTP/HTTPSを `0.0.0.0/0` から許可し、データベースサーバーのSGはアプリケーションサーバーのSGからのデータベースポートのみを許可する。  
*   **ネットワークACL (NACL)**:  
    *   サブネットレベルのファイアウォールとして、サブネットに出入りするすべてのトラフィックを制御します。  
    *   セキュリティグループと連携して多層防御を形成し、より広範なアクセス制限や、特定のIPアドレスからの通信の拒否などに利用されます。  
    *   ステートレスであるため、EC2インスタンスへの応答トラフィックも考慮したルール設定が必要です。  

### 4. EC2インスタンスへの接続方法

VPC内のEC2インスタンスへの接続方法にはいくつかあります。  

#### 4.1. インターネット経由の直接接続 (パブリックサブネットのインスタンス)

*   **SSH (Linux)** / **RDP (Windows)**:  
    *   パブリックIPアドレスまたはEIPが割り当てられたEC2インスタンスには、インターネット経由でSSHクライアント（Linux）やRDPクライアント（Windows）を使用して直接接続できます。  
    *   この際、インスタンスのセキュリティグループでSSH (TCP 22) またはRDP (TCP 3389) ポートが、接続元IPアドレスから許可されている必要があります。  
    *   鍵ペア認証 (SSH) またはパスワード認証 (RDP) を使用します。  

#### 4.2. 踏み台サーバー (Bastion Host) 経由での接続 (プライベートサブネットのインスタンス)

*   プライベートサブネット内のインスタンスにはインターネットから直接接続できないため、パブリックサブネットに「踏み台サーバー」と呼ばれる専用のEC2インスタンスを配置し、これを中継点として利用します。  
*   **接続手順**:  
    1.  ローカルPCから踏み台サーバーにSSHで接続します (踏み台サーバーはパブリックIPとSSHを許可するSGを持つ)。  
    2.  踏み台サーバーから、プライベートサブネット内の目的のインスタンスにSSHで接続します (踏み台サーバーのSGと目的のインスタンスのSGで、内部SSH通信を許可する設定が必要)。  
*   **セキュリティ**: 踏み台サーバーは厳重なセキュリティ対策が施されるべきであり、最小限のポートのみを開放し、限られた管理者のみがアクセスできるようにします。  

#### 4.3. AWS Systems Manager Session Manager を利用した接続

*   AWS Systems Manager Session Manager は、踏み台サーバーなしで、プライベートサブネット内のEC2インスタンスにセキュアに接続できるAWSのマネージドサービスです。  
*   **メリット**:  
    *   **インターネットゲートウェイ不要**: インターネットゲートウェイやパブリックIPアドレス、SSHキーペアが不要です。  
    *   **ポート開放不要**: セキュリティグループでSSHポートを開放する必要がありません。  
    *   **監査**: すべてのセッション操作がCloudTrailにログ記録され、監査可能です。  
    *   **アクセス制御**: IAMポリシーでセッションアクセスをきめ細かく制御できます。  
*   **前提条件**: EC2インスタンスにSSMエージェントがインストールされており、SSMサービスと通信するためのIAMロールが割り当てられている必要があります。  
    VPCエンドポイント (Interface Endpoint) を利用することで、プライベートネットワーク経由でSSMにアクセスできます。  

### まとめ

VPC内でのEC2インスタンスの接続は、IPアドレスの割り当て、サブネットの種類、ルーティング、そしてセキュリティグループやネットワークACLの設定によって多角的に制御されます。  
特に、インターネットへの接続性の要否に応じてパブリック/プライベートサブネットを使い分け、セキュリティグループで厳格なアクセス制御を行うことが重要です。  
また、よりセキュアで運用が容易な接続方法として、AWS Systems Manager Session Managerの活用を検討することも推奨されます。

## RDSとの接続

### 概要

Amazon Relational Database Service (RDS) は、AWSが提供するマネージド型のリレーショナルデータベースサービスです。  
RDSインスタンスは、必ずAmazon VPC内にデプロイされます。  
セキュリティと可用性の観点から、通常はインターネットから直接アクセスされないプライベートサブネットに配置し、VPC内のアプリケーションサーバーなどから接続する構成がベストプラクティスとされます。  
ここでは、VPC内でのRDSインスタンスの配置と、各種リソースからの接続方法について解説します。  

### 1. RDSインスタンスのVPC内への配置

RDSインスタンスをデプロイする際、VPC内での配置方法が重要になります。  

#### 1.1. DBサブネットグループの作成

*   **必須要件**: RDSインスタンスをVPC内に作成するには、まず「DBサブネットグループ」を作成する必要があります。  
*   **サブネットの選択**: DBサブネットグループには、**最低2つの異なるアベイラビリティーゾーン (AZ) にわたるプライベートサブネット**を選択します。  
    これにより、RDSが自動フェイルオーバーを伴うMulti-AZデプロイメントをサポートできるようになります。  
*   **プライベートサブネットが基本**: セキュリティ上の理由から、インターネットから直接アクセスされないプライベートサブネットを選択します。  
    これらのサブネットには、インターネットゲートウェイへのルートを設定しません。  

#### 1.2. パブリックアクセスの設定

*   **「パブリックアクセス可能」の無効化**: RDSインスタンスを作成する際、「パブリックアクセス可能」のオプションは**「いいえ」に設定することを強く推奨します。**  
    これにより、RDSインスタンスにパブリックIPアドレスが割り当てられず、インターネットからの直接アクセスが不可能になります。  
*   **理由**: データベースは機密性の高いデータを扱うため、インターネットに直接公開すると、不正アクセスや攻撃のリスクが大幅に増加します。  
    VPCのプライベートネットワーク内で運用することで、強固なセキュリティ境界を確立できます。  

### 2. RDSインスタンスへの接続方法

RDSインスタンスへの接続は、接続元のリソースがどこにあるかによって異なります。  

#### 2.1. VPC内のEC2インスタンスからの接続

*   **最も一般的なパターン**: WebサーバーやアプリケーションサーバーなどのEC2インスタンスは、通常プライベートサブネットに配置され、同じVPC内のRDSデータベースに接続します。  
*   **接続経路**: EC2インスタンスがRDSインスタンスのエンドポイント（DNS名）を使用して、プライベートIPアドレス経由で接続します。  
    この通信はVPCの内部ネットワークに留まり、インターネットを経由しません。  
*   **セキュリティグループ**: 最も重要なのがセキュリティグループの設定です。  
    RDSインスタンスにアタッチされたセキュリティグループは、**接続を許可するEC2インスタンス（またはそのEC2インスタンスが属するセキュリティグループのID）からの、該当データベースポート（例: MySQLは3306、PostgreSQLは5432）のみを許可**するように設定します。  

#### 2.2. オンプレミス環境からの接続

*   **VPNまたはDirect Connect**: オンプレミス環境からRDSに接続する必要がある場合、AWS Site-to-Site VPNまたはAWS Direct Connectを介してVPCとオンプレミスネットワークを接続します。  
*   **ルーティング**: VPCのルートテーブルに、オンプレミスネットワークのCIDRブロックへのルート（ターゲットは仮想プライベートゲートウェイやTransit Gateway）を設定します。  
*   **セキュリティグループ**: RDSインスタンスのセキュリティグループで、オンプレミスネットワークのIPアドレス範囲からのデータベースポートへのアクセスを許可します。  

#### 2.3. 他のVPCからの接続

*   **VPCピアリングまたはTransit Gateway**: 別のVPCからRDSに接続するには、VPCピアリングまたはAWS Transit Gatewayを使用してVPC間を接続します。  
*   **ルーティング**: 各VPCのルートテーブルに、相手のVPCのCIDRブロックへのルートを設定します。  
*   **セキュリティグループ**: RDSインスタンスのセキュリティグループで、接続元VPCのアプリケーションサーバーが属するセキュリティグループIDまたはCIDRブロックからのデータベースポートへのアクセスを許可します。  

#### 2.4. AWS Lambda関数からの接続

*   **LambdaのVPC設定**: Lambda関数がVPC内のRDSデータベースにアクセスする必要がある場合、Lambda関数をVPC内に設定します。  
    これにより、LambdaはVPC内の指定されたサブネットにElastic Network Interface (ENI) をプロビジョニングし、VPC内のリソースにプライベートに接続できるようになります。  
*   **セキュリティグループ**: Lambda関数の設定時に指定されたセキュリティグループ（または、LambdaがプロビジョニングするENIにアタッチされるセキュリティグループ）からの、RDSインスタンスへのデータベースポートアクセスを許可するようにRDSのセキュリティグループを設定します。  

### 3. セキュリティの考慮事項

RDSとVPCの接続において、以下のセキュリティ対策を講じることが重要です。  

*   **厳格なセキュリティグループ**: RDSインスタンスのセキュリティグループは、最小権限の原則に基づき、必要なソース（アプリケーションサーバーのセキュリティグループIDなど）とポートのみを許可します。  
*   **パブリックアクセスなし**: 「パブリックアクセス可能」オプションは常に「いいえ」に設定し、インターネットからの直接アクセスを遮断します。  
*   **VPC Flow Logs**: VPC Flow Logsを有効にして、RDSへのネットワークトラフィックを監視し、異常なアクセスパターンを検出できるようにします。  
*   **暗号化**: RDSは、保存中のデータ（暗号化されたEBSボリューム）と転送中のデータ（SSL/TLS接続）の両方で暗号化をサポートしています。  
    これらを有効にして、データの機密性を保護します。  
*   **IAMデータベース認証**: RDSは、IAMユーザーとロールを使用してデータベースに接続できるIAMデータベース認証をサポートしています。  
    これにより、従来のパスワード認証に加えて、よりセキュアな認証メカニズムを提供できます。  

### 4. 高可用性の実現 (Multi-AZ)

*   **Multi-AZデプロイメント**: RDSのMulti-AZデプロイメントを有効にすることで、データベースの高可用性を実現できます。  
    これは、異なるAZに同期レプリカ（スタンバイインスタンス）を自動的にプロビジョニングし、プライマリインスタンスに障害が発生した場合に自動的にスタンバイにフェイルオーバーする機能です。  
*   **DBサブネットグループの重要性**: Multi-AZデプロイメントを有効にするためには、DBサブネットグループが**最低2つの異なるAZにわたるサブネット**を含んでいる必要があります。  
    これにより、AWSが異なるAZにプライマリとスタンバイを配置できるようになります。  

### まとめ

RDSとVPCの連携は、AWS上でリレーショナルデータベースを安全かつ高可用性で運用するための基盤です。  
特に、プライベートサブネットへの配置、DBサブネットグループの適切な設定、そしてセキュリティグループによる厳格なアクセス制御は、データベースのセキュリティを確保する上で不可欠です。  
さらに、Lambdaやオンプレミス環境など、多様な接続元からのアクセス要件に応じて、VPCピアリングやVPNなどの連携サービスを適切に活用することで、堅牢なデータベースアーキテクチャを実現できます。