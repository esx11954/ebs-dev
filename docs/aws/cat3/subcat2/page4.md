# VPC設計の基本原則

## VPCの設計方法

### 概要

VPCの設計は、AWS上で安定したセキュアなシステムを構築するための最も重要なステップの一つです。  
これまでの項目で学んだVPCの基本要素をどのように組み合わせ、ビジネス要件や技術要件を満たすネットワークを構築するかについて、具体的な設計アプローチを解説します。  
適切なVPC設計は、セキュリティ、可用性、スケーラビリティ、運用コストに直接影響します。  

### 1. VPCの目的と要件を明確にする

VPC設計を開始する前に、以下の点を明確にすることが重要です。  

*   **何のためにVPCを構築するのか？**: Webアプリケーション、データベース、バッチ処理、オンプレミス環境との連携など、主要な用途を特定します。  
*   **必要なリソースの種類**: EC2インスタンス、RDS、Lambda、S3など、デプロイするAWSサービスの種類を洗い出します。  
*   **セキュリティ要件**: インターネットからのアクセス制御、内部リソース間のアクセス制限、コンプライアンス要件（PCI DSS, HIPAAなど）を確認します。  
*   **可用性要件**: シングルAZ障害、複数AZ障害に対する耐性など、システムの稼働時間に関する目標を定めます。  
*   **スケーラビリティ要件**: 将来的なトラフィック増加やリソース拡張に対応できる設計を考慮します。  
*   **コスト要件**: サービス利用料、データ転送料など、予算内で運用できるかを確認します。  

### 2. ネットワークの範囲を定める (CIDRブロックの選定)

VPC設計の最初のステップは、VPC全体のIPアドレス範囲（CIDRブロック）を決定することです。  

#### 2.1. VPCのCIDRブロック選定

*   **プライベートIPアドレス範囲の選択**: RFC 1918で定義されているプライベートIPアドレス範囲（`10.0.0.0/8`、`172.16.0.0/12`、`192.168.0.0/16`）から選択します。  
    一般的には、`10.0.0.0/16` や `172.31.0.0/16` などが広く利用されます。  
*   **サイズ**: 将来的な拡張を考慮し、十分なIPアドレス空間を確保します。  
    小さすぎると後からIPアドレスが枯渇する可能性があり、大きすぎると他のネットワークとの重複リスクや管理の複雑さが増します。  
    一般的に`/16`や`/17`が推奨されますが、用途に応じて`/20`なども検討されます。  
*   **重複回避**: オンプレミス環境や、VPCピアリングなどで接続する予定の他のVPCのCIDRブロックと重複しないように注意します。  
    重複するとルーティングが正常に機能しなくなります。  
*   **セカンダリCIDRブロック**: 必要に応じて、VPC作成後にセカンダリCIDRブロックを追加することも可能です。  

### 3. サブネットの配置と構成

VPCのCIDRブロックを決定したら、次にサブネットを設計し、配置します。  

#### 3.1. アベイラビリティーゾーン (AZ) を考慮した配置

*   **高可用性**: 少なくとも2つ、可能であれば3つのアベイラビリティーゾーン (AZ) にサブネットを分散配置することで、単一AZ障害に対する耐性を高めます。  
*   **AZごとのサブネット**: 各AZに、アプリケーション層ごとにパブリックサブネットとプライベートサブネットを作成するのが一般的なベストプラクティスです。  

#### 3.2. サブネットの役割と分割

*   **層ごとの分割**: アプリケーションのアーキテクチャ（Web層、アプリケーション層、データベース層など）に基づいてサブネットを分割します。  
    これにより、セキュリティグループやネットワークACLによるアクセス制御を容易にし、管理性を向上させます。  
*   **パブリックサブネット**: インターネットから直接アクセスされるリソース（ロードバランサー、Webサーバー、NATゲートウェイなど）を配置します。  
    インターネットゲートウェイへのルートを設定します。  
*   **プライベートサブネット**: インターネットから直接アクセスされるべきではないリソース（アプリケーションサーバー、データベースサーバー、内部APIなど）を配置します。  
    インターネットへのアウトバウンド通信が必要な場合は、NATゲートウェイ経由でルーティングします。  
*   **サブネットのCIDR割り当て**: VPCのCIDRブロックから、各サブネットに適切なサイズのCIDRブロック（例: `/24`や`/25`）を割り当てます。  
    各サブネットにはAWSが予約する5つのIPアドレスがあることを考慮します。  

| サブネットタイプ | 配置AZ | CIDRブロック例 | 配置するリソース例                         |
| :--------------- | :----- | :------------- | :----------------------------------------- |
| **Public Subnet A** | AZ-A   | `10.0.1.0/24`  | ALB/NLB, Webサーバー(ELB配下), NATゲートウェイ |
| **Private Subnet A** | AZ-A   | `10.0.2.0/24`  | アプリケーションサーバー, DBサーバー     |
| **Public Subnet B** | AZ-B   | `10.0.11.0/24` | ALB/NLB, Webサーバー(ELB配下), NATゲートウェイ |
| **Private Subnet B** | AZ-B   | `10.0.12.0/24` | アプリケーションサーバー, DBサーバー     |

### 4. ルーティングの設計

各サブネットからのトラフィックがどこへ向かうべきかを決定するルートテーブルを設計します。  

*   **メインルートテーブル**: デフォルトで作成されますが、通常はカスタムルートテーブルを各サブネットに明示的に関連付けることを推奨します。  
*   **パブリックサブネットのルートテーブル**:  
    *   VPC内の通信: `local` ルート (`10.0.0.0/16` など)  
    *   インターネットへの通信: デフォルトルート `0.0.0.0/0` のターゲットとして**インターネットゲートウェイ (IGW)** を指定します。  
*   **プライベートサブネットのルートテーブル**:  
    *   VPC内の通信: `local` ルート (`10.0.0.0/16` など)  
    *   インターネットへのアウトバウンド通信: デフォルトルート `0.0.0.0/0` のターゲットとして**NATゲートウェイ**を指定します。  
    *   オンプレミスへの通信: VPNまたはDirect Connect経由の場合、特定のCIDR宛のターゲットとして**仮想プライベートゲートウェイ (VGW)** や **Transit Gateway** を指定します。  

### 5. セキュリティの考慮

多層防御の原則に基づき、セキュリティグループとネットワークACLを適切に設定します。  

*   **ネットワークACL (NACL)**:  
    *   サブネットレベルのファイアウォールとして、インバウンドおよびアウトバウンドトラフィックに対して、許可と拒否のルールを設定します。  
    *   特に、インターネットに直接公開されるパブリックサブネットや、機密性の高いプライベートサブネットの境界で、広範なアクセス制御を行います。  
    *   ステートレスであるため、インバウンドとアウトバウンドの両方で応答トラフィックのルールも明示的に許可する必要があります。  
*   **セキュリティグループ (SG)**:  
    *   インスタンスレベルのファイアウォールとして、個々のリソースへのきめ細やかなアクセス制御を行います。  
    *   最小権限の原則に基づき、必要なポートとプロトコル、ソースIPアドレスのみを許可します。  
    *   データベースインスタンスのセキュリティグループでは、アプリケーションサーバーのセキュリティグループからのアクセスのみを許可する、といった設定が可能です。  
    *   ステートフルであるため、応答トラフィックのルールは不要です。  
*   **パブリックIPアドレスの使用**: インターネットに公開する必要のないインスタンスには、パブリックIPアドレスを割り当てないようにします。  
*   **監視**: VPC Flow Logsを有効にして、VPC内のIPトラフィックを監視し、異常な通信を検出できるようにします。  

### 6. その他の考慮事項

*   **VPCピアリング/Transit Gateway**: 複数のVPC間で通信が必要な場合、VPCピアリング（少数のVPC間）またはTransit Gateway（多数のVPCやオンプレミスとの接続）を検討します。  
*   **VPN/Direct Connect**: オンプレミス環境とのセキュアな接続が必要な場合、AWS Site-to-Site VPNまたはAWS Direct Connectを設計に組み込みます。  
*   **高可用性のためのサービス**:  
    *   ロードバランサー (ALB/NLB) を利用して、複数のEC2インスタンスへのトラフィックを分散します。  
    *   Auto Scaling Group を利用して、EC2インスタンスを自動的にスケールさせ、障害発生時にインスタンスを自動復旧させます。  
    *   RDS Multi-AZを利用して、データベースの可用性を高めます。  
*   **コスト最適化**: 不要なNATゲートウェイの数を減らす、データ転送コストを考慮したアーキテクチャにするなど、コストに配慮した設計を行います。  

### まとめ

VPCの設計は、アプリケーションとビジネスの成功を左右する重要なフェーズです。  
VPCの目的を明確にし、IPアドレス計画、サブネット配置、ルーティング、セキュリティ対策、高可用性、スケーラビリティ、コストといった多岐にわたる要素を総合的に考慮することで、堅牢で効率的かつ安全なクラウドネットワーク基盤を構築することができます。  
この設計図に基づいて、次の項目からは具体的なVPCの構築手順を学んでいきます。

## ネットワークの範囲を定める

### 概要

VPCを設計する上での最初の、そして最も重要なステップの一つが、VPC全体のプライベートIPアドレス範囲（CIDRブロック）を決定することです。  
この決定は、VPCの将来の拡張性、他のネットワークとの接続性、および管理の容易さに大きく影響するため、慎重に行う必要があります。  

### 1. プライベートIPアドレス範囲の選択

AWS VPCは、RFC 1918で定義されているプライベートIPアドレス範囲を使用します。  
これらのアドレスはインターネット上ではルーティングされないため、セキュリティを確保しつつ、独自のネットワーク空間を構築できます。  
利用可能なプライベートIPアドレス範囲は以下の通りです。  

| 範囲          | 形式        | 利用可能なIPアドレス数（最大） |
| :------------ | :---------- | :----------------------------- |
| `10.0.0.0` - `10.255.255.255` | `10.0.0.0/8` | 約1670万                         |
| `172.16.0.0` - `172.31.255.255` | `172.16.0.0/12` | 約100万                          |
| `192.168.0.0` - `192.168.255.255` | `192.168.0.0/16` | 約6万5千                           |

#### 選定のポイント

*   **一般的な推奨**: 一般的には、`10.0.0.0/16` や `172.31.0.0/16` のような比較的広い範囲が推奨されます。  
    これにより、将来的に多くのサブネットやリソースを追加する際にもIPアドレスの枯渇を心配する必要が少なくなります。  
*   **オンプレミスとの連携**: オンプレミス環境とVPCをVPNやAWS Direct Connectで接続する予定がある場合、オンプレミス側のネットワークCIDRブロックと重複しない範囲を選択することが絶対条件です。  
    重複すると、VPCとオンプレミス間のルーティングが正しく行われなくなります。  
*   **VPCピアリング/Transit Gateway**: 複数のVPCをVPCピアリングやTransit Gatewayで接続する場合も、各VPCのCIDRブロックが重複しないように設計する必要があります。  

### 2. VPCのCIDRブロックサイズの決定

VPCのCIDRブロックは、`/16`から`/28`の範囲で指定できます。  
通常は、将来的な拡張性を考慮して、`/16`または`/17`など、比較的小さな数値（広い範囲）を選ぶことが推奨されます。  

#### サイズ選定の考慮事項

*   **必要なIPアドレス数**: 現在および将来的にVPC内に配置する予定のサブネット数、各サブネットに配置するリソース数を見積もり、それらに十分なIPアドレス空間を確保します。  
    例えば、`/16`のVPCは65,536個のIPアドレスを提供し、`/20`のVPCは4,096個のIPアドレスを提供します。  
*   **サブネットへの分割**: VPCのCIDRブロックは、後からサブネットに分割されます。  
    サブネットは通常`/24`や`/25`などの単位で作成されるため、それらを収容できる十分な親CIDRブロックが必要です。  
*   **管理の容易さ**: CIDRブロックが広すぎると、IPアドレス管理が煩雑になる可能性がありますが、AWS環境では通常、管理ツールがこの負担を軽減します。  
    むしろ、IPアドレスの枯渇による再設計の手間や影響の方が大きいため、余裕を持たせた設計が推奨されます。  

#### 例

*   **`10.0.0.0/16`**:  
    *   約65,000個のIPアドレスが利用可能です。  
    *   例えば、2つのAZにそれぞれパブリック/プライベートサブネットを`/24`で構成する場合、合計4つのサブネットで最大251 IPアドレス * 4 = 1,004 IPアドレスを利用します。  
    *   残りのアドレス空間は、将来の拡張や追加のサブネット、VPCピアリングなどが考慮できます。  
*   **`10.0.0.0/20`**:  
    *   約4,000個のIPアドレスが利用可能です。  
    *   小規模なシステムや、単一の用途に特化したVPCで利用されることがあります。  
    *   将来的に多くのサービスを追加する可能性が低い場合に選択肢となりますが、拡張性には注意が必要です。  

### 3. CIDRブロックの重複回避の重要性

VPCのCIDRブロックが他のネットワークと重複することは、深刻な問題を引き起こします。  

*   **オンプレミス環境との重複**:  
    *   VPNやAWS Direct Connectを介してVPCとオンプレミスネットワークを接続しようとした場合、ルーティングが正しく行われず、通信が確立できません。  
    *   これはIPアドレスの競合（Conflict）によるもので、パケットがどこへ向かうべきか判断できなくなるためです。  
*   **他のAWS VPCとの重複**:  
    *   VPCピアリングやTransit Gatewayを使って複数のVPCを接続しようとした場合、重複するCIDRブロックを持つVPC間では通信できません。  
    *   大規模な組織で複数のAWSアカウントやVPCを管理する場合、IPアドレス管理計画を策定し、CIDRブロックの割り当てを厳密に行うことが不可欠です。  

### 4. セカンダリCIDRブロックの利用

VPCの作成後に、プライマリCIDRブロックとは別に、追加のIPアドレス範囲を関連付けることができます。  
これをセカンダリCIDRブロックと呼びます。  

*   **用途**:  
    *   当初のCIDRブロックが枯渇し始めたが、VPCを再構築するコストが高い場合。  
    *   特定のサービスや用途のために独立したIPアドレス範囲を設けたい場合。  
    *   新しいオンプレミスネットワークとの接続を計画しており、既存のCIDRブロックでは重複が生じるが、追加のCIDRブロックは重複しない場合。  
*   **注意点**: セカンダリCIDRブロックを追加した場合、その範囲をルーティングするための追加設定が必要になります。  

### まとめ

VPCのネットワーク範囲（CIDRブロック）を定めることは、その後のVPC内のリソース配置やルーティング設計の基盤となります。  
将来の拡張性を考慮し、他のネットワークとの重複を避け、十分なIPアドレス空間を確保することが、安定的でスケーラブルなAWS環境を構築するための出発点となります。  
このステップでの適切な計画が、長期的な運用コストと管理負荷の軽減に繋がります。

## サブネットの配置

### 概要

VPCのCIDRブロックを決定したら、次にそのVPCを実際に機能させるための「サブネット」を配置していきます。  
サブネットの配置は、アプリケーションの可用性、セキュリティ、およびスケーラビリティに直接影響するため、慎重な計画が必要です。  
ここでは、効果的なサブネット配置の考え方とベストプラクティスについて解説します。  

### 1. アベイラビリティーゾーン (AZ) を考慮した配置

AWS環境における高可用性を実現するために最も重要なのが、複数のアベイラビリティーゾーン (AZ) を利用することです。  

*   **AZとは**: 各AWSリージョンは、互いに物理的に隔離された1つ以上の独立したデータセンター群であるAZで構成されています。  
    AZは、互いに十分な距離がありながら、低遅延で接続されています。  
*   **高可用性設計**: アプリケーションのコンポーネントを複数のAZに分散して配置することで、単一のAZ障害が発生した場合でも、残りのAZでサービスを継続できます。  
*   **サブネットとAZ**: 各サブネットは、必ず単一のAZに紐付けられます。  
    したがって、複数のAZにリソースを分散するには、それぞれのAZに専用のサブネットを作成する必要があります。  
    **ベストプラクティスとしては、最低でも2つのAZ、可能であれば3つのAZにサブネットを配置します。**  

### 2. サブネットの種類と役割分担

サブネットは、その役割に応じて「パブリックサブネット」と「プライベートサブネット」に大別されます。  
アプリケーションの多層アーキテクチャに合わせて、これらを適切に配置することがセキュリティ確保の鍵となります。  

#### 2.1. パブリックサブネット (Public Subnet)

*   **役割**: インターネットから直接アクセスされる必要のあるリソースを配置します。  
    インターネットゲートウェイ (IGW) へのルートを持ち、インターネットとの直接通信が可能です。  
*   **配置するリソース例**:  
    *   **ロードバランサー (ALB/NLB)**: インターネットからのトラフィックをアプリケーションサーバーに分散します。  
    *   **Webサーバー**: ロードバランサーの配下に配置され、直接インターネットに公開される部分。  
    *   **NATゲートウェイ**: プライベートサブネットのリソースがインターネットへアウトバウンド通信を行うためのゲートウェイ。  
    *   **踏み台サーバー (Bastion Host)**: プライベートサブネット内のリソースへSSHなどでアクセスするための中継点。  
*   **セキュリティ**: インターネットに公開されるため、セキュリティグループとネットワークACLによる厳格なアクセス制御が不可欠です。  

#### 2.2. プライベートサブネット (Private Subnet)

*   **役割**: インターネットから直接アクセスされるべきではない、機密性の高いリソースや内部処理を担うリソースを配置します。  
    インターネットゲートウェイへの直接ルートを持ちません。  
*   **配置するリソース例**:  
    *   **アプリケーションサーバー**: Webサーバーからのリクエストを受けてビジネスロジックを実行します。  
    *   **データベースサーバー (RDS)**: アプリケーションが利用するデータを保存します。  
    *   **キャッシュサーバー (ElastiCache)**: データベースの負荷軽減や高速化に利用されます。  
    *   **内部APIサーバー**: 外部には公開しない内部サービス。  
*   **セキュリティ**: インターネットから直接アクセスできないため、パブリックサブネットよりも高いセキュリティを保てます。  
    インターネットへのアウトバウンド通信が必要な場合は、NATゲートウェイを経由させます。  

### 3. サブネットのIPアドレス割り当て (CIDRブロックの分割)

VPCのCIDRブロックを、各サブネットに切り出して割り当てます。  

*   **適切なサイズ**: 各サブネットに必要なIPアドレス数を考慮して、適切なサイズのCIDRブロック（例: `/24`、`/25`、`/26`）を割り当てます。  
    `/24`は256個のIPアドレス（利用可能251個）、`/25`は128個（利用可能123個）です。  
*   **IPアドレスの予約**: AWSは、各サブネットのCIDRブロックから5つのIPアドレスを内部的に予約します。  
    これらはリソースに割り当てられないため、サブネットサイズを検討する際に考慮する必要があります。  
*   **計画的な割り当て**: 将来的な拡張や他のVPCとのピアリング、あるいはオンプレミスネットワークとの接続を考慮し、IPアドレスの重複や枯渇が発生しないように計画的に割り当てます。  

#### サブネット配置例（複数AZ、多層アーキテクチャ）

例えば、VPCのCIDRブロックが`10.0.0.0/16`の場合、以下のようにサブネットを配置できます。  

| サブネット名              | アベイラビリティーゾーン | CIDRブロック    | 役割                     | 配置リソース例                         |
| :------------------------ | :----------------------- | :-------------- | :----------------------- | :------------------------------------- |
| `Public-Subnet-A`         | `ap-northeast-1a`        | `10.0.1.0/24`   | インターネット公開層     | ALB, NAT Gateway, Bastion Host         |
| `Private-App-Subnet-A`    | `ap-northeast-1a`        | `10.0.2.0/24`   | アプリケーション層       | EC2 (App Server), Lambda ENI           |
| `Private-DB-Subnet-A`     | `ap-northeast-1a`        | `10.0.3.0/24`   | データベース層           | RDS, ElastiCache                       |
| `Public-Subnet-B`         | `ap-northeast-1c`        | `10.0.11.0/24`  | インターネット公開層     | ALB, NAT Gateway (別のAZ), Bastion Host |
| `Private-App-Subnet-B`    | `ap-northeast-1c`        | `10.0.12.0/24`  | アプリケーション層       | EC2 (App Server), Lambda ENI           |
| `Private-DB-Subnet-B`     | `ap-northeast-1c`        | `10.0.13.0/24`  | データベース層           | RDS, ElastiCache                       |
| `Private-Tools-Subnet-A`  | `ap-northeast-1a`        | `10.0.20.0/24`  | 運用ツール、管理層（オプション） | CI/CDサーバー、監視ツール             |

この例では、異なるAZに同じ役割を持つサブネットを配置し、さらにパブリック/プライベート、アプリケーション/データベースといった論理的な層で分割しています。  
これにより、各層に適切なセキュリティルールやルーティングを設定し、システムの可用性を高めることができます。  

### 4. サブネットのセキュリティ設計

サブネットの配置と同時に、各サブネットのセキュリティについても計画します。  

*   **ネットワークACL (NACL)**: 各サブネットにはNACLを関連付け、サブネットレベルでのトラフィックフィルタリングを行います。  
    特に、パブリックサブネットではインターネットからの不要なアクセスをNACLで拒否し、プライベートサブネットではVPC内の特定のサブネットからのアクセスのみを許可するなどの厳格なルールを設定します。  
*   **ルーティング**: 各サブネットのルートテーブルを、その役割に応じて適切に設定します。  
    例えば、プライベートサブネットはIGWへのルートを持たせず、インターネットへのアウトバウンド通信はNATゲートウェイ経由にすることで、外部からの直接アクセスを遮断します。  

### まとめ

サブネットの配置は、VPC設計の中核をなす部分であり、アプリケーションのセキュリティ、高可用性、スケーラビリティに直接的な影響を与えます。  
複数のアベイラビリティーゾーンにまたがる設計、パブリックとプライベートの明確な分離、そしてアプリケーション層に応じた論理的な分割を組み合わせることで、堅牢で柔軟なクラウドネットワーク基盤を構築できます。  
この計画に基づいて、次のステップで具体的なルーティングやセキュリティ設定を行っていきます。

## セキュリティの考慮

### 概要

VPCにおけるセキュリティは、AWSクラウド上に構築するシステム全体の堅牢性を左右する最も重要な要素の一つです。  
VPCでは、セキュリティグループとネットワークACLという2つの主要なファイアウォール機能に加え、ルーティングやIPアドレス管理など、様々なレベルでセキュリティ対策を講じることができます。  
ここでは、多層防御の原則に基づき、VPC環境で考慮すべきセキュリティ対策とベストプラクティスについて解説します。  

### 1. 多層防御 (Defense in Depth) の原則

セキュリティは単一の対策ではなく、複数のセキュリティ層を組み合わせることで強化されます。  
VPCでは、以下のレベルでセキュリティ対策を講じることが可能です。  

| セキュリティ層         | 適用範囲             | 主なAWSサービス/機能           |
| :--------------------- | :------------------- | :----------------------------- |
| **VPC境界**            | VPC全体              | VPC CIDR選択、VPCピアリング、Transit Gateway、VPN/Direct Connect |
| **サブネット境界**     | サブネット           | **ネットワークACL (NACL)**     |
| **インスタンス境界**   | インスタンス/ENI     | **セキュリティグループ (SG)**  |
| **アプリケーション層** | アプリケーション     | AWS WAF, IAM                   |
| **データ層**           | データストア         | 暗号化 (KMS, S3, RDS), IAM     |
| **ログ・監視層**       | 全体                 | VPC Flow Logs, CloudWatch, CloudTrail, GuardDuty |

### 2. セキュリティグループ (SG) の活用

セキュリティグループは、インスタンスレベルで最もきめ細やかなアクセス制御を提供するステートフルなファイアウォールです。  

*   **最小権限の原則 (Principle of Least Privilege)**:  
    *   必要なポート、プロトコル、ソースIPアドレス（またはセキュリティグループID）のみを許可するように設定します。  
    *   例えば、WebサーバーにはHTTP/HTTPS (`0.0.0.0/0`) とSSH (`管理用IP/32`) のみ許可し、データベースサーバーにはアプリケーションサーバーのセキュリティグループからのアクセスのみを許可する、といった設定が理想的です。  
*   **内部通信の制御**:  
    *   同じVPC内のリソース間（例: Webサーバーとアプリケーションサーバー）の通信を制御する際にもセキュリティグループIDをソース/ターゲットとして指定すると非常に便利です。  
    *   これにより、インスタンスのプライベートIPアドレスが変更されても、セキュリティグループの設定を変更する必要がなくなります。  
*   **デフォルトアウトバウンドルールの確認**:  
    *   セキュリティグループのデフォルトでは、すべてのアウトバウンドトラフィックが許可されています。  
    *   特定のサービスからのアウトバウンド通信のみを許可したい場合は、デフォルトルールを削除し、必要なルールのみを明示的に追加する必要があります。  

### 3. ネットワークACL (NACL) の活用

ネットワークACLは、サブネットレベルでトラフィックを制御するステートレスなファイアウォールです。  
セキュリティグループよりも粗い粒度で、より厳格なルールを設定できます。  

*   **サブネット境界での制御**:  
    *   特定のサブネットへの広範なアクセス制限をかける際に活用します。  
    *   例えば、インターネットに面するパブリックサブネットに対して、特定の国からのアクセスを拒否するルールを設定する、といった使い方があります。  
*   **拒否ルールの活用**:  
    *   セキュリティグループではできない、明示的な「拒否」ルールを設定できるのがNACLの大きな特徴です。  
    *   特定のマルウェア感染源とされるIPアドレスからのアクセスをブロックするなどのブラックリスト運用に利用できます。  
*   **ステートレスな性質への注意**:  
    *   NACLはステートレスであるため、インバウンドルールとアウトバウンドルールの両方で、要求と応答の両方のトラフィックを明示的に許可する必要があります。  
    *   特に、クライアントが外部サービスに接続する際に使用する一時的なポート（エフェメラルポート）範囲を考慮したルール設定が必要です（例: TCP 1024-65535）。  
*   **デフォルトNACLの変更**:  
    *   VPC作成時に自動的に作成されるデフォルトNACLは、すべてを許可する設定です。  
    *   セキュリティを強化するためには、カスタムNACLを作成し、それをサブネットに関連付けることで、明示的なルール管理に切り替えることを推奨します。  

### 4. パブリックIPアドレスとインターネットアクセスの制御

インターネットへのアクセスパスは、セキュリティリスクの主要な要因となります。  

*   **必要な場合のみパブリックIP/EIPを使用**:  
    *   インターネットから直接アクセスされる必要のないインスタンス（データベースサーバー、アプリケーションサーバーなど）には、パブリックIPアドレスやElastic IPアドレスを割り当ててはいけません。  
    *   これらのリソースはプライベートサブネットに配置し、パブリックIPを持たせないことで、インターネットからの直接的な露出を避けます。  
*   **インターネットゲートウェイ (IGW) の適切な利用**:  
    *   IGWはパブリックサブネットからのインターネットアクセスを許可するためにのみ利用し、プライベートサブネットからの直接アクセスは遮断します。  
*   **NATゲートウェイによるアウトバウンド通信**:  
    *   プライベートサブネット内のリソースがインターネットにアウトバウンド通信する必要がある場合は、NATゲートウェイを経由させます。  
    *   これにより、内部リソースのIPアドレスを隠蔽しつつ、必要な通信を可能にします。  
*   **踏み台サーバー (Bastion Host)**:  
    *   プライベートサブネット内のインスタンスにSSHなどでアクセスする際は、パブリックサブネットに配置した踏み台サーバーを中継点として利用します。  
    *   踏み台サーバー自体も、最小限のポート（例: SSH 22番ポート）のみを許可する厳格なセキュリティグループで保護します。  

### 5. ルーティングのセキュリティ

ルートテーブルはトラフィックの流れを決定するため、セキュリティと密接に関連します。  

*   **プライベートサブネットの隔離**:  
    *   プライベートサブネットのルートテーブルには、インターネットゲートウェイへのルートを設定しないことで、インターネットからの直接アクセスを物理的に（論理的に）不可能にします。  
*   **不正なルーティングの防止**:  
    *   意図しないルーティング設定が、セキュリティホールとなる可能性があります。  
    *   ルートテーブルは常に最小限のルートで構成し、定期的にレビューすることが重要です。  

### 6. その他のセキュリティ対策

VPCのコンポーネント以外にも、AWSサービス全体で考慮すべきセキュリティ対策があります。  

*   **VPC Flow Logs**:  
    *   VPC内のIPトラフィックの情報をキャプチャし、CloudWatch LogsやS3に発行します。  
    *   これにより、ネットワークトラフィックの監視、診断、トラブルシューティング、およびセキュリティ分析が可能になります。  
*   **AWS WAF**:  
    *   WebアプリケーションをSQLインジェクションやクロスサイトスクリプティング（XSS）などの一般的なWebの脆弱性やボットから保護します。  
    *   Application Load Balancer (ALB) や Amazon CloudFront、API Gatewayと連携します。  
*   **AWS Shield**:  
    *   DDoS（分散型サービス拒否）攻撃からAWSリソースを保護します。  
    *   StandardとAdvancedの2つのティアがあります。  
*   **AWS IAM (Identity and Access Management)**:  
    *   VPCの設定やリソースへのアクセスを制御するユーザー、グループ、ロールに対して、最小権限の原則に基づいた権限を付与します。  
*   **データ暗号化**:  
    *   保存中のデータ（S3、EBS、RDSなど）や転送中のデータを暗号化することで、データ漏洩のリスクを低減します。  
    *   AWS Key Management Service (KMS) を利用して暗号化キーを管理します。  
*   **セキュリティパッチと脆弱性スキャン**:  
    *   EC2インスタンスのOSやアプリケーションに対して、定期的にセキュリティパッチを適用します。  
    *   Amazon Inspectorなどのサービスを利用して、システムやアプリケーションの脆弱性をスキャンし、検出された問題に対処します。  
