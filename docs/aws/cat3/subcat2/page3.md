# セキュリティと外部接続

---

## セキュリティグループとネットワークACL

### 概要

AWS VPCでは、ネットワークトラフィックを制御するために、主に「セキュリティグループ」と「ネットワークACL（NACL）」という2つの強力なファイアウォール機能を提供しています。  
これらは異なるレベルで動作し、それぞれ異なる特性を持っています。  
両者の違いを理解し、適切に組み合わせることで、多層的なセキュリティ対策を実現し、VPC内のリソースを保護することができます。  

### 1. セキュリティグループ (Security Group)

セキュリティグループは、EC2インスタンスなど、個々のリソースにアタッチされるインスタンスレベルの仮想ファイアウォールです。  
インスタンスへのインバウンド（着信）およびアウトバウンド（送信）トラフィックを制御します。  

#### 特徴

*   **ステートフル**: トラフィックが許可されると、その応答トラフィックは、明示的なルールがなくても自動的に許可されます。  
    例えば、Webサーバーが外部にHTTPレスポンスを送信した後、そのレスポンスがセキュリティグループによってブロックされることはありません。  
*   **許可のみ**: セキュリティグループは、許可するトラフィックのルールのみを定義します。  
    明示的に許可されていないすべてのトラフィックは拒否されます。  
*   **適用レベル**: ENI（Elastic Network Interface）またはインスタンスレベルで適用されます。  
    1つのインスタンスに複数のセキュリティグループをアタッチすることも可能です。  
*   **ルール**:  
    *   **インバウンドルール**: インスタンスへの着信トラフィックを制御します。  
    *   **アウトバウンドルール**: インスタンスからの送信トラフィックを制御します。デフォルトではすべての送信トラフィックが許可されています。  
*   **ソース/宛先**: IPアドレス (CIDR) または別のセキュリティグループIDを指定できます。  
    セキュリティグループをソースに指定すると、そのセキュリティグループに属するインスタンスからのトラフィックのみを許可するといった柔軟な設定が可能です。  

#### 設定例（Webサーバーのセキュリティグループ）

| タイプ  | プロトコル | ポート範囲 | ソース      | 概要                           |
| :------ | :--------- | :--------- | :---------- | :----------------------------- |
| HTTP    | TCP        | 80         | `0.0.0.0/0` | 世界中のどこからでもHTTPアクセスを許可 |
| HTTPS   | TCP        | 443        | `0.0.0.0/0` | 世界中のどこからでもHTTPSアクセスを許可 |
| SSH     | TCP        | 22         | `自分のIP/32` | 特定のIPからのみSSHアクセスを許可      |
| All traffic | All        | All        | `0.0.0.0/0` | すべてのアウトバウンドトラフィックを許可 (デフォルト) |

### 2. ネットワークACL (Network Access Control List, NACL)

ネットワークACLは、サブネットレベルでインバウンドおよびアウトバウンドのトラフィックを制御する、オプションのセキュリティレイヤーです。  
サブネットへの出入り口に設置される仮想ファイアウォールと考えることができます。  

#### 特徴

*   **ステートレス**: トラフィックが許可された場合でも、その応答トラフィックも明示的なルールで許可する必要があります。  
    例えば、Webサーバーが外部にHTTPレスポンスを送信する場合、その送信ルールだけでなく、外部からのHTTPリクエストに対する応答を許可するインバウンドルールも必要です。  
*   **許可と拒否**: NACLは、許可するルールと拒否するルールの両方を定義できます。  
*   **適用レベル**: サブネットレベルで適用されます。  
    1つのサブネットには1つのNACLしか関連付けられません。  
    サブネット内のすべてのインスタンスに影響します。  
*   **ルール番号**: ルールには番号が付けられ、最も小さい番号から順番に評価されます。  
    ルールに一致すると、そのルールが適用され、それ以降のルールは評価されません。  
*   **デフォルトのNACL**: 新しいVPCを作成すると、デフォルトのNACLが自動的に作成され、すべてのインバウンドおよびアウトバウンドトラフィックを許可します。  
    ただし、カスタムNACLを作成した場合、デフォルトではすべてのトラフィックを拒否する暗黙的なルールが存在します。  

#### 設定例（パブリックサブネットのNACL）

| ルール番号 | タイプ  | プロトコル | ポート範囲 | ソース/宛先 | 許可/拒否 | 概要                                             |
| :--------- | :------ | :--------- | :--------- | :---------- | :-------- | :----------------------------------------------- |
| **インバウンドルール** |           |            |            |           |           |                                                  |
| 100        | HTTP    | TCP        | 80         | `0.0.0.0/0` | 許可      | インターネットからのHTTPアクセスを許可           |
| 110        | HTTPS   | TCP        | 443        | `0.0.0.0/0` | 許可      | インターネットからのHTTPSアクセスを許可          |
| 120        | SSH     | TCP        | 22         | `自分のIP/32` | 許可      | 特定のIPからSSHアクセスを許可（管理用）          |
| 130        | Custom TCP | TCP        | 1024-65535 | `0.0.0.0/0` | 許可      | エフェメラルポート範囲からの応答トラフィックを許可（ステートレスのため必要） |
| \*         | All traffic | All        | All        | `0.0.0.0/0` | 拒否      | 上記以外のすべてのインバウンドトラフィックを拒否（暗黙的） |
| **アウトバウンドルール** |           |            |            |           |           |                                                  |
| 100        | HTTP    | TCP        | 80         | `0.0.0.0/0` | 許可      | インターネットへのHTTPアクセスを許可           |
| 110        | HTTPS   | TCP        | 443        | `0.0.0.0/0` | 許可      | インターネットへのHTTPSアクセスを許可          |
| 120        | Custom TCP | TCP        | 1024-65535 | `0.0.0.0/0` | 許可      | エフェメラルポート範囲への応答トラフィックを許可（ステートレスのため必要） |
| \*         | All traffic | All        | All        | `0.0.0.0/0` | 拒否      | 上記以外のすべてのアウトバウンドトラフィックを拒否（暗黙的） |

※エフェメラルポート (Ephemeral port) とは、クライアントが外部サービスに接続する際に一時的に使用するポート番号の範囲です。  
クライアント側から見て、インバウンドの応答は高位のポート番号（通常1024-65535）を使用して返されます。  

### セキュリティグループとネットワークACLの比較

両者の違いを理解することは、適切なセキュリティ設計を行う上で非常に重要です。  

| 特徴           | セキュリティグループ (SG)                | ネットワークACL (NACL)             |
| :------------- | :--------------------------------------- | :----------------------------------- |
| **適用対象**   | EC2インスタンスなど個別のリソース        | サブネット                           |
| **適用レベル** | インスタンスレベル                       | サブネットレベル                     |
| **動作**       | ステートフル（応答トラフィックは自動許可） | ステートレス（応答トラフィックも明示的に許可が必要） |
| **ルール評価** | すべてのルールを評価し、許可ルールがあれば許可 | ルール番号の小さい順に評価し、一致した時点で適用 |
| **ルール**     | 許可ルールのみ                           | 許可ルールと拒否ルールの両方           |
| **デフォルト** | デフォルトではすべてのアウトバウンドを許可、すべてのインバウンドを拒否 | デフォルトではすべてのトラフィックを許可（カスタム作成時は暗黙的にすべて拒否） |
| **制限**       | 1インスタンスに最大5つ                   | 1サブネットに1つ                     |

### どちらを使うべきか、または両方使うべきか

*   **推奨されるベストプラクティス**: 通常はセキュリティグループを主要なファイアウォールとして使用し、ネットワークACLはオプションで追加のセキュリティレイヤーとして利用します。  
*   **多層防御**:  
    *   NACLで特定のサブネットへの広範なアクセスを制御し、不要なポートをブロックする。  
    *   セキュリティグループで個々のインスタンスやアプリケーションレベルのきめ細やかなアクセス制御を行う。  
*   **拒否ルール**: 特定のIPアドレスからのアクセスをVPCの特定部分全体で拒否したい場合など、明示的な拒否ルールが必要な場合にはNACLが有効です。  

### まとめ

セキュリティグループとネットワークACLは、VPCにおけるネットワークセキュリティの基盤となる二つの重要なツールです。  
セキュリティグループはインスタンスレベルで柔軟かつステートフルな制御を提供し、ネットワークACLはサブネットレベルで厳格かつステートレスな制御を可能にします。  
これらを適切に組み合わせることで、AWS環境のセキュリティポスチャを大幅に向上させることができます。

## NATゲートウェイ

### 概要

NATゲートウェイ（Network Address Translation Gateway）は、プライベートサブネット内のリソースがインターネットにアクセスする必要があるが、インターネットから直接アクセスされたくない場合に利用されるAWSのサービスです。  
例えば、データベースサーバーやアプリケーションサーバーが、セキュリティアップデートのダウンロードや、外部のSaaSサービスとの連携のためにインターネットへのアウトバウンド（外向き）通信を行う必要がある場合に使用します。  

### NATゲートウェイの役割

NATゲートウェイの主な役割は以下の通りです。  

1.  **プライベートサブネットからのインターネットアウトバウンド通信の有効化**: プライベートサブネット内のインスタンスは、パブリックIPアドレスを持たないため、通常は直接インターネットに接続できません。  
    NATゲートウェイを介することで、これらのインスタンスが安全にインターネット上のリソースと通信できるようになります。  
2.  **インバウンド接続の防止**: NATゲートウェイは、インターネットからプライベートサブネット内のインスタンスへの直接的なインバウンド接続をブロックします。  
    これにより、内部リソースのセキュリティが強化されます。  
3.  **スケーラビリティと高可用性**: AWSが管理するフルマネージドサービスであり、高帯域幅と高可用性を備えています。  
    インフラの運用を意識する必要がありません。  

### NATゲートウェイの仕組み

1.  **配置**: NATゲートウェイは**パブリックサブネット**に配置され、Elastic IPアドレス (EIP) を割り当てられます。  
    これにより、NATゲートウェイ自体はインターネットに接続できます。  
2.  **ルーティング**: プライベートサブネットのルートテーブルには、インターネット宛のトラフィック（`0.0.0.0/0`）のターゲットとしてNATゲートウェイを指定します。  
3.  **アドレス変換**: プライベートサブネット内のインスタンスがインターネットにアクセスしようとすると、トラフィックはNATゲートウェイにルーティングされます。  
    NATゲートウェイは、インスタンスのプライベートIPアドレスを自身のパブリックIPアドレス（EIP）に変換（NAT）し、インターネットに送信します。  
4.  **応答トラフィック**: インターネットからの応答トラフィックは、NATゲートウェイのEIP宛に届きます。  
    NATゲートウェイは、この応答トラフィックを元のプライベートサブネット内のインスタンスのプライベートIPアドレスに変換し、転送します。  

### NATゲートウェイの設定手順（概念）

NATゲートウェイを利用するためには、以下のステップが必要です。  

1.  **Elastic IPアドレス (EIP) の割り当て**: NATゲートウェイにアタッチするためのEIPを事前にプロビジョニングします。  
    NATゲートウェイは1つのEIPを必要とします。  
2.  **NATゲートウェイの作成**: AWSマネジメントコンソールやCLIからNATゲートウェイを作成し、以下の情報を指定します。  
    *   **配置するパブリックサブネット**: NATゲートウェイ自体がインターネットに接続できるよう、パブリックサブネット内に配置します。  
    *   **Elastic IPアドレス**: 事前に割り当てたEIPをアタッチします。  
3.  **プライベートサブネットのルートテーブルの更新**: プライベートサブネットに関連付けられているルートテーブルに、以下のルートを追加または変更します。  
    *   **宛先**: `0.0.0.0/0` (インターネットへのすべてのトラフィック)  
    *   **ターゲット**: 作成したNATゲートウェイのID  
    これにより、プライベートサブネットからのインターネット宛のトラフィックがNATゲートウェイを経由するようになります。  
4.  **セキュリティグループ/ネットワークACLの確認**: NATゲートウェイ自体およびプライベートサブネットのセキュリティ設定が、必要なアウトバウンド通信を許可していることを確認します。  

### NATゲートウェイの注意点

*   **料金**: NATゲートウェイは、稼働時間に応じた料金と、処理されるデータ量に応じた料金が発生します。  
    データ転送量が多い場合、コストが高くなる可能性があるため注意が必要です。  
*   **アベイラビリティーゾーン (AZ) ごとの配置**: NATゲートウェイは単一のAZに配置されます。  
    アプリケーションの可用性を高めるためには、各AZのプライベートサブネットごとに専用のNATゲートウェイを設置し、そのAZのプライベートサブネットからのトラフィックをそのAZのNATゲートウェイにルーティングする設計が推奨されます。  
    これにより、単一AZ障害時の影響を最小限に抑えることができます。  
*   **代替手段としてのNATインスタンス**: 以前はEC2インスタンスをNATサーバーとして構築する「NATインスタンス」も利用されていましたが、現在ではAWSが管理する「NATゲートウェイ」の方が、スケーラビリティ、可用性、運用負荷の面で推奨されます。  

### NATゲートウェイとインターネットゲートウェイの違い

既に解説したインターネットゲートウェイ (IGW) とは、目的が異なります。  

| 項目         | NATゲートウェイ                                                    | インターネットゲートウェイ (IGW)                                   |
| :----------- | :----------------------------------------------------------------- | :----------------------------------------------------------------- |
| **目的**     | プライベートサブネットのリソースがインターネットへアウトバウンド通信する | パブリックサブネットのリソースがインターネットと直接双方向通信する |
| **IPアドレス** | NATゲートウェイ自体にEIPをアタッチする                             | パブリックIP/EIPを持つリソースと関連付けられる                     |
| **インバウンド** | インターネットからプライベートサブネットへの直接アクセスは**不許可** | インターネットからパブリックIPを持つリソースへの直接アクセスを許可 |
| **アウトバウンド** | プライベートIPを持つリソースからインターネットへの通信を許可         | パブリックIPを持つリソースからインターネットへの通信を許可         |
| **配置場所** | パブリックサブネット内に配置される                                 | VPCにアタッチされる（特定のサブネットには配置されない）           |
| **管理**     | AWSマネージドサービス                                              | AWSマネージドサービス                                              |

